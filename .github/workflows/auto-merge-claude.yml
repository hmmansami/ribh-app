name: Preview Claude branches

on:
  push:
    branches:
      - 'claude/**'

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_RIBH_484706 }}'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy to preview channel
        id: preview
        run: |
          CHANNEL_NAME=$(echo "${{ github.ref_name }}" | sed 's/claude\///' | sed 's/[^a-zA-Z0-9]/-/g' | head -c 20)
          OUTPUT=$(firebase hosting:channel:deploy "$CHANNEL_NAME" --project ribh-484706 --expires 7d --json 2>&1)
          echo "$OUTPUT"
          PREVIEW_URL=$(echo "$OUTPUT" | grep -o '"url": *"[^"]*"' | head -1 | grep -o 'https://[^"]*')
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "channel=$CHANNEL_NAME" >> $GITHUB_OUTPUT

      - name: Post preview URL
        run: |
          echo "## ðŸ”— Preview deployed!"
          echo "**URL:** ${{ steps.preview.outputs.preview_url }}"
          echo "**Channel:** ${{ steps.preview.outputs.channel }}"
          echo "**Expires:** 7 days"
          echo ""
          echo "View on your phone, then tell Claude to promote to production:"
          echo "\"promote this design to production\""
