<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIBH Admin | Signups</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'IBM Plex Sans Arabic', 'Inter', sans-serif;
            background: #0a0a0a;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #222;
        }
        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header h1 span { color: #10B981; }
        
        .stats-row {
            display: flex;
            gap: 12px;
        }
        .stat-box {
            background: #111;
            border: 1px solid #222;
            border-radius: 12px;
            padding: 15px 25px;
            text-align: center;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #10B981;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #666;
        }
        
        /* Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            background: #111;
            border: 1px solid #222;
            border-radius: 10px;
            color: #fff;
            font-size: 0.95rem;
            font-family: inherit;
        }
        .search-box:focus {
            outline: none;
            border-color: #10B981;
        }
        .search-box::placeholder { color: #444; }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #10B981;
            color: #000;
        }
        .btn-primary:hover {
            background: #059669;
        }
        .btn-secondary {
            background: #222;
            color: #fff;
        }
        .btn-secondary:hover {
            background: #333;
        }
        
        /* Table */
        .table-wrapper {
            background: #111;
            border: 1px solid #222;
            border-radius: 16px;
            overflow: hidden;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 15px 18px;
            text-align: right;
        }
        th {
            background: #0d0d0d;
            font-weight: 600;
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        td {
            border-top: 1px solid #1a1a1a;
            font-size: 0.95rem;
        }
        tr:hover td {
            background: rgba(16,185,129,0.05);
        }
        
        .email-cell {
            color: #10B981;
            font-family: 'Inter', monospace;
        }
        .sales-cell {
            font-weight: 600;
            color: #f59e0b;
        }
        .date-cell {
            color: #666;
            font-size: 0.85rem;
        }
        .source-cell {
            background: rgba(99,102,241,0.1);
            color: #a5b4fc;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            display: inline-block;
        }
        
        /* Checkbox */
        .checkbox-cell {
            width: 50px;
            text-align: center;
        }
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #10B981;
            cursor: pointer;
        }
        
        /* Converted status */
        .converted-badge {
            background: #10B981;
            color: #000;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .not-converted {
            background: #333;
            color: #888;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .empty-state h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #888;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }
        .page-btn {
            padding: 8px 14px;
            background: #222;
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-family: inherit;
        }
        .page-btn:hover {
            background: #333;
        }
        .page-btn.active {
            background: #10B981;
            color: #000;
        }
        
        /* Export dropdown */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            min-width: 150px;
            z-index: 10;
            margin-top: 5px;
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
        .dropdown-content a {
            display: block;
            padding: 10px 15px;
            color: #fff;
            text-decoration: none;
            font-size: 0.9rem;
        }
        .dropdown-content a:hover {
            background: #222;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span>ðŸ“Š</span> RIBH Admin - Signups
            </h1>
            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-value" id="totalCount">-</div>
                    <div class="stat-label">Total Signups</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="convertedCount">-</div>
                    <div class="stat-label">Converted</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="avgSales">-</div>
                    <div class="stat-label">Avg Monthly Sales</div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <input type="text" class="search-box" id="searchBox" placeholder="ðŸ” Search by email...">
            <button class="btn btn-secondary" onclick="loadLeads()">ðŸ”„ Refresh</button>
            <div class="dropdown">
                <button class="btn btn-primary">ðŸ“¥ Export</button>
                <div class="dropdown-content">
                    <a href="#" onclick="exportCSV()">Export CSV</a>
                    <a href="#" onclick="exportJSON()">Export JSON</a>
                </div>
            </div>
        </div>
        
        <div class="table-wrapper">
            <table id="leadsTable">
                <thead>
                    <tr>
                        <th class="checkbox-cell"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                        <th>Email</th>
                        <th>Monthly Sales</th>
                        <th>Source</th>
                        <th>Date</th>
                        <th>Converted</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="6" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="pagination" id="pagination"></div>
    </div>

    <script>
        let allLeads = [];
        let filteredLeads = [];
        let currentPage = 1;
        const perPage = 25;
        
        async function loadLeads() {
            document.getElementById('tableBody').innerHTML = '<tr><td colspan="6" class="loading">Loading...</td></tr>';
            
            try {
                // Try waitlist leads first
                const res = await fetch('/api/leads/waitlist');
                const data = await res.json();
                
                if (data.success && data.leads) {
                    allLeads = data.leads.sort((a, b) => {
                        const dateA = new Date(a.createdAt || a.timestamp || 0);
                        const dateB = new Date(b.createdAt || b.timestamp || 0);
                        return dateB - dateA;
                    });
                } else {
                    allLeads = [];
                }
            } catch(e) {
                console.log('Error loading leads:', e);
                allLeads = [];
            }
            
            updateStats();
            filterLeads();
        }
        
        function updateStats() {
            document.getElementById('totalCount').textContent = allLeads.length;
            
            const converted = allLeads.filter(l => l.converted).length;
            document.getElementById('convertedCount').textContent = converted;
            
            const salesValues = allLeads.filter(l => l.monthlySales).map(l => parseInt(l.monthlySales));
            const avgSales = salesValues.length > 0 
                ? Math.round(salesValues.reduce((a,b) => a+b, 0) / salesValues.length)
                : 0;
            document.getElementById('avgSales').textContent = formatNumber(avgSales) + ' Ø±.Ø³';
        }
        
        function filterLeads() {
            const search = document.getElementById('searchBox').value.toLowerCase();
            
            filteredLeads = allLeads.filter(lead => {
                if (!search) return true;
                return (lead.email || '').toLowerCase().includes(search);
            });
            
            currentPage = 1;
            renderTable();
        }
        
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            
            if (filteredLeads.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <h3>No signups yet</h3>
                            <p>Signups will appear here when people register</p>
                        </td>
                    </tr>
                `;
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            
            const start = (currentPage - 1) * perPage;
            const end = start + perPage;
            const pageLeads = filteredLeads.slice(start, end);
            
            tbody.innerHTML = pageLeads.map(lead => {
                const date = lead.createdAt || lead.timestamp;
                const formattedDate = date ? new Date(date).toLocaleDateString('ar-SA', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '-';
                
                const sales = lead.monthlySales ? formatNumber(parseInt(lead.monthlySales)) + ' Ø±.Ø³' : '-';
                const source = lead.source || 'unknown';
                const converted = lead.converted;
                
                return `
                    <tr data-id="${lead.id || lead.email}">
                        <td class="checkbox-cell">
                            <input type="checkbox" class="row-checkbox" value="${lead.email}">
                        </td>
                        <td class="email-cell">${lead.email || '-'}</td>
                        <td class="sales-cell">${sales}</td>
                        <td><span class="source-cell">${source}</span></td>
                        <td class="date-cell">${formattedDate}</td>
                        <td>
                            <label style="cursor:pointer;">
                                <input type="checkbox" ${converted ? 'checked' : ''} 
                                    onchange="toggleConverted('${lead.email}', this.checked)">
                                <span class="converted-badge ${converted ? '' : 'not-converted'}">
                                    ${converted ? 'âœ“ Converted' : 'Pending'}
                                </span>
                            </label>
                        </td>
                    </tr>
                `;
            }).join('');
            
            renderPagination();
        }
        
        function renderPagination() {
            const totalPages = Math.ceil(filteredLeads.length / perPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }
            pagination.innerHTML = html;
        }
        
        function goToPage(page) {
            currentPage = page;
            renderTable();
        }
        
        function toggleSelectAll() {
            const checked = document.getElementById('selectAll').checked;
            document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = checked);
        }
        
        async function toggleConverted(email, converted) {
            // Update local state
            const lead = allLeads.find(l => l.email === email);
            if (lead) {
                lead.converted = converted;
            }
            
            // Update badge UI immediately
            renderTable();
            
            // Optional: Send to server
            try {
                await fetch('/api/leads/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, merchantId: 'waitlist', converted })
                });
            } catch(e) {
                console.log('Update error:', e);
            }
            
            updateStats();
        }
        
        function formatNumber(num) {
            return num.toLocaleString('en-US');
        }
        
        function exportCSV() {
            const headers = ['Email', 'Monthly Sales', 'Source', 'Date', 'Converted'];
            const rows = filteredLeads.map(lead => [
                lead.email || '',
                lead.monthlySales || '',
                lead.source || '',
                lead.createdAt || lead.timestamp || '',
                lead.converted ? 'Yes' : 'No'
            ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            downloadFile(csv, 'ribh-signups.csv', 'text/csv');
        }
        
        function exportJSON() {
            const json = JSON.stringify(filteredLeads, null, 2);
            downloadFile(json, 'ribh-signups.json', 'application/json');
        }
        
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Search debounce
        let searchTimeout;
        document.getElementById('searchBox').addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterLeads, 300);
        });
        
        // Initial load
        loadLeads();
    </script>
</body>
</html>
