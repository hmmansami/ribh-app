<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø±Ø¨Ø· Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ | Ø±ÙØ¨Ø­</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’š</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #09090B;
            --card: #18181B;
            --border: #27272A;
            --text: #FAFAFA;
            --text-muted: #71717A;
            --primary: #10B981;
            --primary-hover: #059669;
            --primary-dim: rgba(16, 185, 129, 0.12);
        }

        html {
            font-family: 'IBM Plex Sans Arabic', system-ui, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100dvh;
            overflow-x: hidden;
        }

        /* â”€â”€ Layout â”€â”€ */
        .shell {
            max-width: 480px;
            margin: 0 auto;
            padding: 0 20px;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        /* â”€â”€ Shared elements â”€â”€ */
        .btn-primary {
            width: 100%;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: background 180ms, transform 120ms;
        }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary svg { width: 20px; height: 20px; flex-shrink: 0; }

        .btn-secondary {
            width: 100%;
            padding: 14px 24px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            background: var(--card);
            color: var(--text-muted);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 180ms, border-color 180ms;
            text-decoration: none;
        }
        .btn-secondary:hover { background: var(--border); border-color: #3f3f46; }
        .btn-secondary svg { width: 18px; height: 18px; flex-shrink: 0; }

        .btn-danger {
            width: 100%;
            padding: 14px 24px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            background: rgba(239, 68, 68, 0.1);
            color: #EF4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 180ms, border-color 180ms;
        }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.18); border-color: rgba(239, 68, 68, 0.35); }
        .btn-danger svg { width: 18px; height: 18px; flex-shrink: 0; }

        .hint {
            font-size: 13px;
            color: var(--text-muted);
            text-align: center;
            margin-top: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            line-height: 1.6;
        }
        .hint svg { width: 14px; height: 14px; flex-shrink: 0; }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
        }

        /* â”€â”€ Page wrapper â”€â”€ */
        .wa-wrap {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px 0;
        }

        /* â”€â”€ Icon badge â”€â”€ */
        .wa-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: var(--primary-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 28px;
        }
        .wa-icon svg { width: 28px; height: 28px; color: var(--primary); }

        .wa-icon--success {
            background: var(--primary-dim);
        }
        .wa-icon--success svg { color: var(--primary); }

        /* â”€â”€ Typography â”€â”€ */
        .wa-headline {
            font-size: 28px;
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: 12px;
        }

        .wa-subtitle {
            font-size: 15px;
            color: var(--text-muted);
            line-height: 1.6;
            margin-bottom: 32px;
        }

        /* â”€â”€ Actions area â”€â”€ */
        .wa-actions {
            width: 100%;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* â”€â”€ Benefits list â”€â”€ */
        .wa-benefits {
            width: 100%;
            max-width: 320px;
            margin-top: 36px;
        }

        .wa-benefits-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .wa-benefit {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
        }

        .wa-benefit + .wa-benefit {
            border-top: 1px solid var(--border);
        }

        .wa-benefit-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--primary-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .wa-benefit-icon svg { width: 18px; height: 18px; color: var(--primary); }

        .wa-benefit-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            text-align: right;
        }

        /* â”€â”€ Spinner â”€â”€ */
        .wa-spinner {
            width: 44px;
            height: 44px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 24px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* â”€â”€ QR Code container â”€â”€ */
        .wa-qr-instruction {
            font-size: 14px;
            color: var(--text-muted);
            line-height: 1.7;
            margin-bottom: 24px;
        }

        .wa-qr-box {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 20px;
            margin: 0 auto 20px;
            max-width: 280px;
            width: 100%;
        }

        .wa-qr-box img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
        }

        .wa-timer {
            font-size: 13px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .wa-timer svg { width: 14px; height: 14px; flex-shrink: 0; }

        /* â”€â”€ Connected info â”€â”€ */
        .wa-connected-info {
            width: 100%;
            max-width: 320px;
            padding: 20px;
            margin-bottom: 28px;
        }

        .wa-phone {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
            direction: ltr;
            margin-bottom: 4px;
        }

        .wa-name {
            font-size: 14px;
            color: var(--text-muted);
        }

        /* â”€â”€ State visibility â”€â”€ */
        .wa-state { display: none; }
        .wa-state.is-active {
            display: flex;
            flex: 1;
            flex-direction: column;
            animation: fadeIn 300ms ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* â”€â”€ Back link area â”€â”€ */
        .wa-back {
            padding-bottom: 24px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="shell">

        <!-- â•â•â•â•â•â•â• STATE: Initial (not connected) â•â•â•â•â•â•â• -->
        <div id="initialState" class="wa-state is-active">
            <div class="wa-wrap">
                <div class="wa-icon">
                    <i data-lucide="smartphone"></i>
                </div>
                <h1 class="wa-headline">Ø±Ø¨Ø· Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</h1>
                <p class="wa-subtitle">Ø§Ø±Ø³Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø³Ù„Ø§Øª Ù…Ø¬Ø§Ù†Ø§ Ù…Ù† Ø±Ù‚Ù…Ùƒ</p>

                <div class="wa-actions">
                    <button class="btn-primary" id="connectBtn" onclick="connectWhatsApp()">
                        <i data-lucide="message-circle"></i>
                        <span>Ø±Ø¨Ø· Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</span>
                    </button>
                    <div class="hint">
                        <i data-lucide="lock"></i>
                        <span>Ø§ØªØµØ§Ù„ Ù…Ø´ÙØ± ÙˆØ¢Ù…Ù†</span>
                    </div>
                </div>

                <div class="wa-benefits">
                    <div class="wa-benefits-title">Ù…Ù…ÙŠØ²Ø§Øª Ø±Ø¨Ø· Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</div>
                    <div class="card">
                        <div class="wa-benefit">
                            <div class="wa-benefit-icon">
                                <i data-lucide="wallet"></i>
                            </div>
                            <span class="wa-benefit-text">Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¬Ø§Ù†ÙŠØ© Ø¨Ø¯ÙˆÙ† Ø­Ø¯ÙˆØ¯</span>
                        </div>
                        <div class="wa-benefit">
                            <div class="wa-benefit-icon">
                                <i data-lucide="trending-up"></i>
                            </div>
                            <span class="wa-benefit-text">Ù…Ø¹Ø¯Ù„ ÙØªØ­ 98% - Ø§Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„</span>
                        </div>
                        <div class="wa-benefit">
                            <div class="wa-benefit-icon">
                                <i data-lucide="shield-check"></i>
                            </div>
                            <span class="wa-benefit-text">Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø±Ù‚Ù…Ùƒ = Ø«Ù‚Ø© Ø§Ø¹Ù„Ù‰</span>
                        </div>
                        <div class="wa-benefit">
                            <div class="wa-benefit-icon">
                                <i data-lucide="zap"></i>
                            </div>
                            <span class="wa-benefit-text">ØªÙØ¹ÙŠÙ„ ÙÙˆØ±ÙŠ - Ù…Ø³Ø­ QR ÙÙ‚Ø·</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="wa-back">
                <a href="/app" class="btn-secondary">
                    <i data-lucide="arrow-right"></i>
                    <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                </a>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â• STATE: Loading â•â•â•â•â•â•â• -->
        <div id="loadingState" class="wa-state">
            <div class="wa-wrap">
                <div class="wa-spinner"></div>
                <h2 class="wa-headline">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</h2>
                <p class="wa-subtitle">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â• STATE: QR Code â•â•â•â•â•â•â• -->
        <div id="qrState" class="wa-state">
            <div class="wa-wrap">
                <div class="wa-icon">
                    <i data-lucide="scan-line"></i>
                </div>
                <h2 class="wa-headline">Ø§Ù…Ø³Ø­ Ø±Ù…Ø² QR</h2>
                <p class="wa-qr-instruction">Ø§ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ â† Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯Ø§Øª â† Ø§Ù„Ø§Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©</p>

                <div class="wa-qr-box" id="qrContainer">
                    <img id="qrImage" src="" alt="QR Code">
                </div>

                <div class="wa-timer" id="qrTimer">
                    <i data-lucide="clock"></i>
                    <span>ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ <strong id="countdown">60</strong> Ø«Ø§Ù†ÙŠØ©</span>
                </div>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â• STATE: Connected â•â•â•â•â•â•â• -->
        <div id="connectedState" class="wa-state">
            <div class="wa-wrap">
                <div class="wa-icon wa-icon--success">
                    <i data-lucide="check-circle-2"></i>
                </div>
                <h2 class="wa-headline">Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­!</h2>

                <div class="card wa-connected-info">
                    <div class="wa-phone" id="connectedPhone">+966xxxxxxxx</div>
                    <div class="wa-name" id="connectedName">Ø§Ø³Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</div>
                </div>

                <div class="wa-actions">
                    <a href="/app" class="btn-primary">
                        <i data-lucide="arrow-right"></i>
                        <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                    </a>
                    <button class="btn-danger" id="disconnectBtn" onclick="disconnectWhatsApp()">
                        <i data-lucide="unplug"></i>
                        <span>Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„</span>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Get merchant ID from URL or localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const merchantId = urlParams.get('merchant') || localStorage.getItem('ribhMerchant') || 'demo';

        let statusCheckInterval = null;
        let countdownInterval = null;

        // Check initial status on load
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            checkStatus();
        });

        async function checkStatus() {
            try {
                const response = await fetch(`/api/whatsapp/status?merchant=${merchantId}`);
                const data = await response.json();

                if (data.connected) {
                    showConnected(data.info);
                } else if (data.qrCode) {
                    showQR(data.qrCode);
                }
            } catch (error) {
                console.error('Status check error:', error);
            }
        }

        async function connectWhatsApp() {
            const btn = document.getElementById('connectBtn');
            btn.disabled = true;

            showLoading();

            try {
                const response = await fetch(`/api/whatsapp/connect?merchant=${merchantId}`);
                const data = await response.json();

                if (data.ready) {
                    showConnected(data);
                } else if (data.qrCode) {
                    showQR(data.qrCode);
                    startStatusPolling();
                } else {
                    alert('Ø®Ø·Ø£: ' + (data.error || 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„'));
                    showInitial();
                }
            } catch (error) {
                console.error('Connect error:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
                showInitial();
            }

            btn.disabled = false;
        }

        async function disconnectWhatsApp() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ØŸ')) return;

            try {
                const response = await fetch('/api/whatsapp/disconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ merchant: merchantId })
                });

                const data = await response.json();
                if (data.success) {
                    showInitial();
                    stopPolling();
                }
            } catch (error) {
                console.error('Disconnect error:', error);
            }
        }

        function showInitial() {
            document.getElementById('initialState').classList.add('is-active');
            document.getElementById('loadingState').classList.remove('is-active');
            document.getElementById('qrState').classList.remove('is-active');
            document.getElementById('connectedState').classList.remove('is-active');
        }

        function showLoading() {
            document.getElementById('initialState').classList.remove('is-active');
            document.getElementById('loadingState').classList.add('is-active');
            document.getElementById('qrState').classList.remove('is-active');
            document.getElementById('connectedState').classList.remove('is-active');
        }

        function showQR(qrDataUrl) {
            document.getElementById('initialState').classList.remove('is-active');
            document.getElementById('loadingState').classList.remove('is-active');
            document.getElementById('qrState').classList.add('is-active');
            document.getElementById('connectedState').classList.remove('is-active');

            document.getElementById('qrImage').src = qrDataUrl;

            // Re-render Lucide icons for newly visible state
            lucide.createIcons();

            // Start countdown
            let seconds = 60;
            const countdownEl = document.getElementById('countdown');
            clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                seconds--;
                countdownEl.textContent = seconds;
                if (seconds <= 0) {
                    clearInterval(countdownInterval);
                    // QR expired, try to get new one
                    connectWhatsApp();
                }
            }, 1000);
        }

        function showConnected(info) {
            stopPolling();

            document.getElementById('initialState').classList.remove('is-active');
            document.getElementById('loadingState').classList.remove('is-active');
            document.getElementById('qrState').classList.remove('is-active');
            document.getElementById('connectedState').classList.add('is-active');

            if (info) {
                document.getElementById('connectedPhone').textContent = '+' + (info.phone || 'Unknown');
                document.getElementById('connectedName').textContent = info.name || 'WhatsApp';
            }

            // Re-render Lucide icons for newly visible state
            lucide.createIcons();
        }

        function startStatusPolling() {
            // Poll every 3 seconds to check if QR was scanned
            statusCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/whatsapp/status?merchant=${merchantId}`);
                    const data = await response.json();

                    if (data.connected) {
                        showConnected(data.info);
                    } else if (data.qrCode) {
                        // Update QR if new one available
                        document.getElementById('qrImage').src = data.qrCode;
                    }
                } catch (error) {
                    console.error('Status poll error:', error);
                }
            }, 3000);
        }

        function stopPolling() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }
    </script>
    <script src="/js/transitions.js"></script>
</body>
</html>
