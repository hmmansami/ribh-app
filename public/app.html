<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RIBH - One Click Money</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #09090B;
            --card: #18181B;
            --border: #27272A;
            --text: #FAFAFA;
            --text-muted: #71717A;
            --primary: #10B981;
            --primary-hover: #059669;
            --danger: #EF4444;
            --warning: #F59E0B;
        }
        html { font-family: 'IBM Plex Sans Arabic', system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; }

        /* === STATES === */
        .state { display: none; min-height: 100vh; padding: 24px; }
        .state.active { display: flex; flex-direction: column; align-items: center; justify-content: center; }

        /* === STATE: LOCKED === */
        #locked { position: relative; }
        .locked-bg {
            position: absolute; inset: 0;
            background: linear-gradient(180deg, rgba(9,9,11,0) 0%, rgba(9,9,11,0.95) 100%);
            pointer-events: none; z-index: 1;
        }
        .locked-preview {
            position: absolute; inset: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            filter: blur(4px) brightness(0.3); transform: scale(0.95);
        }
        .locked-preview-money { font-size: 72px; font-weight: 700; color: var(--primary); opacity: 0.3; }
        .locked-content { position: relative; z-index: 2; text-align: center; max-width: 400px; }
        .locked-icon { width: 80px; height: 80px; margin: 0 auto 24px; background: var(--card); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid var(--border); }
        .locked-icon svg { width: 40px; height: 40px; color: var(--primary); }
        .locked-title { font-size: 28px; font-weight: 700; margin-bottom: 12px; }
        .locked-desc { color: var(--text-muted); margin-bottom: 32px; line-height: 1.7; }
        .locked-sources { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 24px; }
        .source-btn { padding: 12px 20px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: var(--text); }
        .source-btn:hover { border-color: var(--primary); background: rgba(16,185,129,0.1); }
        .source-btn.primary { background: var(--primary); border-color: var(--primary); }
        .source-btn.primary:hover { background: var(--primary-hover); }
        .source-logo { font-size: 18px; font-weight: 700; }
        .or-divider { color: var(--text-muted); font-size: 13px; margin: 16px 0; }

        /* === STATE: ANALYZING === */
        #analyzing { text-align: center; }
        .analyzing-spinner { width: 60px; height: 60px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 24px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .analyzing-text { font-size: 18px; color: var(--text-muted); }

        /* === STATE: READY === */
        #ready { text-align: center; padding: 40px 24px; }
        .ready-money { margin-bottom: 8px; }
        .ready-money-value { font-size: 72px; font-weight: 700; color: var(--primary); line-height: 1; }
        .ready-money-currency { font-size: 24px; color: var(--text-muted); margin-right: 8px; }
        .ready-subtitle { color: var(--text-muted); font-size: 18px; margin-bottom: 40px; }
        .ready-breakdown { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; margin-bottom: 48px; }
        .breakdown-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px 24px; min-width: 160px; text-align: center; }
        .breakdown-icon { font-size: 28px; margin-bottom: 8px; }
        .breakdown-value { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .breakdown-label { font-size: 13px; color: var(--text-muted); }
        .breakdown-sar { font-size: 14px; color: var(--primary); margin-top: 4px; }
        .launch-btn { padding: 24px 64px; font-size: 22px; font-weight: 700; background: linear-gradient(135deg, var(--primary), var(--primary-hover)); color: white; border: none; border-radius: 16px; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 12px; box-shadow: 0 8px 32px rgba(16,185,129,0.3); }
        .launch-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(16,185,129,0.4); }
        .launch-btn:active { transform: translateY(0); }
        .launch-btn svg { width: 28px; height: 28px; }
        .launch-btn.pulsing { animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 8px 32px rgba(16,185,129,0.3); } 50% { box-shadow: 0 8px 48px rgba(16,185,129,0.5); } }

        /* === STATE: RUNNING === */
        #running { text-align: center; padding: 40px 24px; }
        .running-header { margin-bottom: 32px; }
        .running-status { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: rgba(16,185,129,0.15); border-radius: 20px; color: var(--primary); font-size: 14px; font-weight: 600; margin-bottom: 16px; }
        .running-status-dot { width: 8px; height: 8px; background: var(--primary); border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .running-money { font-size: 48px; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
        .running-subtitle { color: var(--text-muted); }
        .running-progress { max-width: 400px; margin: 0 auto 32px; }
        .progress-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin-bottom: 8px; }
        .progress-fill { height: 100%; background: var(--primary); border-radius: 4px; transition: width 0.3s; }
        .progress-text { font-size: 13px; color: var(--text-muted); }
        .running-feed { max-width: 500px; margin: 0 auto; text-align: right; }
        .feed-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 8px; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .feed-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .feed-dot.sent { background: #3B82F6; }
        .feed-dot.read { background: var(--warning); }
        .feed-dot.clicked { background: #8B5CF6; }
        .feed-dot.purchased { background: var(--primary); }
        .feed-content { flex: 1; min-width: 0; }
        .feed-msg { font-size: 14px; font-weight: 500; }
        .feed-time { font-size: 12px; color: var(--text-muted); }
        .feed-amount { font-size: 14px; font-weight: 600; color: var(--primary); white-space: nowrap; }

        /* === STATE: COMPLETE === */
        #complete { text-align: center; padding: 40px 24px; }
        .complete-icon { width: 80px; height: 80px; margin: 0 auto 24px; background: rgba(16,185,129,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .complete-icon svg { width: 40px; height: 40px; color: var(--primary); }
        .complete-title { font-size: 28px; font-weight: 700; margin-bottom: 12px; }
        .complete-money { font-size: 48px; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
        .complete-desc { color: var(--text-muted); margin-bottom: 32px; }
        .complete-stats { display: flex; gap: 24px; justify-content: center; margin-bottom: 32px; }
        .complete-stat { text-align: center; }
        .complete-stat-val { font-size: 24px; font-weight: 700; }
        .complete-stat-label { font-size: 13px; color: var(--text-muted); }
        .btn-secondary { padding: 14px 28px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-secondary:hover { border-color: var(--primary); }

        /* === OWNER PHONE CAPTURE === */
        .owner-phone { margin-top: 24px; padding: 20px; background: var(--card); border: 1px solid var(--border); border-radius: 16px; max-width: 400px; }
        .owner-phone-title { font-size: 14px; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .owner-phone-title svg { width: 18px; height: 18px; color: var(--primary); }
        .owner-phone-desc { font-size: 13px; color: var(--text-muted); margin-bottom: 12px; }
        .owner-phone-input { display: flex; gap: 8px; }
        .owner-phone-input input { flex: 1; padding: 12px 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; font-family: inherit; direction: ltr; text-align: left; }
        .owner-phone-input input:focus { outline: none; border-color: var(--primary); }
        .owner-phone-input button { padding: 12px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }

        /* === CONFETTI === */
        #confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9998; }

        /* === RESPONSIVE === */
        @media (max-width: 640px) {
            .ready-money-value { font-size: 48px; }
            .ready-breakdown { flex-direction: column; align-items: center; }
            .breakdown-card { width: 100%; max-width: 280px; }
            .launch-btn { padding: 20px 48px; font-size: 18px; }
            .running-money { font-size: 36px; }
        }
    </style>
</head>
<body>
    <canvas id="confetti"></canvas>

    <!-- STATE: LOCKED (no store connected) -->
    <div id="locked" class="state active">
        <div class="locked-preview">
            <div class="locked-preview-money">154,000 Ø±.Ø³</div>
        </div>
        <div class="locked-bg"></div>
        <div class="locked-content">
            <div class="locked-icon"><i data-lucide="lock-open"></i></div>
            <h1 class="locked-title">Ø§Ø±Ø¨Ø· Ù…ØªØ¬Ø±Ùƒ</h1>
            <p class="locked-desc">Ø§Ø±Ø¨Ø· Ø¨ÙŠØ§Ù†Ø§ØªÙƒØŒ ÙˆØ§Ø¶ØºØ· Ø²Ø± ÙˆØ§Ø­Ø¯ØŒ ÙˆØ´Ø§Ù‡Ø¯ Ø§Ù„Ø£Ù…ÙˆØ§Ù„ ØªØªØ¯ÙÙ‚</p>
            <div class="locked-sources">
                <button class="source-btn primary" onclick="connectSalla()">
                    <span class="source-logo" style="color:#6C63FF">Ø³Ù„Ø©</span>
                    <span>Salla</span>
                </button>
                <button class="source-btn" onclick="connectSource('zid')">
                    <span class="source-logo" style="color:#5B5FC7">Ø²Ø¯</span>
                </button>
                <button class="source-btn" onclick="connectSource('shopify')">
                    <span class="source-logo" style="color:#96BF48">S</span>
                </button>
            </div>
            <div class="or-divider">Ø£Ùˆ</div>
            <div class="locked-sources">
                <button class="source-btn" onclick="connectSource('foodics')">
                    <span class="source-logo" style="color:#FF6B35">F</span>
                    <span>Foodics</span>
                </button>
                <button class="source-btn" onclick="showCSVUpload()">
                    <i data-lucide="upload" style="width:18px;height:18px"></i>
                    <span>CSV</span>
                </button>
            </div>
        </div>
    </div>

    <!-- STATE: ANALYZING -->
    <div id="analyzing" class="state">
        <div class="analyzing-spinner"></div>
        <div class="analyzing-text">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ù…ØªØ¬Ø±Ùƒ...</div>
    </div>

    <!-- STATE: READY (analyzed, waiting to launch) -->
    <div id="ready" class="state">
        <div class="ready-money">
            <span class="ready-money-value" id="moneyWaiting">0</span>
            <span class="ready-money-currency">Ø±.Ø³</span>
        </div>
        <div class="ready-subtitle">ØªÙ†ØªØ¸Ø±Ùƒ ÙÙŠ Ù…ØªØ¬Ø±Ùƒ</div>
        <div class="ready-breakdown">
            <div class="breakdown-card" id="cartCard">
                <div class="breakdown-icon">ğŸ›’</div>
                <div class="breakdown-value" id="cartCount">0</div>
                <div class="breakdown-label">Ø³Ù„Ø© Ù…ØªØ±ÙˆÙƒØ©</div>
                <div class="breakdown-sar" id="cartValue">0 Ø±.Ø³</div>
            </div>
            <div class="breakdown-card" id="dormantCard">
                <div class="breakdown-icon">ğŸ˜´</div>
                <div class="breakdown-value" id="dormantCount">0</div>
                <div class="breakdown-label">Ø¹Ù…ÙŠÙ„ Ø®Ø§Ù…Ù„</div>
                <div class="breakdown-sar" id="dormantValue">0 Ø±.Ø³</div>
            </div>
            <div class="breakdown-card" id="upsellCard">
                <div class="breakdown-icon">ğŸ›ï¸</div>
                <div class="breakdown-value" id="upsellCount">0</div>
                <div class="breakdown-label">ÙØ±ØµØ© Ø¨ÙŠØ¹ Ø¥Ø¶Ø§ÙÙŠ</div>
                <div class="breakdown-sar" id="upsellValue">0 Ø±.Ø³</div>
            </div>
        </div>
        <button class="launch-btn pulsing" onclick="launchCampaigns()">
            <i data-lucide="rocket"></i>
            <span>Ø§Ø³ØªØ±Ø¬Ø¹ Ø£Ù…ÙˆØ§Ù„Ùƒ</span>
        </button>
        <div class="owner-phone" id="ownerPhoneSection">
            <div class="owner-phone-title"><i data-lucide="bell"></i> Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ØªÙ†Ø¨ÙŠÙ‡ ÙÙˆØ±ÙŠ</div>
            <div class="owner-phone-desc">Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø¥Ø¨Ù„Ø§ØºÙƒ Ø¹Ù†Ø¯ ÙƒÙ„ Ø§Ø³ØªØ±Ø¯Ø§Ø¯</div>
            <div class="owner-phone-input">
                <input type="tel" id="ownerPhone" placeholder="05xxxxxxxx" dir="ltr">
                <button onclick="saveOwnerPhone()">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>

    <!-- STATE: RUNNING (campaigns launching) -->
    <div id="running" class="state">
        <div class="running-header">
            <div class="running-status"><span class="running-status-dot"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</div>
            <div class="running-money">+<span id="runningRevenue">0</span> Ø±.Ø³</div>
            <div class="running-subtitle">Ù…ØªÙˆÙ‚Ø¹ Ø§Ø³ØªØ±Ø¯Ø§Ø¯Ù‡</div>
        </div>
        <div class="running-progress">
            <div class="progress-bar"><div class="progress-fill" id="progressBar" style="width:0%"></div></div>
            <div class="progress-text"><span id="sentCount">0</span> Ø±Ø³Ø§Ù„Ø© Ù…Ù† <span id="totalCount">0</span></div>
        </div>
        <div class="running-feed" id="runningFeed"></div>
    </div>

    <!-- STATE: COMPLETE -->
    <div id="complete" class="state">
        <div class="complete-icon"><i data-lucide="check-circle"></i></div>
        <h1 class="complete-title">ØªÙ… Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø­Ù…Ù„Ø©!</h1>
        <div class="complete-money" id="completeRevenue">0 Ø±.Ø³</div>
        <div class="complete-desc">Ù…ØªÙˆÙ‚Ø¹ Ø§Ø³ØªØ±Ø¯Ø§Ø¯Ù‡ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©</div>
        <div class="complete-stats">
            <div class="complete-stat">
                <div class="complete-stat-val" id="completeSent">0</div>
                <div class="complete-stat-label">Ø±Ø³Ø§Ù„Ø© Ù…Ø±Ø³Ù„Ø©</div>
            </div>
            <div class="complete-stat">
                <div class="complete-stat-val" id="completeAudience">0</div>
                <div class="complete-stat-label">Ø¹Ù…ÙŠÙ„</div>
            </div>
        </div>
        <button class="btn-secondary" onclick="location.reload()">Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>

    <script>
    // === STATE MANAGEMENT ===
    let currentState = 'locked';
    let analysisData = null;

    function setState(state) {
        document.querySelectorAll('.state').forEach(s => s.classList.remove('active'));
        document.getElementById(state).classList.add('active');
        currentState = state;
    }

    // === CONNECT SOURCES ===
    function connectSalla() {
        window.location.href = '/salla/install';
    }

    function connectSource(source) {
        if (source === 'zid' || source === 'shopify' || source === 'foodics') {
            alert('Ù‚Ø±ÙŠØ¨Ø§Ù‹! Ø­Ø§Ù„ÙŠØ§Ù‹ Ù†Ø¹Ù…Ù„ Ù…Ø¹ Ø³Ù„Ø© ÙÙ‚Ø·');
            return;
        }
    }

    function showCSVUpload() {
        alert('Ø§Ø±ÙØ¹ Ù…Ù„Ù CSV Ù…Ø¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: phone, name, type, value\nÙ‚Ø±ÙŠØ¨Ø§Ù‹!');
    }

    // === CHECK IF CONNECTED ===
    async function checkConnection() {
        try {
            const res = await fetch('/api/ribh/analyze');
            const data = await res.json();

            if (data.success) {
                analysisData = data;
                showReadyState(data);
            } else if (data.error === 'no_merchant') {
                setState('locked');
            } else {
                console.error('Analysis error:', data);
                setState('locked');
            }
        } catch (e) {
            console.error('Connection check failed:', e);
            setState('locked');
        }
    }

    // === SHOW READY STATE ===
    function showReadyState(data) {
        setState('ready');

        const { analysis, campaigns } = data;
        const { breakdown } = analysis;

        // Animate money counter
        animateValue(document.getElementById('moneyWaiting'), analysis.moneyWaiting);

        // Breakdown cards
        document.getElementById('cartCount').textContent = breakdown.abandonedCarts.count.toLocaleString();
        document.getElementById('cartValue').textContent = breakdown.abandonedCarts.recoveryEstimate.toLocaleString() + ' Ø±.Ø³';

        document.getElementById('dormantCount').textContent = breakdown.dormantCustomers.count.toLocaleString();
        document.getElementById('dormantValue').textContent = breakdown.dormantCustomers.reactivationEstimate.toLocaleString() + ' Ø±.Ø³';

        document.getElementById('upsellCount').textContent = breakdown.recentBuyers.count.toLocaleString();
        document.getElementById('upsellValue').textContent = breakdown.recentBuyers.upsellEstimate.toLocaleString() + ' Ø±.Ø³';

        // Hide empty cards
        if (breakdown.abandonedCarts.count === 0) document.getElementById('cartCard').style.display = 'none';
        if (breakdown.dormantCustomers.count === 0) document.getElementById('dormantCard').style.display = 'none';
        if (breakdown.recentBuyers.count === 0) document.getElementById('upsellCard').style.display = 'none';
    }

    // === LAUNCH CAMPAIGNS ===
    async function launchCampaigns() {
        setState('running');
        launchConfetti();

        const totalCustomers = analysisData.analysis.totalCustomers;
        document.getElementById('totalCount').textContent = totalCustomers;

        try {
            const res = await fetch('/api/ribh/launch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ campaigns: ['cartRecovery', 'winback', 'upsell'] })
            });

            const data = await res.json();

            if (data.success) {
                showCompleteState(data.results);
            } else {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (data.error || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                setState('ready');
            }
        } catch (e) {
            console.error('Launch error:', e);
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            setState('ready');
        }
    }

    // === SIMULATE PROGRESS (while launching) ===
    function simulateProgress() {
        let sent = 0;
        const total = parseInt(document.getElementById('totalCount').textContent) || 100;
        const interval = setInterval(() => {
            sent += Math.floor(Math.random() * 3) + 1;
            if (sent > total) sent = total;

            document.getElementById('sentCount').textContent = sent;
            document.getElementById('progressBar').style.width = (sent / total * 100) + '%';

            // Add feed item
            addFeedItem(sent);

            if (sent >= total) clearInterval(interval);
        }, 1000);
    }

    function addFeedItem(count) {
        const feed = document.getElementById('runningFeed');
        const types = [
            { type: 'sent', msg: 'Ø±Ø³Ø§Ù„Ø© Ù…Ø±Ø³Ù„Ø©', dot: 'sent' },
            { type: 'read', msg: 'Ø±Ø³Ø§Ù„Ø© Ù…Ù‚Ø±ÙˆØ¡Ø©', dot: 'read' },
            { type: 'clicked', msg: 'Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø·', dot: 'clicked' }
        ];
        const t = types[Math.floor(Math.random() * types.length)];
        const item = document.createElement('div');
        item.className = 'feed-item';
        item.innerHTML = `<span class="feed-dot ${t.dot}"></span><div class="feed-content"><div class="feed-msg">${t.msg}</div><div class="feed-time">Ø§Ù„Ø¢Ù†</div></div>`;
        feed.insertBefore(item, feed.firstChild);
        if (feed.children.length > 5) feed.removeChild(feed.lastChild);
    }

    // === SHOW COMPLETE STATE ===
    function showCompleteState(results) {
        setState('complete');
        launchConfetti();

        const totalSent = results.messagesSent || 0;
        const totalRevenue = results.launched.reduce((s, l) => s + (l.estimatedRevenue || 0), 0);
        const totalAudience = results.launched.reduce((s, l) => s + (l.audience || 0), 0);

        document.getElementById('completeSent').textContent = totalSent.toLocaleString();
        document.getElementById('completeRevenue').textContent = totalRevenue.toLocaleString() + ' Ø±.Ø³';
        document.getElementById('completeAudience').textContent = totalAudience.toLocaleString();
    }

    // === SAVE OWNER PHONE ===
    async function saveOwnerPhone() {
        const phone = document.getElementById('ownerPhone').value.trim();
        if (!phone) return;

        try {
            // Save to backend (would need endpoint)
            alert('ØªÙ… Ø­ÙØ¸ Ø±Ù‚Ù…Ùƒ! Ø³ØªØµÙ„Ùƒ Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ ÙƒÙ„ Ø§Ø³ØªØ±Ø¯Ø§Ø¯');
            document.getElementById('ownerPhoneSection').style.display = 'none';
        } catch (e) {
            console.error('Save phone error:', e);
        }
    }

    // === ANIMATE VALUE ===
    function animateValue(el, end, duration = 1500) {
        let start = 0;
        const startTime = performance.now();
        function update(now) {
            const p = Math.min((now - startTime) / duration, 1);
            const eased = 1 - Math.pow(1 - p, 3);
            el.textContent = Math.floor(start + (end - start) * eased).toLocaleString();
            if (p < 1) requestAnimationFrame(update);
        }
        requestAnimationFrame(update);
    }

    // === CONFETTI ===
    function launchConfetti() {
        const cv = document.getElementById('confetti'), ctx = cv.getContext('2d');
        cv.width = window.innerWidth; cv.height = window.innerHeight;
        const ps = [], colors = ['#10B981', '#22C55E', '#6366F1', '#F59E0B', '#3B82F6', '#EF4444', '#FAFAFA'];
        for (let i = 0; i < 120; i++) ps.push({ x: cv.width / 2 + (Math.random() - 0.5) * 200, y: cv.height / 2, vx: (Math.random() - 0.5) * 12, vy: Math.random() * -16 - 4, w: Math.random() * 8 + 4, h: Math.random() * 6 + 2, c: colors[Math.floor(Math.random() * colors.length)], r: Math.random() * 360, rv: (Math.random() - 0.5) * 12, g: 0.3, o: 1 });
        let f = 0;
        function draw() {
            ctx.clearRect(0, 0, cv.width, cv.height); let alive = false;
            ps.forEach(p => { p.x += p.vx; p.vy += p.g; p.y += p.vy; p.r += p.rv; if (f > 40) p.o -= 0.015; if (p.o <= 0) return; alive = true; ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.r * Math.PI / 180); ctx.globalAlpha = p.o; ctx.fillStyle = p.c; ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h); ctx.restore(); });
            f++; if (alive) requestAnimationFrame(draw); else ctx.clearRect(0, 0, cv.width, cv.height);
        }
        requestAnimationFrame(draw);
    }

    // === INIT ===
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();

        // Check URL params for Salla callback
        const params = new URLSearchParams(window.location.search);
        if (params.has('connected') || params.has('merchant')) {
            setState('analyzing');
            setTimeout(() => checkConnection(), 1500);
        } else {
            checkConnection();
        }
    });
    </script>
</body>
</html>
