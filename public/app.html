<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RIBH - One Click Money</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #09090B;
            --card: #18181B;
            --border: #27272A;
            --text: #FAFAFA;
            --text-muted: #71717A;
            --primary: #10B981;
            --primary-hover: #059669;
        }
        html { font-family: 'IBM Plex Sans Arabic', system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }

        /* === LOCKED STATE === */
        .locked-wrapper { position: relative; min-height: 100vh; }

        /* Dark overlay with hole for Salla button */
        .locked-overlay {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(9,9,11,0.85);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 24px;
        }
        .locked-overlay.hidden { display: none; }

        .locked-content { text-align: center; max-width: 400px; }
        .locked-icon { width: 80px; height: 80px; margin: 0 auto 24px; background: var(--card); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid var(--border); }
        .locked-icon svg { width: 40px; height: 40px; color: var(--primary); }
        .locked-title { font-size: 28px; font-weight: 700; margin-bottom: 12px; }
        .locked-desc { color: var(--text-muted); margin-bottom: 32px; line-height: 1.7; }

        /* ONLY Salla button - glowing */
        .salla-btn {
            padding: 18px 48px; font-size: 18px; font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--primary-hover));
            color: white; border: none; border-radius: 14px;
            cursor: pointer; display: inline-flex; align-items: center; gap: 12px;
            box-shadow: 0 0 30px rgba(16,185,129,0.4);
            animation: glowPulse 2s ease-in-out infinite;
            transition: transform 0.2s;
        }
        .salla-btn:hover { transform: scale(1.05); }
        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 30px rgba(16,185,129,0.4); }
            50% { box-shadow: 0 0 50px rgba(16,185,129,0.6); }
        }
        .salla-logo { font-size: 20px; font-weight: 700; }

        /* === DASHBOARD PREVIEW (behind overlay, scrollable) === */
        .dashboard-preview { padding: 24px; opacity: 0.3; filter: blur(1px); }

        .preview-hero { text-align: center; padding: 60px 24px; margin-bottom: 24px; }
        .preview-money { font-size: 64px; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
        .preview-subtitle { color: var(--text-muted); font-size: 18px; margin-bottom: 32px; }
        .preview-btn { padding: 20px 48px; font-size: 18px; background: var(--card); border: 1px solid var(--border); border-radius: 14px; color: var(--text-muted); display: inline-flex; align-items: center; gap: 10px; }

        .preview-cards { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; margin-bottom: 32px; }
        .preview-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px 28px; text-align: center; min-width: 140px; }
        .preview-card-icon { font-size: 28px; margin-bottom: 8px; }
        .preview-card-val { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .preview-card-label { font-size: 12px; color: var(--text-muted); }

        .preview-activity { max-width: 500px; margin: 0 auto; }
        .preview-activity-title { font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-muted); }
        .preview-activity-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 8px; }
        .preview-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--primary); }
        .preview-dot.blue { background: #3B82F6; }
        .preview-dot.orange { background: #F59E0B; }

        /* === READY STATE (after Salla connected) === */
        .app-container { display: none; min-height: 100vh; padding: 24px; }
        .app-container.active { display: block; }

        .hero { text-align: center; padding: 60px 24px; }
        .hero-money { font-size: 72px; font-weight: 700; color: var(--primary); line-height: 1; margin-bottom: 8px; }
        .hero-currency { font-size: 24px; color: var(--text-muted); margin-right: 8px; }
        .hero-subtitle { color: var(--text-muted); font-size: 18px; margin-bottom: 40px; }

        .breakdown { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; margin-bottom: 48px; }
        .breakdown-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px 24px; min-width: 160px; text-align: center; transition: all 0.2s; }
        .breakdown-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .breakdown-icon { font-size: 28px; margin-bottom: 8px; }
        .breakdown-value { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .breakdown-label { font-size: 13px; color: var(--text-muted); }
        .breakdown-sar { font-size: 14px; color: var(--primary); margin-top: 4px; }

        .launch-section { text-align: center; margin-bottom: 40px; }
        .launch-btn {
            padding: 24px 64px; font-size: 22px; font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--primary-hover));
            color: white; border: none; border-radius: 16px;
            cursor: pointer; display: inline-flex; align-items: center; gap: 12px;
            box-shadow: 0 8px 32px rgba(16,185,129,0.3);
            animation: glowPulse 2s ease-in-out infinite;
            transition: transform 0.2s;
        }
        .launch-btn:hover { transform: translateY(-2px); }
        .launch-btn:disabled { opacity: 0.5; cursor: not-allowed; animation: none; }
        .launch-btn svg { width: 28px; height: 28px; }

        /* Activity Feed */
        .activity { max-width: 500px; margin: 0 auto; }
        .activity-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .activity-title { font-size: 14px; font-weight: 600; }
        .activity-badge { padding: 4px 10px; background: rgba(16,185,129,0.15); border-radius: 12px; font-size: 11px; color: var(--primary); font-weight: 600; }
        .activity-list { }
        .activity-item { display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 8px; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .activity-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .activity-dot.green { background: var(--primary); }
        .activity-dot.blue { background: #3B82F6; }
        .activity-dot.orange { background: #F59E0B; }
        .activity-content { flex: 1; }
        .activity-msg { font-size: 14px; font-weight: 500; }
        .activity-time { font-size: 12px; color: var(--text-muted); }
        .activity-amount { font-size: 14px; font-weight: 600; color: var(--primary); }
        .activity-empty { text-align: center; padding: 32px; color: var(--text-muted); }

        /* Results State */
        .results { text-align: center; padding: 60px 24px; }
        .results-icon { width: 80px; height: 80px; margin: 0 auto 24px; background: rgba(16,185,129,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .results-icon svg { width: 40px; height: 40px; color: var(--primary); }
        .results-title { font-size: 28px; font-weight: 700; margin-bottom: 12px; }
        .results-money { font-size: 48px; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
        .results-desc { color: var(--text-muted); margin-bottom: 32px; }
        .results-stats { display: flex; gap: 32px; justify-content: center; margin-bottom: 32px; }
        .results-stat { text-align: center; }
        .results-stat-val { font-size: 28px; font-weight: 700; }
        .results-stat-label { font-size: 13px; color: var(--text-muted); }
        .btn-secondary { padding: 14px 28px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-secondary:hover { border-color: var(--primary); }

        /* Confetti */
        #confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9998; }

        /* Responsive */
        @media (max-width: 640px) {
            .hero-money { font-size: 48px; }
            .breakdown { flex-direction: column; align-items: center; }
            .breakdown-card { width: 100%; max-width: 280px; }
            .launch-btn { padding: 20px 40px; font-size: 18px; }
            .preview-money { font-size: 48px; }
        }
    </style>
</head>
<body>
    <canvas id="confetti"></canvas>

    <!-- LOCKED: Dark overlay + Salla button -->
    <div class="locked-overlay" id="lockedOverlay">
        <div class="locked-content">
            <div class="locked-icon"><i data-lucide="lock-open"></i></div>
            <h1 class="locked-title">Ø§Ø±Ø¨Ø· Ù…ØªØ¬Ø±Ùƒ</h1>
            <p class="locked-desc">Ø§Ø±Ø¨Ø· Ø³Ù„Ø©ØŒ ÙˆØ§Ø¶ØºØ· Ø²Ø± ÙˆØ§Ø­Ø¯ØŒ ÙˆØ´Ø§Ù‡Ø¯ Ø§Ù„Ø£Ù…ÙˆØ§Ù„ ØªØªØ¯ÙÙ‚</p>
            <button class="salla-btn" onclick="connectSalla()">
                <span class="salla-logo">Ø³Ù„Ø©</span>
                <span>Ø±Ø¨Ø· Salla</span>
            </button>
        </div>
    </div>

    <!-- DASHBOARD PREVIEW (visible behind overlay, scrollable) -->
    <div class="locked-wrapper">
        <div class="dashboard-preview" id="dashboardPreview">
            <div class="preview-hero">
                <div class="preview-money">Ù¤Ù¥,Ù Ù Ù  Ø±.Ø³</div>
                <div class="preview-subtitle">ØªÙ†ØªØ¸Ø±Ùƒ ÙÙŠ Ù…ØªØ¬Ø±Ùƒ</div>
                <div class="preview-btn">
                    <i data-lucide="rocket" style="width:20px;height:20px"></i>
                    <span>Ø§Ø³ØªØ±Ø¬Ø¹ Ø£Ù…ÙˆØ§Ù„Ùƒ</span>
                </div>
            </div>
            <div class="preview-cards">
                <div class="preview-card">
                    <div class="preview-card-icon">ğŸ›’</div>
                    <div class="preview-card-val">Ù£Ù¤Ù§</div>
                    <div class="preview-card-label">Ø³Ù„Ø© Ù…ØªØ±ÙˆÙƒØ©</div>
                </div>
                <div class="preview-card">
                    <div class="preview-card-icon">ğŸ˜´</div>
                    <div class="preview-card-val">Ù¨Ù©Ù¡</div>
                    <div class="preview-card-label">Ø¹Ù…ÙŠÙ„ Ø®Ø§Ù…Ù„</div>
                </div>
                <div class="preview-card">
                    <div class="preview-card-icon">ğŸ›ï¸</div>
                    <div class="preview-card-val">Ù¡Ù¥Ù¦</div>
                    <div class="preview-card-label">ÙØ±ØµØ© Ø¨ÙŠØ¹ Ø¥Ø¶Ø§ÙÙŠ</div>
                </div>
            </div>
            <div class="preview-activity">
                <div class="preview-activity-title">Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</div>
                <div class="preview-activity-item"><span class="preview-dot"></span><span>Ù…Ø­Ù…Ø¯ Ø£ÙƒÙ…Ù„ Ø·Ù„Ø¨Ù‡ - 320 Ø±.Ø³</span></div>
                <div class="preview-activity-item"><span class="preview-dot blue"></span><span>Ø£Ø­Ù…Ø¯ Ù‚Ø±Ø£ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</span></div>
                <div class="preview-activity-item"><span class="preview-dot orange"></span><span>Ø³Ø§Ø±Ø© Ù†Ù‚Ø±Øª Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø·</span></div>
                <div class="preview-activity-item"><span class="preview-dot"></span><span>Ø®Ø§Ù„Ø¯ Ø£ÙƒÙ…Ù„ Ø·Ù„Ø¨Ù‡ - 180 Ø±.Ø³</span></div>
            </div>
        </div>
    </div>

    <!-- MAIN APP (shown after Salla connected) -->
    <div class="app-container" id="appContainer">
        <div class="hero">
            <div class="hero-money" id="heroMoney">0</div>
            <div class="hero-currency">Ø±.Ø³</div>
            <div class="hero-subtitle">ØªÙ†ØªØ¸Ø±Ùƒ ÙÙŠ Ù…ØªØ¬Ø±Ùƒ</div>
        </div>

        <div class="breakdown" id="breakdown">
            <div class="breakdown-card" id="cartCard">
                <div class="breakdown-icon">ğŸ›’</div>
                <div class="breakdown-value" id="cartCount">0</div>
                <div class="breakdown-label">Ø³Ù„Ø© Ù…ØªØ±ÙˆÙƒØ©</div>
                <div class="breakdown-sar" id="cartValue">0 Ø±.Ø³</div>
            </div>
            <div class="breakdown-card" id="dormantCard">
                <div class="breakdown-icon">ğŸ˜´</div>
                <div class="breakdown-value" id="dormantCount">0</div>
                <div class="breakdown-label">Ø¹Ù…ÙŠÙ„ Ø®Ø§Ù…Ù„</div>
                <div class="breakdown-sar" id="dormantValue">0 Ø±.Ø³</div>
            </div>
            <div class="breakdown-card" id="upsellCard">
                <div class="breakdown-icon">ğŸ›ï¸</div>
                <div class="breakdown-value" id="upsellCount">0</div>
                <div class="breakdown-label">ÙØ±ØµØ© Ø¨ÙŠØ¹ Ø¥Ø¶Ø§ÙÙŠ</div>
                <div class="breakdown-sar" id="upsellValue">0 Ø±.Ø³</div>
            </div>
        </div>

        <div class="launch-section">
            <button class="launch-btn" id="launchBtn" onclick="launchCampaigns()">
                <i data-lucide="rocket"></i>
                <span>Ø§Ø³ØªØ±Ø¬Ø¹ Ø£Ù…ÙˆØ§Ù„Ùƒ</span>
            </button>
        </div>

        <div class="activity">
            <div class="activity-header">
                <span class="activity-title">Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</span>
                <span class="activity-badge">Ù…Ø¨Ø§Ø´Ø±</span>
            </div>
            <div class="activity-list" id="activityList">
                <div class="activity-empty">Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©</div>
            </div>
        </div>

        <!-- Results (shown after launch) -->
        <div class="results" id="results" style="display:none">
            <div class="results-icon"><i data-lucide="check-circle"></i></div>
            <h1 class="results-title">ØªÙ… Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø­Ù…Ù„Ø©!</h1>
            <div class="results-money" id="resultsMoney">0 Ø±.Ø³</div>
            <div class="results-desc">Ù…ØªÙˆÙ‚Ø¹ Ø§Ø³ØªØ±Ø¯Ø§Ø¯Ù‡ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©</div>
            <div class="results-stats">
                <div class="results-stat">
                    <div class="results-stat-val" id="resultsSent">0</div>
                    <div class="results-stat-label">Ø±Ø³Ø§Ù„Ø©</div>
                </div>
                <div class="results-stat">
                    <div class="results-stat-val" id="resultsCustomers">0</div>
                    <div class="results-stat-label">Ø¹Ù…ÙŠÙ„</div>
                </div>
            </div>
            <button class="btn-secondary" onclick="location.reload()">Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>
    </div>

    <script>
    let analysisData = null;

    // Connect Salla
    function connectSalla() {
        window.location.href = '/salla/install';
    }

    // Check connection on load
    async function checkConnection() {
        try {
            const res = await fetch('/api/ribh/analyze');
            const data = await res.json();

            if (data.success) {
                analysisData = data;
                showApp(data);
            }
            // If not connected, stay on locked screen
        } catch (e) {
            console.error('Connection check failed:', e);
        }
    }

    // Show main app
    function showApp(data) {
        document.getElementById('lockedOverlay').classList.add('hidden');
        document.getElementById('dashboardPreview').style.display = 'none';
        document.getElementById('appContainer').classList.add('active');

        const { analysis } = data;
        const { breakdown } = analysis;

        // Animate money
        animateValue(document.getElementById('heroMoney'), analysis.moneyWaiting);

        // Breakdown
        document.getElementById('cartCount').textContent = breakdown.abandonedCarts.count.toLocaleString();
        document.getElementById('cartValue').textContent = breakdown.abandonedCarts.recoveryEstimate.toLocaleString() + ' Ø±.Ø³';

        document.getElementById('dormantCount').textContent = breakdown.dormantCustomers.count.toLocaleString();
        document.getElementById('dormantValue').textContent = breakdown.dormantCustomers.reactivationEstimate.toLocaleString() + ' Ø±.Ø³';

        document.getElementById('upsellCount').textContent = breakdown.recentBuyers.count.toLocaleString();
        document.getElementById('upsellValue').textContent = breakdown.recentBuyers.upsellEstimate.toLocaleString() + ' Ø±.Ø³';

        // Hide empty cards
        if (breakdown.abandonedCarts.count === 0) document.getElementById('cartCard').style.display = 'none';
        if (breakdown.dormantCustomers.count === 0) document.getElementById('dormantCard').style.display = 'none';
        if (breakdown.recentBuyers.count === 0) document.getElementById('upsellCard').style.display = 'none';
    }

    // Launch campaigns
    async function launchCampaigns() {
        const btn = document.getElementById('launchBtn');
        btn.disabled = true;
        btn.innerHTML = '<span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...</span>';

        launchConfetti();

        try {
            const res = await fetch('/api/ribh/launch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ campaigns: ['cartRecovery', 'winback', 'upsell'] })
            });

            const data = await res.json();

            if (data.success) {
                showResults(data.results);
            } else {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (data.error || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="rocket"></i><span>Ø§Ø³ØªØ±Ø¬Ø¹ Ø£Ù…ÙˆØ§Ù„Ùƒ</span>';
                lucide.createIcons();
            }
        } catch (e) {
            console.error('Launch error:', e);
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="rocket"></i><span>Ø§Ø³ØªØ±Ø¬Ø¹ Ø£Ù…ÙˆØ§Ù„Ùƒ</span>';
            lucide.createIcons();
        }
    }

    // Show results
    function showResults(results) {
        document.querySelector('.hero').style.display = 'none';
        document.getElementById('breakdown').style.display = 'none';
        document.querySelector('.launch-section').style.display = 'none';
        document.querySelector('.activity').style.display = 'none';
        document.getElementById('results').style.display = 'block';

        launchConfetti();

        const totalRevenue = results.launched.reduce((s, l) => s + (l.estimatedRevenue || 0), 0);
        const totalCustomers = results.launched.reduce((s, l) => s + (l.audience || 0), 0);

        document.getElementById('resultsMoney').textContent = totalRevenue.toLocaleString() + ' Ø±.Ø³';
        document.getElementById('resultsSent').textContent = results.messagesSent.toLocaleString();
        document.getElementById('resultsCustomers').textContent = totalCustomers.toLocaleString();
    }

    // Animate counter
    function animateValue(el, end, duration = 1500) {
        let start = 0;
        const startTime = performance.now();
        function update(now) {
            const p = Math.min((now - startTime) / duration, 1);
            const eased = 1 - Math.pow(1 - p, 3);
            el.textContent = Math.floor(start + (end - start) * eased).toLocaleString();
            if (p < 1) requestAnimationFrame(update);
        }
        requestAnimationFrame(update);
    }

    // Confetti
    function launchConfetti() {
        const cv = document.getElementById('confetti'), ctx = cv.getContext('2d');
        cv.width = window.innerWidth; cv.height = window.innerHeight;
        const ps = [], colors = ['#10B981', '#22C55E', '#6366F1', '#F59E0B', '#3B82F6', '#EF4444', '#FAFAFA'];
        for (let i = 0; i < 120; i++) ps.push({ x: cv.width / 2 + (Math.random() - 0.5) * 200, y: cv.height / 2, vx: (Math.random() - 0.5) * 12, vy: Math.random() * -16 - 4, w: Math.random() * 8 + 4, h: Math.random() * 6 + 2, c: colors[Math.floor(Math.random() * colors.length)], r: Math.random() * 360, rv: (Math.random() - 0.5) * 12, g: 0.3, o: 1 });
        let f = 0;
        function draw() {
            ctx.clearRect(0, 0, cv.width, cv.height); let alive = false;
            ps.forEach(p => { p.x += p.vx; p.vy += p.g; p.y += p.vy; p.r += p.rv; if (f > 40) p.o -= 0.015; if (p.o <= 0) return; alive = true; ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.r * Math.PI / 180); ctx.globalAlpha = p.o; ctx.fillStyle = p.c; ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h); ctx.restore(); });
            f++; if (alive) requestAnimationFrame(draw); else ctx.clearRect(0, 0, cv.width, cv.height);
        }
        requestAnimationFrame(draw);
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        checkConnection();
    });
    </script>
</body>
</html>
