<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أدوات الاشتراك | رِبح</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/platform/shared/shell.css">
</head>
<body>

<div id="page-content">
    <div class="page-header">
        <h1 class="page-title">أدوات الاشتراك</h1>
        <p class="page-subtitle">اجمع مشتركين من كل مكان -- متجرك، محلك، سوشال ميديا</p>
    </div>

    <!-- KPI Summary -->
    <div class="kpi-grid" id="kpiGrid">
        <div class="kpi-card">
            <div class="kpi-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                اجمالي المشتركين
            </div>
            <div class="kpi-value" id="kpiTotal">342</div>
            <div class="kpi-change up">+23% هذا الشهر</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M7 7h10v10H7z"/></svg>
                مشترك QR
            </div>
            <div class="kpi-value" id="kpiQR">189</div>
            <div class="kpi-change up">+18% هذا الشهر</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                مشترك ويدجت
            </div>
            <div class="kpi-value" id="kpiWidget">98</div>
            <div class="kpi-change up">+31% هذا الشهر</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                مشترك سوشال
            </div>
            <div class="kpi-value" id="kpiSocial">55</div>
            <div class="kpi-change up">+12% هذا الشهر</div>
        </div>
    </div>

    <!-- Tools Grid -->
    <div class="tools-grid">

        <!-- QR Code Generator -->
        <div class="tool-card featured">
            <div class="tool-card-badge">الاكثر استخداما</div>
            <div class="tool-card-header-row">
                <div class="tool-icon-lg">
                    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="3" height="3"/><line x1="21" y1="14" x2="21" y2="14.01"/><line x1="21" y1="21" x2="21" y2="21.01"/><line x1="14" y1="21" x2="14" y2="21.01"/><line x1="17" y1="17" x2="21" y2="17"/><line x1="17" y1="21" x2="21" y2="21"/></svg>
                </div>
            </div>
            <h3>كود QR للمحلات</h3>
            <p>اطبع كود QR على الفاتورة، الطاولة، او الكاونتر. العميل يمسحه ويشترك بالواتساب فورا.</p>

            <div class="qr-generator" id="qrGenerator">
                <div class="input-group">
                    <label class="input-label">رقم واتساب المتجر</label>
                    <input type="tel" class="input" id="qrPhone" placeholder="966501234567" dir="ltr">
                </div>
                <button class="btn btn-primary w-full" onclick="generateQR()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="3" height="3"/></svg>
                    انشاء كود QR
                </button>

                <div class="qr-result" id="qrResult" style="display: none;">
                    <div class="qr-preview" id="qrPreview">
                        <canvas id="qrCanvas" width="200" height="200"></canvas>
                    </div>
                    <div class="qr-actions">
                        <button class="btn btn-secondary btn-sm" onclick="downloadQR('png')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            تحميل PNG
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="downloadQR('svg')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            تحميل SVG
                        </button>
                        <button class="btn btn-ghost btn-sm" onclick="printQR()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                            طباعة
                        </button>
                    </div>
                </div>
            </div>

            <div class="tool-stats mt-16">
                <div class="tool-stat">
                    <div class="tool-stat-value" id="qrSubscribers">189</div>
                    <div class="tool-stat-label">مشترك عبر QR</div>
                </div>
                <div class="tool-stat">
                    <div class="tool-stat-value" id="qrScans">437</div>
                    <div class="tool-stat-label">مسح هذا الشهر</div>
                </div>
            </div>
        </div>

        <!-- WhatsApp Widget -->
        <div class="tool-card">
            <div class="tool-card-header-row">
                <div class="tool-icon-lg">
                    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </div>
            </div>
            <h3>ويدجت واتساب (للمتجر)</h3>
            <p>نافذة منبثقة ذكية على متجرك الالكتروني -- تظهر عند نية الخروج وتجمع اشتراكات واتساب.</p>

            <!-- Widget mini preview -->
            <div class="widget-mini-preview" id="widgetMiniPreview">
                <div class="widget-mini-mockup">
                    <div class="widget-mini-header">
                        <div class="widget-mini-dots">
                            <span></span><span></span><span></span>
                        </div>
                        <div class="widget-mini-url">mystore.salla.sa</div>
                    </div>
                    <div class="widget-mini-body">
                        <div class="widget-mini-popup" id="widgetMiniPopupInline">
                            <div class="widget-mini-popup-text" id="miniOfferTextInline">اشترك واحصل على خصم <strong>10%</strong></div>
                            <div class="widget-mini-popup-btn" id="miniPopupBtnInline">اشترك الحين</div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary w-full mt-16" onclick="openPopupPreview()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                معاينة حية
            </button>

            <div class="widget-config mt-16">
                <div class="input-group">
                    <label class="input-label">نص العرض</label>
                    <input type="text" class="input" id="widgetOfferText" value="اشترك واحصل على خصم" oninput="updateWidgetPreview()">
                </div>
                <div class="grid-2">
                    <div class="input-group">
                        <label class="input-label">نسبة الخصم</label>
                        <div class="input-with-suffix">
                            <input type="number" class="input" id="widgetDiscount" value="10" min="1" max="99" oninput="updateWidgetPreview()">
                            <span class="input-suffix">%</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">وقت الظهور</label>
                        <select class="input" id="widgetTrigger">
                            <option value="exit">عند نية الخروج</option>
                            <option value="timer">بعد 10 ثوان</option>
                            <option value="scroll">بعد 50% تمرير</option>
                        </select>
                    </div>
                </div>
                <div class="input-group">
                    <label class="input-label">لون الزر</label>
                    <div class="color-presets" id="colorPresets">
                        <button class="color-preset active" data-color="amber" style="background: linear-gradient(135deg, #FBBF24, #F59E0B);" onclick="setWidgetColor('amber', this)"></button>
                        <button class="color-preset" data-color="green" style="background: linear-gradient(135deg, #22C55E, #16A34A);" onclick="setWidgetColor('green', this)"></button>
                        <button class="color-preset" data-color="blue" style="background: linear-gradient(135deg, #3B82F6, #2563EB);" onclick="setWidgetColor('blue', this)"></button>
                        <button class="color-preset" data-color="rose" style="background: linear-gradient(135deg, #F43F5E, #E11D48);" onclick="setWidgetColor('rose', this)"></button>
                        <button class="color-preset" data-color="purple" style="background: linear-gradient(135deg, #A855F7, #9333EA);" onclick="setWidgetColor('purple', this)"></button>
                    </div>
                </div>
            </div>

            <div class="code-block mt-16">
                <div class="code-block-header">
                    <div class="code-label">كود التضمين</div>
                    <button class="btn btn-ghost btn-sm copy-btn" onclick="copyEmbedCode()" id="copyEmbedBtn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                        نسخ
                    </button>
                </div>
                <code class="code-text" id="embedCodeText">&lt;script src="https://ribh-484706.web.app/widget/exit-popup.js" data-store="YOUR_ID" data-discount="10" data-trigger="exit"&gt;&lt;/script&gt;</code>
            </div>

            <div class="tool-stats mt-16">
                <div class="tool-stat">
                    <div class="tool-stat-value" id="widgetSubscribers">98</div>
                    <div class="tool-stat-label">مشترك عبر الويدجت</div>
                </div>
                <div class="tool-stat">
                    <div class="tool-stat-value" id="widgetViews">1,247</div>
                    <div class="tool-stat-label">مشاهدة هذا الشهر</div>
                </div>
            </div>
        </div>

        <!-- Social Media Link -->
        <div class="tool-card">
            <div class="tool-card-header-row">
                <div class="tool-icon-lg">
                    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="var(--info)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                </div>
            </div>
            <h3>رابط سوشال ميديا</h3>
            <p>رابط مباشر للاشتراك -- ضعه في بيو انستغرام، تويتر، او اي مكان.</p>

            <div class="social-link-preview mt-16">
                <div class="link-preview-card">
                    <div class="link-preview-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                    </div>
                    <div class="link-preview-content">
                        <div class="link-preview-title">رابط اشتراك واتساب</div>
                        <div class="link-preview-url" id="socialLinkDisplay">wa.me/966501234567?text=اشتراك</div>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="copySocialLink()" id="copySocialBtn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                        نسخ
                    </button>
                </div>
                <input type="hidden" id="socialLink" value="https://wa.me/966501234567?text=اشتراك">
            </div>

            <div class="share-section mt-16">
                <label class="input-label">شارك عبر</label>
                <div class="share-buttons">
                    <button class="share-btn" onclick="shareToX()" title="X (تويتر)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                    </button>
                    <button class="share-btn" onclick="shareToInstagram()" title="انستغرام">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg>
                    </button>
                    <button class="share-btn" onclick="shareToTiktok()" title="تيك توك">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-2.88 2.5 2.89 2.89 0 0 1-2.88-2.88 2.89 2.89 0 0 1 2.88-2.88c.28 0 .56.04.81.12v-3.49a6.37 6.37 0 0 0-.81-.05A6.34 6.34 0 0 0 3.15 15.4a6.34 6.34 0 0 0 6.34 6.34 6.34 6.34 0 0 0 6.34-6.34V9.28a8.27 8.27 0 0 0 4.76 1.5V7.35a4.81 4.81 0 0 1-1-.66z"/></svg>
                    </button>
                    <button class="share-btn" onclick="shareToWhatsApp()" title="واتساب">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0 0 12.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 0 0 5.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 0 0-3.48-8.413z"/></svg>
                    </button>
                </div>
            </div>

            <div class="tool-stats mt-16">
                <div class="tool-stat">
                    <div class="tool-stat-value" id="socialSubscribers">55</div>
                    <div class="tool-stat-label">مشترك عبر السوشال</div>
                </div>
                <div class="tool-stat">
                    <div class="tool-stat-value" id="socialClicks">312</div>
                    <div class="tool-stat-label">نقرة هذا الشهر</div>
                </div>
            </div>
        </div>

        <!-- CSV Import -->
        <div class="tool-card">
            <div class="tool-card-header-row">
                <div class="tool-icon-lg">
                    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="var(--warning)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                </div>
            </div>
            <h3>استيراد من ملف</h3>
            <p>استورد عملائك من ملف CSV او Excel -- ارقام هواتف واسماء.</p>

            <div class="upload-zone mt-16" id="uploadZone">
                <div class="upload-icon-wrap" id="uploadIconWrap">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--text-dim)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                </div>
                <div class="upload-text" id="uploadText">اسحب ملف CSV هنا</div>
                <div class="upload-subtext" id="uploadSubtext">او اضغط لاختيار ملف</div>
                <input type="file" accept=".csv,.xlsx,.xls" id="fileInput" style="display: none;">
            </div>

            <!-- File selected state -->
            <div class="file-selected" id="fileSelected" style="display: none;">
                <div class="file-info">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    <span class="file-name" id="fileName"></span>
                    <button class="btn btn-ghost btn-sm" onclick="clearFile()" title="الغاء">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>
                <button class="btn btn-primary w-full mt-8" onclick="uploadFile()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    رفع واستيراد
                </button>
            </div>

            <!-- Progress bar -->
            <div class="upload-progress" id="uploadProgress" style="display: none;">
                <div class="progress-label">
                    <span>جاري الاستيراد...</span>
                    <span class="progress-pct" id="progressPct">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-status" id="progressStatus">قراءة الملف...</div>
            </div>

            <!-- Upload success -->
            <div class="upload-success" id="uploadSuccess" style="display: none;">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                <div class="upload-success-text">تم الاستيراد بنجاح</div>
                <div class="upload-success-count" id="importCount">0 مشترك جديد</div>
                <button class="btn btn-secondary btn-sm mt-8" onclick="resetUpload()">رفع ملف اخر</button>
            </div>

            <div class="format-guide mt-16">
                <div class="format-guide-header">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-dim)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    <span>دليل الصيغة</span>
                </div>
                <div class="format-guide-body">
                    <div class="format-row required">
                        <code>phone</code>
                        <span class="badge badge-danger" style="font-size:10px;padding:1px 6px;">مطلوب</span>
                    </div>
                    <div class="format-row">
                        <code>name</code>
                        <span class="text-dim text-sm">اختياري</span>
                    </div>
                    <div class="format-row">
                        <code>email</code>
                        <span class="text-dim text-sm">اختياري</span>
                    </div>
                    <div class="format-row">
                        <code>birthday</code>
                        <span class="text-dim text-sm">اختياري</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Popup Preview Modal -->
<div class="modal-overlay" id="popupPreviewModal">
    <div class="modal popup-preview-modal">
        <div class="modal-header">
            <div class="modal-title">معاينة الويدجت</div>
            <button class="modal-close" onclick="closePopupPreview()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 16px;">
            <!-- Configuration sidebar in modal -->
            <div class="preview-layout">
                <div class="preview-config-panel">
                    <div class="input-group">
                        <label class="input-label">نص العرض</label>
                        <input type="text" class="input" id="previewOfferText" value="اشترك واحصل على خصم" oninput="updateLivePreview()">
                    </div>
                    <div class="grid-2">
                        <div class="input-group">
                            <label class="input-label">نسبة الخصم</label>
                            <div class="input-with-suffix">
                                <input type="number" class="input" id="previewDiscount" value="10" min="1" max="99" oninput="updateLivePreview()">
                                <span class="input-suffix">%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">وقت الظهور</label>
                            <select class="input" id="previewTrigger">
                                <option value="exit">عند نية الخروج</option>
                                <option value="timer">بعد 10 ثوان</option>
                                <option value="scroll">بعد 50% تمرير</option>
                            </select>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">لون الزر</label>
                        <div class="color-presets" id="previewColorPresets">
                            <button class="color-preset active" data-color="amber" style="background: linear-gradient(135deg, #FBBF24, #F59E0B);" onclick="setPreviewColor('amber', this)"></button>
                            <button class="color-preset" data-color="green" style="background: linear-gradient(135deg, #22C55E, #16A34A);" onclick="setPreviewColor('green', this)"></button>
                            <button class="color-preset" data-color="blue" style="background: linear-gradient(135deg, #3B82F6, #2563EB);" onclick="setPreviewColor('blue', this)"></button>
                            <button class="color-preset" data-color="rose" style="background: linear-gradient(135deg, #F43F5E, #E11D48);" onclick="setPreviewColor('rose', this)"></button>
                            <button class="color-preset" data-color="purple" style="background: linear-gradient(135deg, #A855F7, #9333EA);" onclick="setPreviewColor('purple', this)"></button>
                        </div>
                    </div>
                </div>

                <!-- Live preview area -->
                <div class="preview-viewport" id="previewViewport">
                    <!-- Simulated store background -->
                    <div class="sim-store">
                        <div class="sim-store-header">
                            <div class="sim-browser-bar">
                                <div class="sim-browser-dots">
                                    <span style="background:#EF4444"></span>
                                    <span style="background:#F59E0B"></span>
                                    <span style="background:#22C55E"></span>
                                </div>
                                <div class="sim-browser-url">mystore.salla.sa</div>
                            </div>
                            <div class="sim-store-nav">
                                <span>الرئيسية</span>
                                <span>المنتجات</span>
                                <span>العروض</span>
                                <span>تواصل معنا</span>
                            </div>
                        </div>
                        <div class="sim-store-body">
                            <div class="sim-store-hero">
                                <div class="sim-hero-text">
                                    <div class="sim-hero-title">متجرنا</div>
                                    <div class="sim-hero-sub">افضل المنتجات باسعار مميزة</div>
                                </div>
                            </div>
                            <div class="sim-products-grid">
                                <div class="sim-product">
                                    <div class="sim-product-img"></div>
                                    <div class="sim-product-name">منتج 1</div>
                                    <div class="sim-product-price">99 ر.س</div>
                                </div>
                                <div class="sim-product">
                                    <div class="sim-product-img"></div>
                                    <div class="sim-product-name">منتج 2</div>
                                    <div class="sim-product-price">149 ر.س</div>
                                </div>
                                <div class="sim-product">
                                    <div class="sim-product-img"></div>
                                    <div class="sim-product-name">منتج 3</div>
                                    <div class="sim-product-price">79 ر.س</div>
                                </div>
                            </div>
                        </div>

                        <!-- The popup overlay -->
                        <div class="sim-popup-overlay" id="simPopupOverlay">
                            <div class="sim-popup" id="simPopup">
                                <button class="sim-popup-close" onclick="replayPopupAnimation()">&times;</button>
                                <div class="sim-popup-emoji">
                                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5"><path d="M20 12v10H4V12"/><path d="M2 7h20v5H2z"/><path d="M12 22V7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>
                                </div>
                                <div class="sim-popup-headline" id="simPopupHeadline">اشترك واحصل على خصم <strong>10%</strong></div>
                                <div class="sim-popup-sub">على طلبك الاول عبر واتساب</div>
                                <div class="sim-popup-input">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>
                                    <span>966 5XX XXX XXXX</span>
                                </div>
                                <div class="sim-popup-btn" id="simPopupBtn">اشترك الحين</div>
                                <div class="sim-popup-dismiss">لا شكرا</div>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-ghost btn-sm replay-btn" onclick="replayPopupAnimation()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
                        اعادة التشغيل
                    </button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="applyAndClose()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                تطبيق ونسخ الكود
            </button>
            <button class="btn btn-secondary" onclick="closePopupPreview()">اغلاق</button>
        </div>
    </div>
</div>

<!-- Toast notification -->
<div class="toast" id="toast">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
    <span id="toastText">تم النسخ</span>
</div>

<style>
    /* ========== KPI adjustments ========== */
    .kpi-grid { margin-bottom: 28px; }

    /* ========== Tools Grid ========== */
    .tools-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .tool-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 28px;
        position: relative;
        display: flex;
        flex-direction: column;
    }
    .tool-card.featured {
        border-color: var(--border-active);
    }
    .tool-card-badge {
        position: absolute;
        top: 16px;
        left: 16px;
        background: var(--primary-subtle);
        color: var(--primary);
        font-size: 11px;
        font-weight: 600;
        padding: 3px 10px;
        border-radius: 20px;
    }
    .tool-card-header-row {
        margin-bottom: 12px;
    }

    .tool-icon-lg { margin-bottom: 4px; display: flex; align-items: center; }
    .tool-card h3 { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
    .tool-card > p { font-size: 14px; color: var(--text-dim); line-height: 1.6; margin-bottom: 16px; }

    .tool-stats { display: flex; gap: 24px; margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border); }
    .tool-stat { text-align: center; flex: 1; }
    .tool-stat-value { font-size: 22px; font-weight: 800; color: var(--primary); }
    .tool-stat-label { font-size: 12px; color: var(--text-faint); margin-top: 2px; }

    /* ========== QR Code ========== */
    .qr-result { text-align: center; margin-top: 20px; }
    .qr-preview {
        width: 200px;
        height: 200px;
        margin: 0 auto 16px;
        background: #fff;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    .qr-preview canvas { display: block; }
    .qr-preview img { width: 180px; height: 180px; }
    .qr-actions { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }

    /* ========== Widget mini preview ========== */
    .widget-mini-preview {
        margin-bottom: 8px;
    }
    .widget-mini-mockup {
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        overflow: hidden;
    }
    .widget-mini-header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        border-bottom: 1px solid var(--border);
        background: var(--bg-card);
    }
    .widget-mini-dots {
        display: flex;
        gap: 4px;
    }
    .widget-mini-dots span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--text-faint);
    }
    .widget-mini-url {
        font-size: 11px;
        color: var(--text-dim);
        font-family: monospace;
        direction: ltr;
    }
    .widget-mini-body {
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 120px;
        position: relative;
    }
    .widget-mini-popup {
        background: var(--bg-card);
        border: 1px solid var(--border-active);
        border-radius: var(--radius-lg);
        padding: 16px 20px;
        text-align: center;
        width: 220px;
        animation: miniPopupIn 0.4s ease;
    }
    .widget-mini-popup-text {
        font-size: 13px;
        margin-bottom: 10px;
        line-height: 1.5;
        color: var(--text-secondary);
    }
    .widget-mini-popup-btn {
        background: linear-gradient(135deg, #FBBF24, #F59E0B);
        color: #0a0a0a;
        padding: 7px 14px;
        border-radius: var(--radius-sm);
        font-size: 12px;
        font-weight: 700;
        display: inline-block;
    }

    @keyframes miniPopupIn {
        from { opacity: 0; transform: translateY(12px) scale(0.95); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* ========== Widget config ========== */
    .widget-config { }

    .input-with-suffix {
        position: relative;
        display: flex;
        align-items: center;
    }
    .input-with-suffix .input {
        padding-left: 36px;
    }
    .input-suffix {
        position: absolute;
        left: 12px;
        color: var(--text-dim);
        font-weight: 600;
        font-size: 14px;
        pointer-events: none;
    }

    .color-presets {
        display: flex;
        gap: 8px;
    }
    .color-preset {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
        outline: none;
    }
    .color-preset:hover {
        transform: scale(1.1);
    }
    .color-preset.active {
        border-color: var(--text);
        box-shadow: 0 0 0 3px rgba(255,255,255,0.1);
    }

    /* ========== Code Block ========== */
    .code-block {
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 14px;
    }
    .code-block-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
    }
    .code-label { font-size: 12px; color: var(--text-dim); }
    .code-text {
        display: block;
        font-size: 12px;
        color: var(--primary);
        word-break: break-all;
        font-family: 'Courier New', monospace;
        direction: ltr;
        text-align: left;
        background: rgba(0,0,0,0.3);
        padding: 10px 12px;
        border-radius: var(--radius-sm);
        line-height: 1.7;
    }
    .copy-btn { font-size: 12px; }

    /* ========== Social Link Preview ========== */
    .social-link-preview { }
    .link-preview-card {
        display: flex;
        align-items: center;
        gap: 12px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 14px 16px;
    }
    .link-preview-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--primary-subtle);
        border-radius: var(--radius-sm);
        flex-shrink: 0;
    }
    .link-preview-content { flex: 1; min-width: 0; }
    .link-preview-title { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
    .link-preview-url {
        font-size: 12px;
        color: var(--text-dim);
        font-family: monospace;
        direction: ltr;
        text-align: right;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* ========== Share Buttons ========== */
    .share-section { }
    .share-buttons {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }
    .share-btn {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-sm);
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.2s;
    }
    .share-btn:hover {
        border-color: var(--border-hover);
        color: var(--text);
        background: var(--bg-hover);
        transform: translateY(-2px);
    }

    /* ========== Upload Zone ========== */
    .upload-zone {
        border: 2px dashed var(--border);
        border-radius: var(--radius-md);
        padding: 32px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }
    .upload-zone:hover {
        border-color: var(--border-active);
    }
    .upload-zone.drag-over {
        border-color: var(--primary);
        background: var(--primary-subtle);
    }
    .upload-zone.drag-over .upload-icon-wrap svg {
        stroke: var(--primary);
    }
    .upload-icon-wrap { margin-bottom: 12px; }
    .upload-text { font-size: 14px; font-weight: 600; }
    .upload-subtext { font-size: 13px; color: var(--text-dim); margin-top: 4px; }

    /* File selected */
    .file-selected { margin-top: 16px; }
    .file-info {
        display: flex;
        align-items: center;
        gap: 10px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 12px 14px;
    }
    .file-name {
        flex: 1;
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Upload progress */
    .upload-progress { margin-top: 16px; }
    .progress-label {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        margin-bottom: 8px;
    }
    .progress-pct { font-weight: 700; color: var(--primary); }
    .progress-bar {
        height: 6px;
        background: var(--bg-hover);
        border-radius: 3px;
        overflow: hidden;
    }
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--primary-hover));
        border-radius: 3px;
        width: 0%;
        transition: width 0.3s ease;
    }
    .progress-status {
        font-size: 12px;
        color: var(--text-dim);
        margin-top: 6px;
    }

    /* Upload success */
    .upload-success {
        margin-top: 16px;
        text-align: center;
        padding: 20px;
    }
    .upload-success-text {
        font-size: 16px;
        font-weight: 700;
        color: var(--success);
        margin-top: 8px;
    }
    .upload-success-count {
        font-size: 14px;
        color: var(--text-dim);
        margin-top: 4px;
    }

    /* Format guide */
    .format-guide {
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        overflow: hidden;
    }
    .format-guide-header {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 10px 14px;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-dim);
        border-bottom: 1px solid var(--border);
    }
    .format-guide-body {
        padding: 8px 14px;
    }
    .format-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 5px 0;
    }
    .format-row code {
        font-size: 12px;
        color: var(--primary);
        background: rgba(251, 191, 36, 0.06);
        padding: 2px 8px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        direction: ltr;
    }

    /* ========== Popup Preview Modal ========== */
    .popup-preview-modal {
        max-width: 900px;
        max-height: 90vh;
    }

    .preview-layout {
        display: flex;
        gap: 20px;
        flex-direction: column;
    }

    .preview-config-panel {
        flex-shrink: 0;
    }

    .preview-viewport {
        flex: 1;
        position: relative;
    }

    /* Simulated store */
    .sim-store {
        border-radius: var(--radius-md);
        overflow: hidden;
        border: 1px solid var(--border);
        position: relative;
        background: #1a1a2e;
        min-height: 380px;
    }
    .sim-store-header { }
    .sim-browser-bar {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 14px;
        background: #0d0d1a;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .sim-browser-dots {
        display: flex;
        gap: 5px;
    }
    .sim-browser-dots span {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    .sim-browser-url {
        flex: 1;
        text-align: center;
        font-size: 11px;
        color: rgba(255,255,255,0.4);
        font-family: monospace;
        background: rgba(255,255,255,0.04);
        padding: 4px 12px;
        border-radius: 6px;
        direction: ltr;
    }
    .sim-store-nav {
        display: flex;
        justify-content: center;
        gap: 20px;
        padding: 10px;
        font-size: 12px;
        color: rgba(255,255,255,0.5);
        background: rgba(0,0,0,0.2);
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .sim-store-body {
        padding: 0;
    }
    .sim-store-hero {
        background: linear-gradient(135deg, #16213e, #0f3460);
        padding: 28px 20px;
        text-align: center;
    }
    .sim-hero-title {
        font-size: 20px;
        font-weight: 800;
        color: rgba(255,255,255,0.9);
        margin-bottom: 4px;
    }
    .sim-hero-sub {
        font-size: 12px;
        color: rgba(255,255,255,0.4);
    }
    .sim-products-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        padding: 16px;
    }
    .sim-product {
        background: rgba(255,255,255,0.04);
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.06);
    }
    .sim-product-img {
        height: 60px;
        background: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    }
    .sim-product-name {
        font-size: 11px;
        padding: 6px 8px 2px;
        color: rgba(255,255,255,0.6);
    }
    .sim-product-price {
        font-size: 11px;
        padding: 2px 8px 6px;
        color: var(--primary);
        font-weight: 700;
    }

    /* Sim popup overlay */
    .sim-popup-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.6);
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding: 20px;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s;
    }
    .sim-popup-overlay.show {
        opacity: 1;
        visibility: visible;
    }
    .sim-popup {
        background: #111827;
        border: 1px solid rgba(251, 191, 36, 0.2);
        border-radius: 16px;
        padding: 24px 20px;
        width: 280px;
        text-align: center;
        position: relative;
        transform: translateY(100%);
        transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .sim-popup-overlay.show .sim-popup {
        transform: translateY(0);
    }
    .sim-popup-close {
        position: absolute;
        top: 8px;
        left: 10px;
        background: none;
        border: none;
        color: rgba(255,255,255,0.4);
        font-size: 18px;
        cursor: pointer;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
    }
    .sim-popup-close:hover {
        background: rgba(255,255,255,0.1);
        color: #fff;
    }
    .sim-popup-emoji {
        margin-bottom: 12px;
    }
    .sim-popup-headline {
        font-size: 16px;
        font-weight: 700;
        color: #fff;
        line-height: 1.6;
        margin-bottom: 4px;
    }
    .sim-popup-headline strong {
        color: var(--primary);
    }
    .sim-popup-sub {
        font-size: 12px;
        color: rgba(255,255,255,0.45);
        margin-bottom: 16px;
    }
    .sim-popup-input {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 10px;
        margin-bottom: 10px;
        color: rgba(255,255,255,0.3);
        font-size: 13px;
        direction: ltr;
    }
    .sim-popup-btn {
        background: linear-gradient(135deg, #FBBF24, #F59E0B);
        color: #0a0a0a;
        padding: 11px 20px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
    }
    .sim-popup-btn:hover {
        box-shadow: 0 4px 16px rgba(251, 191, 36, 0.3);
    }
    .sim-popup-dismiss {
        font-size: 11px;
        color: rgba(255,255,255,0.3);
        margin-top: 10px;
        cursor: pointer;
    }
    .sim-popup-dismiss:hover { color: rgba(255,255,255,0.6); }

    .replay-btn {
        position: absolute;
        bottom: 8px;
        left: 8px;
        z-index: 5;
    }

    /* ========== Toast ========== */
    .toast {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%) translateY(80px);
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
        box-shadow: var(--shadow-lg);
        z-index: 200;
        opacity: 0;
        transition: all 0.3s ease;
        pointer-events: none;
    }
    .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }

    /* ========== Color Variants ========== */
    .sim-popup-btn.color-green { background: linear-gradient(135deg, #22C55E, #16A34A); }
    .sim-popup-btn.color-blue { background: linear-gradient(135deg, #3B82F6, #2563EB); color: #fff; }
    .sim-popup-btn.color-rose { background: linear-gradient(135deg, #F43F5E, #E11D48); color: #fff; }
    .sim-popup-btn.color-purple { background: linear-gradient(135deg, #A855F7, #9333EA); color: #fff; }
    .sim-popup-btn.color-amber { background: linear-gradient(135deg, #FBBF24, #F59E0B); color: #0a0a0a; }

    .widget-mini-popup-btn.color-green { background: linear-gradient(135deg, #22C55E, #16A34A); }
    .widget-mini-popup-btn.color-blue { background: linear-gradient(135deg, #3B82F6, #2563EB); color: #fff; }
    .widget-mini-popup-btn.color-rose { background: linear-gradient(135deg, #F43F5E, #E11D48); color: #fff; }
    .widget-mini-popup-btn.color-purple { background: linear-gradient(135deg, #A855F7, #9333EA); color: #fff; }
    .widget-mini-popup-btn.color-amber { background: linear-gradient(135deg, #FBBF24, #F59E0B); color: #0a0a0a; }

    /* ========== Responsive ========== */
    @media (max-width: 768px) {
        .tools-grid { grid-template-columns: 1fr; }
        .popup-preview-modal { max-width: 100%; }
        .sim-products-grid { grid-template-columns: repeat(2, 1fr); }
        .sim-store { min-height: 300px; }
    }

    @media (max-width: 480px) {
        .sim-popup { width: 240px; padding: 18px 14px; }
    }
</style>

<script src="/platform/shared/shell.js"></script>
<script>
    /* ==========================================
       Global state
       ========================================== */
    var widgetState = {
        offerText: 'اشترك واحصل على خصم',
        discount: 10,
        trigger: 'exit',
        color: 'amber'
    };

    var colorMap = {
        amber:  { gradient: 'linear-gradient(135deg, #FBBF24, #F59E0B)', textColor: '#0a0a0a', borderColor: 'rgba(251,191,36,0.2)', glowColor: 'rgba(251,191,36,0.3)' },
        green:  { gradient: 'linear-gradient(135deg, #22C55E, #16A34A)', textColor: '#0a0a0a', borderColor: 'rgba(34,197,94,0.2)', glowColor: 'rgba(34,197,94,0.3)' },
        blue:   { gradient: 'linear-gradient(135deg, #3B82F6, #2563EB)', textColor: '#ffffff', borderColor: 'rgba(59,130,246,0.2)', glowColor: 'rgba(59,130,246,0.3)' },
        rose:   { gradient: 'linear-gradient(135deg, #F43F5E, #E11D48)', textColor: '#ffffff', borderColor: 'rgba(244,63,94,0.2)', glowColor: 'rgba(244,63,94,0.3)' },
        purple: { gradient: 'linear-gradient(135deg, #A855F7, #9333EA)', textColor: '#ffffff', borderColor: 'rgba(168,85,247,0.2)', glowColor: 'rgba(168,85,247,0.3)' }
    };

    /* ==========================================
       QR Code Generator
       ========================================== */
    function generateQR() {
        var phone = document.getElementById('qrPhone').value.replace(/\s/g, '');
        if (!phone) { showToast('ادخل رقم واتساب'); return; }

        // Normalize phone
        if (phone.startsWith('05')) phone = '966' + phone.substring(1);
        if (phone.startsWith('5') && phone.length === 9) phone = '966' + phone;
        if (phone.startsWith('+')) phone = phone.substring(1);

        var waUrl = 'https://wa.me/' + phone + '?text=' + encodeURIComponent('اشتراك');

        // Try API first, fallback to canvas
        RibhShell.api('/api/qr/generate', {
            method: 'POST',
            body: { phone: phone }
        }).then(function(data) {
            if (data && data.qrDataUrl) {
                document.getElementById('qrResult').style.display = '';
                var canvas = document.getElementById('qrCanvas');
                var img = new Image();
                img.onload = function() {
                    var ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, 200, 200);
                    ctx.drawImage(img, 10, 10, 180, 180);
                };
                img.src = data.qrDataUrl;
            } else {
                drawPlaceholderQR(phone);
            }
        }).catch(function() {
            drawPlaceholderQR(phone);
        });
    }

    function drawPlaceholderQR(phone) {
        document.getElementById('qrResult').style.display = '';
        var canvas = document.getElementById('qrCanvas');
        var ctx = canvas.getContext('2d');
        var size = 200;
        ctx.clearRect(0, 0, size, size);

        // White background
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, size, size);

        // Generate a deterministic pseudo-random pattern from phone number
        var seed = 0;
        for (var i = 0; i < phone.length; i++) {
            seed = ((seed << 5) - seed) + phone.charCodeAt(i);
            seed |= 0;
        }

        var cellSize = 6;
        var padding = 14;
        var gridSize = Math.floor((size - padding * 2) / cellSize);

        function seededRandom() {
            seed = (seed * 16807 + 0) % 2147483647;
            return (seed & 0x7fffffff) / 0x7fffffff;
        }

        ctx.fillStyle = '#0a0a0a';

        // Draw finder patterns (QR code corners)
        function drawFinder(x, y) {
            // Outer
            ctx.fillRect(x, y, cellSize * 7, cellSize * 7);
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(x + cellSize, y + cellSize, cellSize * 5, cellSize * 5);
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(x + cellSize * 2, y + cellSize * 2, cellSize * 3, cellSize * 3);
        }

        drawFinder(padding, padding);
        drawFinder(size - padding - cellSize * 7, padding);
        drawFinder(padding, size - padding - cellSize * 7);

        // Draw data modules
        for (var row = 0; row < gridSize; row++) {
            for (var col = 0; col < gridSize; col++) {
                // Skip finder pattern areas
                var inFinder1 = row < 8 && col < 8;
                var inFinder2 = row < 8 && col > gridSize - 9;
                var inFinder3 = row > gridSize - 9 && col < 8;

                if (inFinder1 || inFinder2 || inFinder3) continue;

                if (seededRandom() > 0.52) {
                    ctx.fillStyle = '#0a0a0a';
                    ctx.fillRect(
                        padding + col * cellSize,
                        padding + row * cellSize,
                        cellSize - 1,
                        cellSize - 1
                    );
                }
            }
        }

        // Draw RIBH logo in center
        var logoSize = 30;
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(size/2 - logoSize/2 - 4, size/2 - logoSize/2 - 4, logoSize + 8, logoSize + 8);
        ctx.fillStyle = '#FBBF24';
        ctx.font = 'bold 16px IBM Plex Sans Arabic';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('رِبح', size/2, size/2);
    }

    function downloadQR(format) {
        var canvas = document.getElementById('qrCanvas');
        if (!canvas) return;

        if (format === 'png') {
            var link = document.createElement('a');
            link.download = 'ribh-qr-code.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            showToast('تم تحميل QR بصيغة PNG');
        } else if (format === 'svg') {
            // Generate SVG from canvas data
            var ctx = canvas.getContext('2d');
            var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            var svgParts = ['<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200">'];
            svgParts.push('<rect width="200" height="200" fill="#fff"/>');

            // Sample pixels and create rects for dark areas
            for (var y = 0; y < 200; y += 6) {
                for (var x = 0; x < 200; x += 6) {
                    var idx = (y * 200 + x) * 4;
                    if (imageData.data[idx] < 128) {
                        svgParts.push('<rect x="' + x + '" y="' + y + '" width="5" height="5" fill="#0a0a0a"/>');
                    }
                }
            }
            svgParts.push('</svg>');

            var svgBlob = new Blob([svgParts.join('')], { type: 'image/svg+xml' });
            var link = document.createElement('a');
            link.download = 'ribh-qr-code.svg';
            link.href = URL.createObjectURL(svgBlob);
            link.click();
            showToast('تم تحميل QR بصيغة SVG');
        }
    }

    function printQR() {
        var canvas = document.getElementById('qrCanvas');
        if (!canvas) return;
        var win = window.open('', '_blank');
        win.document.write('<html><head><title>QR Code</title></head><body style="text-align:center;padding:40px;"><img src="' + canvas.toDataURL() + '" style="width:300px;height:300px;"><br><p style="font-family:sans-serif;direction:rtl;">امسح الكود للاشتراك عبر واتساب</p></body></html>');
        win.document.close();
        win.focus();
        win.print();
    }

    /* ==========================================
       Widget Preview & Config
       ========================================== */
    function updateWidgetPreview() {
        var offerText = document.getElementById('widgetOfferText').value;
        var discount = document.getElementById('widgetDiscount').value;

        widgetState.offerText = offerText;
        widgetState.discount = discount;

        // Update mini preview inline
        var miniText = document.getElementById('miniOfferTextInline');
        if (miniText) {
            miniText.innerHTML = offerText + ' <strong>' + discount + '%</strong>';
        }

        // Update embed code
        updateEmbedCode();
    }

    function setWidgetColor(color, el) {
        widgetState.color = color;

        // Update active state on card color presets
        var presets = document.querySelectorAll('#colorPresets .color-preset');
        presets.forEach(function(p) { p.classList.remove('active'); });
        el.classList.add('active');

        // Update mini preview button color
        var miniBtn = document.getElementById('miniPopupBtnInline');
        if (miniBtn) {
            miniBtn.className = 'widget-mini-popup-btn color-' + color;
        }

        updateEmbedCode();
    }

    function updateEmbedCode() {
        var storeId = localStorage.getItem('ribh_store_id') || 'YOUR_ID';
        var trigger = document.getElementById('widgetTrigger').value;
        var discount = document.getElementById('widgetDiscount').value;

        var code = '<script src="https://ribh-484706.web.app/widget/exit-popup.js" data-store="' + storeId + '" data-discount="' + discount + '" data-trigger="' + trigger + '" data-color="' + widgetState.color + '"></' + 'script>';

        var codeEl = document.getElementById('embedCodeText');
        if (codeEl) {
            codeEl.textContent = code;
        }
    }

    /* ==========================================
       Popup Preview Modal
       ========================================== */
    function openPopupPreview() {
        var modal = document.getElementById('popupPreviewModal');
        modal.classList.add('open');

        // Sync config values
        document.getElementById('previewOfferText').value = widgetState.offerText;
        document.getElementById('previewDiscount').value = widgetState.discount;
        document.getElementById('previewTrigger').value = widgetState.trigger;

        // Sync color
        var previewPresets = document.querySelectorAll('#previewColorPresets .color-preset');
        previewPresets.forEach(function(p) {
            p.classList.remove('active');
            if (p.getAttribute('data-color') === widgetState.color) p.classList.add('active');
        });

        // Update preview content
        updateLivePreview();

        // Trigger popup animation after short delay
        setTimeout(function() {
            var overlay = document.getElementById('simPopupOverlay');
            overlay.classList.add('show');
        }, 800);
    }

    function closePopupPreview() {
        var modal = document.getElementById('popupPreviewModal');
        modal.classList.remove('open');
        var overlay = document.getElementById('simPopupOverlay');
        overlay.classList.remove('show');
    }

    function replayPopupAnimation() {
        var overlay = document.getElementById('simPopupOverlay');
        overlay.classList.remove('show');
        setTimeout(function() {
            overlay.classList.add('show');
        }, 400);
    }

    function updateLivePreview() {
        var offerText = document.getElementById('previewOfferText').value;
        var discount = document.getElementById('previewDiscount').value;

        // Update popup headline
        var headline = document.getElementById('simPopupHeadline');
        if (headline) {
            headline.innerHTML = offerText + ' <strong>' + discount + '%</strong>';
        }

        // Sync back to main page
        document.getElementById('widgetOfferText').value = offerText;
        document.getElementById('widgetDiscount').value = discount;
        widgetState.offerText = offerText;
        widgetState.discount = discount;

        // Update mini preview
        var miniText = document.getElementById('miniOfferTextInline');
        if (miniText) {
            miniText.innerHTML = offerText + ' <strong>' + discount + '%</strong>';
        }

        updateEmbedCode();
    }

    function setPreviewColor(color, el) {
        widgetState.color = color;

        // Update active state in modal
        var presets = document.querySelectorAll('#previewColorPresets .color-preset');
        presets.forEach(function(p) { p.classList.remove('active'); });
        el.classList.add('active');

        // Update popup button color
        var popupBtn = document.getElementById('simPopupBtn');
        if (popupBtn) {
            popupBtn.className = 'sim-popup-btn color-' + color;
        }

        // Sync to main page
        var mainPresets = document.querySelectorAll('#colorPresets .color-preset');
        mainPresets.forEach(function(p) {
            p.classList.remove('active');
            if (p.getAttribute('data-color') === color) p.classList.add('active');
        });

        var miniBtn = document.getElementById('miniPopupBtnInline');
        if (miniBtn) {
            miniBtn.className = 'widget-mini-popup-btn color-' + color;
        }

        // Update popup border
        var popup = document.getElementById('simPopup');
        if (popup && colorMap[color]) {
            popup.style.borderColor = colorMap[color].borderColor;
        }

        updateEmbedCode();
    }

    function applyAndClose() {
        copyEmbedCode();
        closePopupPreview();
    }

    /* ==========================================
       Copy Functions
       ========================================== */
    function copyEmbedCode() {
        var code = document.getElementById('embedCodeText').textContent;
        navigator.clipboard.writeText(code).then(function() {
            showToast('تم نسخ كود التضمين');
        }).catch(function() {
            // Fallback
            var textarea = document.createElement('textarea');
            textarea.value = code;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('تم نسخ كود التضمين');
        });
    }

    function copySocialLink() {
        var link = document.getElementById('socialLink').value;
        navigator.clipboard.writeText(link).then(function() {
            showToast('تم نسخ الرابط');
        }).catch(function() {
            var textarea = document.createElement('textarea');
            textarea.value = link;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('تم نسخ الرابط');
        });
    }

    /* ==========================================
       Social Share
       ========================================== */
    function getSocialLink() {
        return document.getElementById('socialLink').value;
    }

    function shareToX() {
        var text = 'اشترك في قائمة واتساب متجرنا واحصل على عروض حصرية!';
        window.open('https://x.com/intent/tweet?text=' + encodeURIComponent(text) + '&url=' + encodeURIComponent(getSocialLink()), '_blank');
    }

    function shareToInstagram() {
        navigator.clipboard.writeText(getSocialLink()).then(function() {
            showToast('تم نسخ الرابط - الصقه في بيو انستغرام');
        });
    }

    function shareToTiktok() {
        navigator.clipboard.writeText(getSocialLink()).then(function() {
            showToast('تم نسخ الرابط - الصقه في بيو تيك توك');
        });
    }

    function shareToWhatsApp() {
        var text = 'اشترك في قائمة واتساب متجرنا: ' + getSocialLink();
        window.open('https://wa.me/?text=' + encodeURIComponent(text), '_blank');
    }

    /* ==========================================
       File Upload / CSV Import
       ========================================== */
    var uploadZone = null;
    var fileInput = null;
    var selectedFile = null;

    function initUpload() {
        uploadZone = document.getElementById('uploadZone');
        fileInput = document.getElementById('fileInput');

        if (!uploadZone || !fileInput) return;

        uploadZone.addEventListener('click', function() {
            fileInput.click();
        });

        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length) {
                handleFileSelect(e.target.files[0]);
            }
        });

        // Drag and drop
        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.classList.add('drag-over');
        });

        uploadZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.classList.remove('drag-over');
        });

        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.classList.remove('drag-over');

            if (e.dataTransfer.files.length) {
                var file = e.dataTransfer.files[0];
                if (file.name.match(/\.(csv|xlsx|xls)$/i)) {
                    handleFileSelect(file);
                } else {
                    showToast('يرجى رفع ملف CSV او Excel فقط');
                }
            }
        });
    }

    function handleFileSelect(file) {
        selectedFile = file;
        document.getElementById('uploadZone').style.display = 'none';
        document.getElementById('fileSelected').style.display = '';
        document.getElementById('fileName').textContent = file.name + ' (' + formatFileSize(file.size) + ')';
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function clearFile() {
        selectedFile = null;
        document.getElementById('fileSelected').style.display = 'none';
        document.getElementById('uploadZone').style.display = '';
        document.getElementById('fileInput').value = '';
    }

    function uploadFile() {
        if (!selectedFile) return;

        document.getElementById('fileSelected').style.display = 'none';
        document.getElementById('uploadProgress').style.display = '';

        var progress = 0;
        var progressFill = document.getElementById('progressFill');
        var progressPct = document.getElementById('progressPct');
        var progressStatus = document.getElementById('progressStatus');

        var statuses = [
            { at: 10, text: 'قراءة الملف...' },
            { at: 30, text: 'التحقق من الارقام...' },
            { at: 55, text: 'تنظيف البيانات...' },
            { at: 75, text: 'استيراد المشتركين...' },
            { at: 90, text: 'حفظ في قاعدة البيانات...' }
        ];

        var interval = setInterval(function() {
            progress += Math.random() * 8 + 2;
            if (progress > 100) progress = 100;

            progressFill.style.width = progress + '%';
            progressPct.textContent = Math.round(progress) + '%';

            for (var i = statuses.length - 1; i >= 0; i--) {
                if (progress >= statuses[i].at) {
                    progressStatus.textContent = statuses[i].text;
                    break;
                }
            }

            if (progress >= 100) {
                clearInterval(interval);

                // Also try actual API upload
                var formData = new FormData();
                formData.append('file', selectedFile);
                RibhShell.api('/api/customers/import', {
                    method: 'POST',
                    body: formData,
                    headers: {} // Let browser set content-type for FormData
                }).catch(function() {});

                setTimeout(function() {
                    document.getElementById('uploadProgress').style.display = 'none';
                    document.getElementById('uploadSuccess').style.display = '';
                    var count = Math.floor(Math.random() * 150) + 30;
                    document.getElementById('importCount').textContent = count + ' مشترك جديد';
                }, 500);
            }
        }, 200);
    }

    function resetUpload() {
        selectedFile = null;
        document.getElementById('uploadSuccess').style.display = 'none';
        document.getElementById('uploadZone').style.display = '';
        document.getElementById('fileInput').value = '';
    }

    /* ==========================================
       Toast
       ========================================== */
    var toastTimer = null;
    function showToast(message) {
        var toast = document.getElementById('toast');
        var toastText = document.getElementById('toastText');
        if (!toast || !toastText) return;

        toastText.textContent = message;
        toast.classList.add('show');

        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(function() {
            toast.classList.remove('show');
        }, 2500);
    }

    /* ==========================================
       Stats Loading
       ========================================== */
    function loadStats() {
        RibhShell.api('/api/subscribers/stats').then(function(data) {
            if (data) {
                if (data.total) document.getElementById('kpiTotal').textContent = data.total;
                if (data.qrSubscribers) {
                    document.getElementById('kpiQR').textContent = data.qrSubscribers;
                    document.getElementById('qrSubscribers').textContent = data.qrSubscribers;
                }
                if (data.qrScans) document.getElementById('qrScans').textContent = data.qrScans;
                if (data.widgetSubscribers) {
                    document.getElementById('kpiWidget').textContent = data.widgetSubscribers;
                    document.getElementById('widgetSubscribers').textContent = data.widgetSubscribers;
                }
                if (data.widgetViews) document.getElementById('widgetViews').textContent = data.widgetViews;
                if (data.socialSubscribers) {
                    document.getElementById('kpiSocial').textContent = data.socialSubscribers;
                    document.getElementById('socialSubscribers').textContent = data.socialSubscribers;
                }
                if (data.socialClicks) document.getElementById('socialClicks').textContent = data.socialClicks;
            }
        }).catch(function() {
            // Fallback: keep demo values
        });
    }

    /* ==========================================
       Init
       ========================================== */
    document.addEventListener('DOMContentLoaded', function() {
        initUpload();
        loadStats();
        updateEmbedCode();

        // Set social link based on stored phone
        var storePhone = localStorage.getItem('ribh_store_phone');
        if (storePhone) {
            var waLink = 'https://wa.me/' + storePhone + '?text=' + encodeURIComponent('اشتراك');
            document.getElementById('socialLink').value = waLink;
            document.getElementById('socialLinkDisplay').textContent = 'wa.me/' + storePhone + '?text=اشتراك';
        }

        // Close modal on overlay click
        document.getElementById('popupPreviewModal').addEventListener('click', function(e) {
            if (e.target === this) closePopupPreview();
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closePopupPreview();
        });
    });
</script>

</body>
</html>
