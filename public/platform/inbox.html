<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المحادثات | رِبح</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/platform/shared/shell.css">
</head>
<body>

<div id="page-content">
    <div class="inbox-layout">

        <!-- Conversations List (Right Panel) -->
        <div class="inbox-sidebar" id="inboxSidebar">
            <div class="inbox-sidebar-header">
                <div class="inbox-search">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    <input type="text" class="inbox-search-input" placeholder="ابحث عن محادثة..." id="searchInput">
                </div>
                <div class="inbox-filters">
                    <button class="inbox-filter active" data-filter="all">الكل</button>
                    <button class="inbox-filter" data-filter="unread">غير مقروء</button>
                    <button class="inbox-filter" data-filter="needs_reply">يحتاج رد</button>
                </div>
            </div>

            <div class="inbox-conversations" id="conversationsList">
            </div>
        </div>

        <!-- Chat Area (Left Panel) -->
        <div class="inbox-chat" id="inboxChat">
            <!-- Empty state -->
            <div class="inbox-empty" id="emptyState">
                <div class="inbox-empty-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </div>
                <h3>اختر محادثة</h3>
                <p>اختر محادثة من القائمة لعرض الرسائل</p>
            </div>

            <!-- Active chat (hidden initially) -->
            <div class="inbox-active-chat" id="activeChat" style="display: none;">
                <!-- Chat Header -->
                <div class="chat-header">
                    <button class="chat-back-btn" id="chatBackBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
                    </button>
                    <div class="chat-contact-info">
                        <div class="chat-contact-avatar" id="chatAvatar">م</div>
                        <div>
                            <div class="chat-contact-name" id="chatName"></div>
                            <div class="chat-contact-meta" id="chatMeta"></div>
                        </div>
                    </div>
                    <div class="chat-header-actions">
                        <button class="topbar-btn" title="ملف العميل" onclick="viewProfile()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Messages -->
                <div class="chat-messages" id="chatMessages">
                </div>

                <!-- Input -->
                <div class="chat-input-area">
                    <div class="chat-input-row">
                        <button class="chat-action-btn" title="قالب" onclick="showTemplates()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
                        </button>
                        <button class="chat-action-btn" title="رد ذكي بالـ AI" onclick="generateAIReply()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                        </button>
                        <textarea class="chat-input" id="messageInput" placeholder="اكتب رسالة..." rows="1"></textarea>
                        <button class="chat-send-btn" id="sendBtn" onclick="sendMessage()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Override shell content padding for full-height inbox */
    #page-content { padding: 0 !important; height: calc(100vh - 56px); }

    .inbox-layout {
        display: flex;
        height: 100%;
        overflow: hidden;
    }

    /* Conversations sidebar */
    .inbox-sidebar {
        width: 340px;
        border-left: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
    }
    .inbox-sidebar-header {
        padding: 16px;
        border-bottom: 1px solid var(--border);
    }
    .inbox-search {
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 8px 12px;
        margin-bottom: 12px;
    }
    .inbox-search svg { color: var(--text-faint); flex-shrink: 0; }
    .inbox-search-input {
        border: none;
        background: transparent;
        color: var(--text);
        font-size: 13px;
        width: 100%;
        outline: none;
        font-family: inherit;
    }

    .inbox-filters { display: flex; gap: 6px; }
    .inbox-filter {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        background: transparent;
        color: var(--text-dim);
        border: 1px solid var(--border);
        cursor: pointer;
        transition: all 0.15s;
        font-family: inherit;
    }
    .inbox-filter.active {
        background: var(--primary-subtle);
        color: var(--primary);
        border-color: var(--primary);
    }

    .inbox-conversations {
        flex: 1;
        overflow-y: auto;
    }

    .conversation-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        transition: background 0.15s;
    }
    .conversation-item:hover { background: var(--bg-hover); }
    .conversation-item.active { background: var(--bg-elevated); border-right: 3px solid var(--primary); }
    .conversation-item.unread { background: rgba(251, 191, 36, 0.04); }

    .conv-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--bg-elevated);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 15px;
        color: var(--primary);
        flex-shrink: 0;
        border: 1px solid var(--border);
    }

    .conv-content { flex: 1; min-width: 0; }
    .conv-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .conv-name { font-size: 14px; font-weight: 600; }
    .conv-time { font-size: 11px; color: var(--text-faint); }
    .conv-preview {
        font-size: 12px;
        color: var(--text-dim);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .conv-unread-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--primary);
        flex-shrink: 0;
    }

    /* Chat area */
    .inbox-chat {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
    }

    .inbox-empty {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-faint);
    }
    .inbox-empty-icon { margin-bottom: 16px; opacity: 0.3; }
    .inbox-empty h3 { font-size: 16px; margin-bottom: 6px; color: var(--text-dim); }
    .inbox-empty p { font-size: 13px; }

    .inbox-active-chat {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .chat-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        background: var(--bg-card);
    }
    .chat-back-btn {
        display: none;
        background: transparent;
        border: none;
        color: var(--text-dim);
        cursor: pointer;
        padding: 4px;
    }
    .chat-contact-info { display: flex; align-items: center; gap: 10px; flex: 1; }
    .chat-contact-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--bg-elevated);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
        color: var(--primary);
        border: 1px solid var(--border);
    }
    .chat-contact-name { font-size: 14px; font-weight: 600; }
    .chat-contact-meta { font-size: 12px; color: var(--text-faint); }
    .chat-header-actions { display: flex; gap: 4px; }

    /* Messages */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .message {
        max-width: 75%;
        padding: 10px 14px;
        border-radius: 14px;
        font-size: 14px;
        line-height: 1.6;
        position: relative;
    }
    .message.outgoing {
        align-self: flex-start;
        background: linear-gradient(135deg, #FBBF24, #F59E0B);
        color: #0a0a0a;
        border-bottom-right-radius: 4px;
    }
    .message.incoming {
        align-self: flex-end;
        background: var(--bg-elevated);
        color: var(--text);
        border-bottom-left-radius: 4px;
    }
    .message-time {
        font-size: 10px;
        opacity: 0.7;
        margin-top: 4px;
        display: block;
    }

    .message-system {
        text-align: center;
        font-size: 12px;
        color: var(--text-faint);
        padding: 4px 0;
        font-style: italic;
    }

    /* Input area */
    .chat-input-area {
        padding: 12px 16px;
        border-top: 1px solid var(--border);
        background: var(--bg-card);
    }
    .chat-input-row {
        display: flex;
        align-items: flex-end;
        gap: 8px;
    }
    .chat-action-btn {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        color: var(--text-dim);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.15s;
    }
    .chat-action-btn:hover { border-color: var(--primary); color: var(--primary); }

    .chat-input {
        flex: 1;
        border: 1px solid var(--border);
        background: var(--bg-elevated);
        color: var(--text);
        border-radius: 12px;
        padding: 8px 14px;
        font-size: 14px;
        font-family: inherit;
        resize: none;
        max-height: 120px;
        outline: none;
        transition: border-color 0.15s;
    }
    .chat-input:focus { border-color: var(--primary); }

    .chat-send-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #FBBF24, #F59E0B);
        border: none;
        color: #0a0a0a;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: transform 0.15s;
    }
    .chat-send-btn:hover { transform: scale(1.05); }

    /* Mobile responsive */
    @media (max-width: 768px) {
        .inbox-sidebar { width: 100%; }
        .inbox-chat { display: none; }
        .inbox-layout.chat-open .inbox-sidebar { display: none; }
        .inbox-layout.chat-open .inbox-chat { display: flex; }
        .chat-back-btn { display: block; }
    }
</style>

<script src="/platform/shared/shell.js"></script>
<script>
(function() {
    // Sample conversations data
    var conversations = [
        {
            id: 'c1',
            name: 'محمد العتيبي',
            phone: '+966501234567',
            avatar: 'م',
            lastMessage: 'تمام شكرا! طلبت المنتج الحين',
            time: '2:45 م',
            unread: false,
            segment: 'champion',
            messages: [
                { type: 'system', text: 'رحلة استرداد السلة' },
                { type: 'outgoing', text: 'اهلا محمد! لاحظنا انك ما كملت طلبك\n\nعندك حذاء نايكي في السلة بـ 450 ر.س\n\nيبيلك مساعدة؟', time: '1:30 م', status: 'read' },
                { type: 'incoming', text: 'هلا، ايه نسيته بصراحة. فيه خصم؟', time: '2:15 م' },
                { type: 'outgoing', text: 'اكيد! هذا كود خصم 10% خاص فيك: RIBH10\n\nيصير السعر 405 ر.س بس', time: '2:20 م', status: 'read' },
                { type: 'incoming', text: 'تمام شكرا! طلبت المنتج الحين', time: '2:45 م' }
            ]
        },
        {
            id: 'c2',
            name: 'نورة الشهري',
            phone: '+966559876543',
            avatar: 'ن',
            lastMessage: 'متى يوصل الطلب؟',
            time: '1:20 م',
            unread: true,
            segment: 'loyal',
            messages: [
                { type: 'system', text: 'متابعة بعد الشراء' },
                { type: 'outgoing', text: 'شكرا نورة على طلبك!\n\nرقم الطلب: #4521\nالتوصيل المتوقع: خلال 3-5 ايام عمل', time: '11:00 ص', status: 'read' },
                { type: 'incoming', text: 'متى يوصل الطلب؟', time: '1:20 م' }
            ]
        },
        {
            id: 'c3',
            name: 'خالد الدوسري',
            phone: '+966541112233',
            avatar: 'خ',
            lastMessage: 'ارسلنا لك كود خصم حصري...',
            time: 'امس',
            unread: false,
            segment: 'at_risk',
            messages: [
                { type: 'system', text: 'رحلة الاستعادة' },
                { type: 'outgoing', text: 'وحشتنا يا خالد!\n\nعندنا منتجات جديدة تناسبك. هذا كود خصم 15% حصري لك: BACK15\n\nزورنا الحين', time: 'امس 4:00 م', status: 'delivered' }
            ]
        },
        {
            id: 'c4',
            name: 'سارة القحطاني',
            phone: '+966508887766',
            avatar: 'س',
            lastMessage: 'ممتاز! اشتريت 3 قطع',
            time: 'امس',
            unread: false,
            segment: 'potential',
            messages: [
                { type: 'system', text: 'حملة العيد' },
                { type: 'outgoing', text: 'عروض العيد وصلت!\n\nخصم 20% على كل المنتجات\nالعرض لمدة 48 ساعة فقط\n\nاستخدمي كود: EID20', time: 'امس 10:00 ص', status: 'read' },
                { type: 'incoming', text: 'ممتاز! اشتريت 3 قطع', time: 'امس 2:30 م' }
            ]
        },
        {
            id: 'c5',
            name: 'عبدالله المالكي',
            phone: '+966533445566',
            avatar: 'ع',
            lastMessage: 'مرحبا عبدالله! شكرا لاشتراكك...',
            time: 'اول امس',
            unread: false,
            segment: 'recent',
            messages: [
                { type: 'system', text: 'رحلة الترحيب' },
                { type: 'outgoing', text: 'مرحبا عبدالله! شكرا لاشتراكك في متجرنا\n\nبنرسلك افضل العروض والمنتجات الجديدة.\n\nهذا كود خصم ترحيبي 10%: WELCOME10', time: 'اول امس 3:00 م', status: 'delivered' }
            ]
        }
    ];

    var activeConversation = null;

    function renderConversations(filter) {
        var list = document.getElementById('conversationsList');
        var html = '';

        var filtered = conversations;
        if (filter === 'unread') {
            filtered = conversations.filter(function(c) { return c.unread; });
        } else if (filter === 'needs_reply') {
            filtered = conversations.filter(function(c) {
                var last = c.messages[c.messages.length - 1];
                return last && last.type === 'incoming';
            });
        }

        filtered.forEach(function(conv) {
            var activeClass = activeConversation === conv.id ? ' active' : '';
            var unreadClass = conv.unread ? ' unread' : '';
            html += '<div class="conversation-item' + activeClass + unreadClass + '" data-id="' + conv.id + '">' +
                '<div class="conv-avatar">' + conv.avatar + '</div>' +
                '<div class="conv-content">' +
                    '<div class="conv-top">' +
                        '<span class="conv-name">' + conv.name + '</span>' +
                        '<span class="conv-time">' + conv.time + '</span>' +
                    '</div>' +
                    '<div class="conv-preview">' + conv.lastMessage + '</div>' +
                '</div>' +
                (conv.unread ? '<div class="conv-unread-dot"></div>' : '') +
            '</div>';
        });

        if (filtered.length === 0) {
            html = '<div style="padding: 40px; text-align: center; color: var(--text-faint); font-size: 13px;">لا توجد محادثات</div>';
        }

        list.innerHTML = html;

        // Bind click events
        list.querySelectorAll('.conversation-item').forEach(function(item) {
            item.addEventListener('click', function() {
                openConversation(this.getAttribute('data-id'));
            });
        });
    }

    function openConversation(id) {
        var conv = conversations.find(function(c) { return c.id === id; });
        if (!conv) return;

        activeConversation = id;
        conv.unread = false;

        // Update UI
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('activeChat').style.display = 'flex';
        document.getElementById('chatName').textContent = conv.name;
        document.getElementById('chatMeta').textContent = conv.phone + ' · ' + conv.segment;
        document.getElementById('chatAvatar').textContent = conv.avatar;

        // Render messages
        var messagesEl = document.getElementById('chatMessages');
        var html = '';
        conv.messages.forEach(function(msg) {
            if (msg.type === 'system') {
                html += '<div class="message-system">' + msg.text + '</div>';
            } else {
                var statusText = '';
                if (msg.status === 'read') statusText = ' ✓✓';
                else if (msg.status === 'delivered') statusText = ' ✓';

                html += '<div class="message ' + msg.type + '">' +
                    '<div>' + msg.text.replace(/\n/g, '<br>') + '</div>' +
                    '<span class="message-time">' + msg.time + statusText + '</span>' +
                '</div>';
            }
        });
        messagesEl.innerHTML = html;
        messagesEl.scrollTop = messagesEl.scrollHeight;

        // Re-render list with active state
        renderConversations(getCurrentFilter());

        // Mobile: show chat
        document.querySelector('.inbox-layout').classList.add('chat-open');
    }

    function getCurrentFilter() {
        var active = document.querySelector('.inbox-filter.active');
        return active ? active.getAttribute('data-filter') : 'all';
    }

    // Send message
    window.sendMessage = function() {
        var input = document.getElementById('messageInput');
        var text = input.value.trim();
        if (!text || !activeConversation) return;

        var conv = conversations.find(function(c) { return c.id === activeConversation; });
        if (!conv) return;

        var now = new Date();
        var timeStr = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();
        conv.messages.push({ type: 'outgoing', text: text, time: timeStr, status: 'delivered' });
        conv.lastMessage = text;
        conv.time = timeStr;

        // Send via API
        RibhShell.api('/api/whatsapp/send', {
            method: 'POST',
            body: { phone: conv.phone, message: text }
        }).catch(function() {});

        input.value = '';
        input.style.height = 'auto';
        openConversation(activeConversation);
    };

    // Templates
    window.showTemplates = function() {
        var templates = [
            'شكرا لتواصلك! كيف اقدر اساعدك؟',
            'تم! بنتواصل معك قريبا',
            'الطلب في الطريق! المتوقع وصوله خلال 2-3 ايام',
            'هذا كود خصم خاص لك: RIBH10'
        ];
        var choice = prompt('اختر قالب (1-4):\n\n1. ' + templates[0] + '\n2. ' + templates[1] + '\n3. ' + templates[2] + '\n4. ' + templates[3]);
        if (choice && templates[parseInt(choice) - 1]) {
            document.getElementById('messageInput').value = templates[parseInt(choice) - 1];
        }
    };

    // AI Reply
    window.generateAIReply = function() {
        if (!activeConversation) return;
        var conv = conversations.find(function(c) { return c.id === activeConversation; });
        if (!conv) return;

        var input = document.getElementById('messageInput');
        input.value = 'جاري انشاء رد ذكي...';
        input.disabled = true;

        RibhShell.api('/api/ai/generate-message', {
            method: 'POST',
            body: {
                customerName: conv.name,
                context: conv.messages.map(function(m) { return m.text; }).join('\n'),
                segment: conv.segment
            }
        }).then(function(data) {
            input.disabled = false;
            if (data && data.message) {
                input.value = data.message;
            } else {
                input.value = 'شكرا لتواصلك ' + conv.name.split(' ')[0] + '! كيف اقدر اساعدك؟';
            }
        }).catch(function() {
            input.disabled = false;
            input.value = 'شكرا لتواصلك ' + conv.name.split(' ')[0] + '! كيف اقدر اساعدك؟';
        });
    };

    // View profile
    window.viewProfile = function() {
        if (!activeConversation) return;
        window.location.href = '/platform/subscribers.html?id=' + activeConversation;
    };

    // Back button (mobile)
    document.getElementById('chatBackBtn').addEventListener('click', function() {
        document.querySelector('.inbox-layout').classList.remove('chat-open');
        activeConversation = null;
        document.getElementById('activeChat').style.display = 'none';
        document.getElementById('emptyState').style.display = '';
    });

    // Filter buttons
    document.querySelectorAll('.inbox-filter').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.inbox-filter').forEach(function(b) { b.classList.remove('active'); });
            this.classList.add('active');
            renderConversations(this.getAttribute('data-filter'));
        });
    });

    // Search
    document.getElementById('searchInput').addEventListener('input', function() {
        var query = this.value.trim().toLowerCase();
        var items = document.querySelectorAll('.conversation-item');
        items.forEach(function(item) {
            var name = item.querySelector('.conv-name').textContent.toLowerCase();
            var preview = item.querySelector('.conv-preview').textContent.toLowerCase();
            item.style.display = (name.includes(query) || preview.includes(query)) ? '' : 'none';
        });
    });

    // Auto-resize textarea
    document.getElementById('messageInput').addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // Send on Enter (without Shift)
    document.getElementById('messageInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            window.sendMessage();
        }
    });

    // Initial render
    renderConversations('all');

    // Load real conversations from API
    RibhShell.api('/api/inbox/conversations').then(function(data) {
        if (data && data.conversations && data.conversations.length) {
            conversations = data.conversations;
            renderConversations('all');
        }
    }).catch(function() {});
})();
</script>

</body>
</html>
