<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التحليلات | رِبح</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/platform/shared/shell.css">
</head>
<body>

<div id="page-content">
    <!-- Page Header -->
    <div class="page-header flex justify-between items-center" style="display: flex; align-items: flex-start; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
        <div>
            <h1 class="page-title">التحليلات</h1>
            <p class="page-subtitle">قصة أدائك التسويقي -- كل رقم يحكي</p>
        </div>
        <div class="tabs period-tabs" id="periodTabs">
            <button class="tab active" data-period="7d">7 ايام</button>
            <button class="tab" data-period="30d">30 يوم</button>
            <button class="tab" data-period="90d">90 يوم</button>
            <button class="tab" data-period="all">الكل</button>
        </div>
    </div>

    <!-- 1. Revenue Story Hero -->
    <div class="card revenue-hero" id="revenueHero">
        <div class="revenue-hero-top">
            <div class="revenue-hero-main">
                <div class="revenue-hero-label">الايرادات المستردة</div>
                <div class="revenue-hero-value" id="heroRevenue">
                    <span class="revenue-number" id="revenueCounter">0</span>
                    <span class="revenue-currency">ر.س</span>
                </div>
                <div class="revenue-hero-narrative" id="heroNarrative">
                    استردت <strong>47</strong> سلة من اصل <strong>156</strong> هذا الشهر -- بمعدل <strong>30%</strong> وارتفاع <strong class="text-success">18%</strong> عن الشهر الماضي
                </div>
            </div>
            <div class="revenue-hero-badge">
                <div class="revenue-trend-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                </div>
                <span class="revenue-trend-text">+18%</span>
            </div>
        </div>

        <div class="revenue-chart-section">
            <div class="revenue-chart-label">ايرادات اخر 7 ايام</div>
            <div class="bar-chart" id="weeklyChart">
                <div class="bar-row">
                    <span class="bar-label">السبت</span>
                    <div class="bar-track"><div class="bar-fill" data-width="45" style="width: 0%"></div></div>
                    <span class="bar-val" data-val="1200">0</span>
                </div>
                <div class="bar-row">
                    <span class="bar-label">الاحد</span>
                    <div class="bar-track"><div class="bar-fill" data-width="62" style="width: 0%"></div></div>
                    <span class="bar-val" data-val="1680">0</span>
                </div>
                <div class="bar-row">
                    <span class="bar-label">الاثنين</span>
                    <div class="bar-track"><div class="bar-fill" data-width="38" style="width: 0%"></div></div>
                    <span class="bar-val" data-val="980">0</span>
                </div>
                <div class="bar-row">
                    <span class="bar-label">الثلاثاء</span>
                    <div class="bar-track"><div class="bar-fill" data-width="78" style="width: 0%"></div></div>
                    <span class="bar-val" data-val="2100">0</span>
                </div>
                <div class="bar-row">
                    <span class="bar-label">الاربعاء</span>
                    <div class="bar-track"><div class="bar-fill" data-width="55" style="width: 0%"></div></div>
                    <span class="bar-val" data-val="1480">0</span>
                </div>
                <div class="bar-row">
                    <span class="bar-label">الخميس</span>
                    <div class="bar-track"><div class="bar-fill" data-width="90" style="width: 0%"></div></div>
                    <span class="bar-val" data-val="2450">0</span>
                </div>
                <div class="bar-row">
                    <span class="bar-label">الجمعة</span>
                    <div class="bar-track"><div class="bar-fill" data-width="85" style="width: 0%"></div></div>
                    <span class="bar-val" data-val="2310">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. KPI Grid -->
    <div class="kpi-grid" id="kpiGrid">
        <div class="kpi-card">
            <div class="kpi-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                الرسائل المرسلة
            </div>
            <div class="kpi-value" id="kpiMsgSent">1,847</div>
            <div class="kpi-change up" id="kpiMsgChange">+12% عن الفترة السابقة</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                معدل التسليم
            </div>
            <div class="kpi-value text-success" id="kpiDelivery">97.8%</div>
            <div class="kpi-change up" id="kpiDeliveryChange">+1.2%</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                معدل القراءة
            </div>
            <div class="kpi-value text-primary" id="kpiRead">91%</div>
            <div class="kpi-change up" id="kpiReadChange">+3%</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                معدل النقر
            </div>
            <div class="kpi-value" id="kpiClick">24%</div>
            <div class="kpi-change up" id="kpiClickChange">+5%</div>
        </div>
    </div>

    <!-- 3. Channel Performance -->
    <div class="card" id="channelCard">
        <div class="card-header">
            <div>
                <div class="card-title">اداء القنوات</div>
                <div class="card-subtitle">مقارنة واتساب و SMS</div>
            </div>
        </div>
        <div class="channel-perf">
            <div class="channel-perf-row">
                <div class="channel-perf-item">
                    <div class="channel-header">
                        <span class="channel-indicator" style="background: var(--success);"></span>
                        <span class="channel-label">واتساب</span>
                        <span class="badge badge-success">الاساسية</span>
                    </div>
                    <div class="channel-metrics">
                        <div class="channel-metric">
                            <span class="channel-metric-val" id="waMessages">1,420</span>
                            <span class="channel-metric-label">رسالة</span>
                        </div>
                        <div class="channel-metric">
                            <span class="channel-metric-val" id="waDelivery">98%</span>
                            <span class="channel-metric-label">تسليم</span>
                        </div>
                        <div class="channel-metric">
                            <span class="channel-metric-val" id="waRead">91%</span>
                            <span class="channel-metric-label">قراءة</span>
                        </div>
                    </div>
                </div>
                <div class="channel-perf-item">
                    <div class="channel-header">
                        <span class="channel-indicator" style="background: var(--info);"></span>
                        <span class="channel-label">SMS</span>
                        <span class="badge badge-info">احتياطية</span>
                    </div>
                    <div class="channel-metrics">
                        <div class="channel-metric">
                            <span class="channel-metric-val" id="smsMessages">427</span>
                            <span class="channel-metric-label">رسالة</span>
                        </div>
                        <div class="channel-metric">
                            <span class="channel-metric-val" id="smsDelivery">96%</span>
                            <span class="channel-metric-label">تسليم</span>
                        </div>
                        <div class="channel-metric">
                            <span class="channel-metric-val" id="smsRead">--</span>
                            <span class="channel-metric-label">قراءة</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="channel-proportion">
                <div class="channel-proportion-label">توزيع الرسائل</div>
                <div class="channel-proportion-bar">
                    <div class="channel-proportion-fill channel-wa" id="waProportion" style="width: 77%;">
                        <span>77%</span>
                    </div>
                    <div class="channel-proportion-fill channel-sms" id="smsProportion" style="width: 23%;">
                        <span>23%</span>
                    </div>
                </div>
                <div class="channel-proportion-legend">
                    <div class="channel-legend-item">
                        <span class="channel-legend-dot" style="background: var(--success);"></span>
                        واتساب
                    </div>
                    <div class="channel-legend-item">
                        <span class="channel-legend-dot" style="background: var(--info);"></span>
                        SMS
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Recovery Timeline / Funnel -->
    <div class="card mt-24" id="funnelCard">
        <div class="card-header">
            <div>
                <div class="card-title">رحلة الاسترداد</div>
                <div class="card-subtitle">من السلة المتروكة الى الاسترداد الناجح</div>
            </div>
        </div>
        <div class="funnel-timeline" id="funnelTimeline">
            <div class="funnel-step funnel-step-1">
                <div class="funnel-step-bar"></div>
                <div class="funnel-step-content">
                    <div class="funnel-step-icon">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                    </div>
                    <div class="funnel-step-count" id="funnelAbandoned">156</div>
                    <div class="funnel-step-label">سلات متروكة</div>
                </div>
                <div class="funnel-connector">
                    <div class="funnel-connector-line"></div>
                    <div class="funnel-connector-arrow"></div>
                </div>
            </div>
            <div class="funnel-step funnel-step-2">
                <div class="funnel-step-bar"></div>
                <div class="funnel-step-content">
                    <div class="funnel-step-icon">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                    </div>
                    <div class="funnel-step-count" id="funnelSent">142</div>
                    <div class="funnel-step-label">رسالة اولى</div>
                    <div class="funnel-step-rate">91%</div>
                </div>
                <div class="funnel-connector">
                    <div class="funnel-connector-line"></div>
                    <div class="funnel-connector-arrow"></div>
                </div>
            </div>
            <div class="funnel-step funnel-step-3">
                <div class="funnel-step-bar"></div>
                <div class="funnel-step-content">
                    <div class="funnel-step-icon">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    </div>
                    <div class="funnel-step-count" id="funnelRead">128</div>
                    <div class="funnel-step-label">قراءة</div>
                    <div class="funnel-step-rate">90%</div>
                </div>
                <div class="funnel-connector">
                    <div class="funnel-connector-line"></div>
                    <div class="funnel-connector-arrow"></div>
                </div>
            </div>
            <div class="funnel-step funnel-step-4">
                <div class="funnel-step-bar"></div>
                <div class="funnel-step-content">
                    <div class="funnel-step-icon">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    </div>
                    <div class="funnel-step-count" id="funnelClicked">48</div>
                    <div class="funnel-step-label">نقر</div>
                    <div class="funnel-step-rate">38%</div>
                </div>
                <div class="funnel-connector">
                    <div class="funnel-connector-line"></div>
                    <div class="funnel-connector-arrow"></div>
                </div>
            </div>
            <div class="funnel-step funnel-step-5">
                <div class="funnel-step-bar"></div>
                <div class="funnel-step-content">
                    <div class="funnel-step-icon funnel-step-icon-final">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    </div>
                    <div class="funnel-step-count funnel-step-count-final" id="funnelRecovered">47</div>
                    <div class="funnel-step-label">استرداد</div>
                    <div class="funnel-step-rate funnel-rate-final">98%</div>
                </div>
            </div>
        </div>
        <div class="funnel-summary" id="funnelSummary">
            <div class="funnel-summary-item">
                <span class="funnel-summary-label">معدل الاسترداد الاجمالي</span>
                <span class="funnel-summary-val text-success" id="funnelTotalRate">30.1%</span>
            </div>
            <div class="funnel-summary-divider"></div>
            <div class="funnel-summary-item">
                <span class="funnel-summary-label">اكبر انخفاض</span>
                <span class="funnel-summary-val text-warning">قراءة &#8592; نقر (-62%)</span>
            </div>
        </div>
    </div>

    <!-- 5. Journey Performance Table -->
    <div class="card mt-24" id="journeyCard">
        <div class="card-header">
            <div>
                <div class="card-title">اداء الرحلات</div>
                <div class="card-subtitle">تفصيل كل رحلة تسويقية</div>
            </div>
            <a href="/platform/journeys.html" class="btn btn-ghost btn-sm">عرض الرحلات</a>
        </div>
        <div class="table-wrap">
            <table id="journeyTable">
                <thead>
                    <tr>
                        <th>الرحلة</th>
                        <th>مرسلة</th>
                        <th>تسليم</th>
                        <th>قراءة</th>
                        <th>نقر</th>
                        <th>تحويل</th>
                        <th>ايرادات</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <div class="journey-cell">
                                <span class="journey-cell-dot" style="background: var(--warning);"></span>
                                <strong>استرداد السلات</strong>
                            </div>
                        </td>
                        <td>542</td>
                        <td><span class="rate-pill rate-high">98%</span></td>
                        <td><span class="rate-pill rate-high">89%</span></td>
                        <td><span class="rate-pill rate-mid">34%</span></td>
                        <td><span class="rate-pill rate-high">30%</span></td>
                        <td><strong class="text-success">8,450 ر.س</strong></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="journey-cell">
                                <span class="journey-cell-dot" style="background: var(--info);"></span>
                                <strong>رحلة الترحيب</strong>
                            </div>
                        </td>
                        <td>267</td>
                        <td><span class="rate-pill rate-high">99%</span></td>
                        <td><span class="rate-pill rate-high">94%</span></td>
                        <td><span class="rate-pill rate-mid">28%</span></td>
                        <td><span class="rate-pill rate-low">12%</span></td>
                        <td><strong>2,100 ر.س</strong></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="journey-cell">
                                <span class="journey-cell-dot" style="background: var(--success);"></span>
                                <strong>متابعة بعد الشراء</strong>
                            </div>
                        </td>
                        <td>389</td>
                        <td><span class="rate-pill rate-high">98%</span></td>
                        <td><span class="rate-pill rate-high">92%</span></td>
                        <td><span class="rate-pill rate-low">18%</span></td>
                        <td><span class="rate-pill rate-low">8%</span></td>
                        <td><strong>1,900 ر.س</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 6. Segment Performance Grid -->
    <div class="card mt-24" id="segmentCard">
        <div class="card-header">
            <div>
                <div class="card-title">اداء الشرائح</div>
                <div class="card-subtitle">الايرادات حسب شريحة العملاء</div>
            </div>
            <a href="/platform/segments.html" class="btn btn-ghost btn-sm">عرض الشرائح</a>
        </div>
        <div class="segment-grid" id="segmentGrid">
            <div class="segment-card segment-champions">
                <div class="segment-card-header">
                    <span class="segment-icon">&#9733;</span>
                    <span class="segment-name">ابطال</span>
                </div>
                <div class="segment-revenue">4,200 ر.س</div>
                <div class="segment-count">156 عميل</div>
                <div class="segment-bar-wrap">
                    <div class="segment-bar" style="width: 85%; background: var(--success);"></div>
                </div>
            </div>
            <div class="segment-card segment-loyal">
                <div class="segment-card-header">
                    <span class="segment-icon">&#9830;</span>
                    <span class="segment-name">اوفياء</span>
                </div>
                <div class="segment-revenue">3,890 ر.س</div>
                <div class="segment-count">312 عميل</div>
                <div class="segment-bar-wrap">
                    <div class="segment-bar" style="width: 75%; background: var(--primary);"></div>
                </div>
            </div>
            <div class="segment-card segment-potential">
                <div class="segment-card-header">
                    <span class="segment-icon">&#9650;</span>
                    <span class="segment-name">محتملين</span>
                </div>
                <div class="segment-revenue">2,450 ر.س</div>
                <div class="segment-count">245 عميل</div>
                <div class="segment-bar-wrap">
                    <div class="segment-bar" style="width: 55%; background: var(--info);"></div>
                </div>
            </div>
            <div class="segment-card segment-new">
                <div class="segment-card-header">
                    <span class="segment-icon">&#43;</span>
                    <span class="segment-name">جدد</span>
                </div>
                <div class="segment-revenue">1,200 ر.س</div>
                <div class="segment-count">189 عميل</div>
                <div class="segment-bar-wrap">
                    <div class="segment-bar" style="width: 35%; background: #8B5CF6;"></div>
                </div>
            </div>
            <div class="segment-card segment-atrisk">
                <div class="segment-card-header">
                    <span class="segment-icon">&#9888;</span>
                    <span class="segment-name">معرضين</span>
                </div>
                <div class="segment-revenue text-warning">580 ر.س</div>
                <div class="segment-count">134 عميل</div>
                <div class="segment-bar-wrap">
                    <div class="segment-bar" style="width: 18%; background: var(--warning);"></div>
                </div>
            </div>
            <div class="segment-card segment-lost">
                <div class="segment-card-header">
                    <span class="segment-icon">&#8943;</span>
                    <span class="segment-name">غائبين</span>
                </div>
                <div class="segment-revenue text-danger">130 ر.س</div>
                <div class="segment-count">211 عميل</div>
                <div class="segment-bar-wrap">
                    <div class="segment-bar" style="width: 8%; background: var(--danger);"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* ============================================
       REVENUE STORY HERO
       ============================================ */
    .revenue-hero {
        background: var(--bg-card);
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
        margin-bottom: 24px;
    }
    .revenue-hero::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        left: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--success), var(--primary));
    }

    .revenue-hero-top {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        margin-bottom: 28px;
    }

    .revenue-hero-label {
        font-size: 14px;
        color: var(--text-dim);
        font-weight: 500;
        margin-bottom: 8px;
    }

    .revenue-hero-value {
        display: flex;
        align-items: baseline;
        gap: 8px;
        margin-bottom: 14px;
    }

    .revenue-number {
        font-size: 48px;
        font-weight: 800;
        line-height: 1;
        background: linear-gradient(135deg, #22C55E, #FBBF24);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .revenue-currency {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-dim);
    }

    .revenue-hero-narrative {
        font-size: 15px;
        color: var(--text-muted);
        line-height: 1.8;
        max-width: 600px;
    }
    .revenue-hero-narrative strong {
        color: var(--text);
        font-weight: 700;
    }

    .revenue-hero-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: var(--success-subtle);
        border: 1px solid rgba(34, 197, 94, 0.15);
        border-radius: var(--radius-md);
        flex-shrink: 0;
    }
    .revenue-trend-icon {
        color: var(--success);
        display: flex;
    }
    .revenue-trend-text {
        font-size: 18px;
        font-weight: 800;
        color: var(--success);
    }

    .revenue-chart-section {
        padding-top: 24px;
        border-top: 1px solid var(--border);
    }
    .revenue-chart-label {
        font-size: 13px;
        color: var(--text-faint);
        margin-bottom: 16px;
        font-weight: 500;
    }

    /* Bar Chart */
    .bar-chart {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .bar-row {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .bar-label {
        font-size: 13px;
        color: var(--text-dim);
        width: 60px;
        text-align: left;
        flex-shrink: 0;
    }
    .bar-track {
        flex: 1;
        height: 28px;
        background: var(--bg-hover);
        border-radius: 6px;
        overflow: hidden;
        position: relative;
    }
    .bar-fill {
        height: 100%;
        background: linear-gradient(135deg, var(--primary), var(--primary-hover));
        border-radius: 6px;
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }
    .bar-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 50%;
        background: linear-gradient(180deg, rgba(255,255,255,0.08), transparent);
        border-radius: 6px 6px 0 0;
    }
    .bar-val {
        font-size: 13px;
        font-weight: 700;
        width: 60px;
        text-align: right;
        flex-shrink: 0;
        color: var(--text-secondary);
    }

    /* Period Tabs inline */
    .period-tabs {
        border-bottom: none;
        margin-bottom: 0;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 4px;
        gap: 2px;
    }
    .period-tabs .tab {
        border-bottom: none;
        border-radius: var(--radius-sm);
        padding: 6px 14px;
        font-size: 13px;
    }
    .period-tabs .tab.active {
        background: var(--primary-subtle);
        color: var(--primary);
        border-bottom-color: transparent;
    }

    /* ============================================
       CHANNEL PERFORMANCE
       ============================================ */
    .channel-perf {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }
    .channel-perf-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    .channel-perf-item {
        padding: 20px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
    }
    .channel-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 16px;
    }
    .channel-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
    }
    .channel-label {
        font-size: 16px;
        font-weight: 700;
    }
    .channel-metrics {
        display: flex;
        gap: 20px;
    }
    .channel-metric {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .channel-metric-val {
        font-size: 20px;
        font-weight: 800;
        color: var(--text);
    }
    .channel-metric-label {
        font-size: 12px;
        color: var(--text-faint);
    }

    .channel-proportion {
        padding-top: 4px;
    }
    .channel-proportion-label {
        font-size: 13px;
        color: var(--text-dim);
        margin-bottom: 10px;
    }
    .channel-proportion-bar {
        display: flex;
        height: 32px;
        border-radius: var(--radius-sm);
        overflow: hidden;
        background: var(--bg-hover);
    }
    .channel-proportion-fill {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 700;
        transition: width 0.6s ease;
    }
    .channel-wa {
        background: linear-gradient(135deg, var(--success), #16A34A);
        color: #fff;
    }
    .channel-sms {
        background: linear-gradient(135deg, var(--info), #2563EB);
        color: #fff;
    }
    .channel-proportion-legend {
        display: flex;
        gap: 20px;
        margin-top: 10px;
    }
    .channel-legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: var(--text-muted);
    }
    .channel-legend-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    /* ============================================
       RECOVERY FUNNEL / TIMELINE
       ============================================ */
    .funnel-timeline {
        display: flex;
        align-items: flex-start;
        justify-content: center;
        gap: 0;
        padding: 20px 0 12px;
        overflow-x: auto;
    }

    .funnel-step {
        display: flex;
        align-items: center;
        flex-shrink: 0;
    }

    .funnel-step-bar {
        display: none;
    }

    .funnel-step-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        min-width: 100px;
        position: relative;
    }

    .funnel-step-icon {
        width: 52px;
        height: 52px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 12px;
        position: relative;
        z-index: 2;
        transition: transform 0.3s, box-shadow 0.3s;
    }
    .funnel-step-icon:hover {
        transform: scale(1.1);
    }

    .funnel-step-1 .funnel-step-icon {
        background: rgba(239, 68, 68, 0.12);
        border: 2px solid rgba(239, 68, 68, 0.3);
        color: var(--danger);
    }
    .funnel-step-2 .funnel-step-icon {
        background: rgba(251, 191, 36, 0.12);
        border: 2px solid rgba(251, 191, 36, 0.3);
        color: var(--primary);
    }
    .funnel-step-3 .funnel-step-icon {
        background: rgba(59, 130, 246, 0.12);
        border: 2px solid rgba(59, 130, 246, 0.3);
        color: var(--info);
    }
    .funnel-step-4 .funnel-step-icon {
        background: rgba(139, 92, 246, 0.12);
        border: 2px solid rgba(139, 92, 246, 0.3);
        color: #8B5CF6;
    }
    .funnel-step-5 .funnel-step-icon {
        background: rgba(34, 197, 94, 0.15);
        border: 2px solid rgba(34, 197, 94, 0.4);
        color: var(--success);
        box-shadow: 0 0 20px rgba(34, 197, 94, 0.15);
    }
    .funnel-step-icon-final {
        width: 60px !important;
        height: 60px !important;
    }

    .funnel-step-count {
        font-size: 26px;
        font-weight: 800;
        color: var(--text);
        line-height: 1;
        margin-bottom: 4px;
    }
    .funnel-step-count-final {
        font-size: 30px;
        color: var(--success);
    }

    .funnel-step-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-muted);
        margin-bottom: 4px;
    }

    .funnel-step-rate {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-faint);
        background: var(--bg-hover);
        padding: 2px 8px;
        border-radius: 10px;
    }
    .funnel-rate-final {
        background: var(--success-subtle);
        color: var(--success);
    }

    /* Connector arrows between steps */
    .funnel-connector {
        display: flex;
        align-items: center;
        padding: 0 6px;
        margin-top: -40px;
        position: relative;
    }
    .funnel-connector-line {
        width: 40px;
        height: 2px;
        background: linear-gradient(90deg, var(--border-hover), var(--border));
        position: relative;
    }
    .funnel-connector-line::before {
        content: '';
        position: absolute;
        top: -2px;
        left: 0;
        right: 0;
        height: 6px;
        background: linear-gradient(90deg, rgba(251, 191, 36, 0.15), transparent);
        border-radius: 3px;
    }
    .funnel-connector-arrow {
        width: 0;
        height: 0;
        border-top: 6px solid transparent;
        border-bottom: 6px solid transparent;
        border-right: 8px solid var(--border-hover);
        flex-shrink: 0;
    }

    /* Funnel Summary Bar */
    .funnel-summary {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 24px;
        margin-top: 16px;
        padding: 16px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
    }
    .funnel-summary-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .funnel-summary-label {
        font-size: 13px;
        color: var(--text-dim);
    }
    .funnel-summary-val {
        font-size: 15px;
        font-weight: 700;
    }
    .funnel-summary-divider {
        width: 1px;
        height: 24px;
        background: var(--border);
    }

    /* ============================================
       JOURNEY TABLE
       ============================================ */
    .journey-cell {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .journey-cell-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .rate-pill {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
    }
    .rate-high {
        background: var(--success-subtle);
        color: var(--success);
    }
    .rate-mid {
        background: var(--warning-subtle);
        color: var(--warning);
    }
    .rate-low {
        background: var(--danger-subtle);
        color: var(--danger);
    }

    /* ============================================
       SEGMENT GRID
       ============================================ */
    .segment-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }
    .segment-card {
        padding: 20px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        transition: border-color 0.2s, transform 0.2s;
    }
    .segment-card:hover {
        border-color: var(--border-hover);
        transform: translateY(-2px);
    }

    .segment-card-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
    }
    .segment-icon {
        font-size: 16px;
        opacity: 0.8;
    }
    .segment-name {
        font-size: 14px;
        font-weight: 700;
        color: var(--text-secondary);
    }
    .segment-revenue {
        font-size: 22px;
        font-weight: 800;
        color: var(--text);
        margin-bottom: 4px;
    }
    .segment-count {
        font-size: 12px;
        color: var(--text-faint);
        margin-bottom: 12px;
    }
    .segment-bar-wrap {
        height: 4px;
        background: var(--bg-hover);
        border-radius: 2px;
        overflow: hidden;
    }
    .segment-bar {
        height: 100%;
        border-radius: 2px;
        transition: width 0.6s ease;
    }

    /* Segment color accents */
    .segment-champions { border-top: 2px solid var(--success); }
    .segment-loyal { border-top: 2px solid var(--primary); }
    .segment-potential { border-top: 2px solid var(--info); }
    .segment-new { border-top: 2px solid #8B5CF6; }
    .segment-atrisk { border-top: 2px solid var(--warning); }
    .segment-lost { border-top: 2px solid var(--danger); }

    /* ============================================
       ANIMATIONS
       ============================================ */
    @keyframes countUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideInRight {
        from { opacity: 0; transform: translateX(20px); }
        to { opacity: 1; transform: translateX(0); }
    }

    .funnel-step {
        animation: slideInRight 0.4s ease both;
    }
    .funnel-step-1 { animation-delay: 0.1s; }
    .funnel-step-2 { animation-delay: 0.2s; }
    .funnel-step-3 { animation-delay: 0.3s; }
    .funnel-step-4 { animation-delay: 0.4s; }
    .funnel-step-5 { animation-delay: 0.5s; }

    /* ============================================
       RESPONSIVE
       ============================================ */
    @media (max-width: 1024px) {
        .funnel-connector-line { width: 24px; }
        .funnel-step-content { min-width: 80px; }
        .funnel-step-count { font-size: 22px; }
        .segment-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
        .revenue-hero-top {
            flex-direction: column;
            gap: 16px;
        }
        .revenue-number {
            font-size: 36px;
        }
        .channel-perf-row {
            grid-template-columns: 1fr;
        }
        .funnel-timeline {
            flex-direction: column;
            align-items: center;
            gap: 0;
        }
        .funnel-step {
            flex-direction: column;
        }
        .funnel-connector {
            transform: rotate(90deg);
            margin-top: 0;
            padding: 4px 0;
        }
        .funnel-step-content {
            min-width: auto;
        }
        .funnel-summary {
            flex-direction: column;
            gap: 12px;
        }
        .funnel-summary-divider {
            width: 100%;
            height: 1px;
        }
        .segment-grid {
            grid-template-columns: 1fr 1fr;
        }
        .period-tabs {
            width: 100%;
            justify-content: center;
        }
        .channel-proportion-fill span {
            font-size: 11px;
        }
    }

    @media (max-width: 480px) {
        .segment-grid {
            grid-template-columns: 1fr;
        }
        .channel-metrics {
            flex-wrap: wrap;
            gap: 12px;
        }
    }
</style>

<script src="/platform/shared/shell.js"></script>
<script>
(function() {
    // ========================================
    // Sample / Fallback Data
    // ========================================
    var sampleData = {
        revenue: 12450,
        recoveredCarts: 47,
        totalCarts: 156,
        recoveryRate: 30,
        recoveryChange: 18,
        messagesSent: 1847,
        messagesChange: 12,
        deliveryRate: 97.8,
        deliveryChange: 1.2,
        readRate: 91,
        readChange: 3,
        clickRate: 24,
        clickChange: 5,
        weeklyRevenue: [
            { day: 'السبت', value: 1200, pct: 45 },
            { day: 'الاحد', value: 1680, pct: 62 },
            { day: 'الاثنين', value: 980, pct: 38 },
            { day: 'الثلاثاء', value: 2100, pct: 78 },
            { day: 'الاربعاء', value: 1480, pct: 55 },
            { day: 'الخميس', value: 2450, pct: 90 },
            { day: 'الجمعة', value: 2310, pct: 85 }
        ],
        whatsapp: { messages: 1420, delivery: 98, read: 91 },
        sms: { messages: 427, delivery: 96, read: null },
        funnel: {
            abandoned: 156,
            sent: 142,
            read: 128,
            clicked: 48,
            recovered: 47
        },
        journeys: [
            { name: 'استرداد السلات', sent: 542, delivery: 98, read: 89, click: 34, conversion: 30, revenue: 8450 },
            { name: 'رحلة الترحيب', sent: 267, delivery: 99, read: 94, click: 28, conversion: 12, revenue: 2100 },
            { name: 'متابعة بعد الشراء', sent: 389, delivery: 98, read: 92, click: 18, conversion: 8, revenue: 1900 }
        ],
        segments: [
            { name: 'ابطال', revenue: 4200, customers: 156 },
            { name: 'اوفياء', revenue: 3890, customers: 312 },
            { name: 'محتملين', revenue: 2450, customers: 245 },
            { name: 'جدد', revenue: 1200, customers: 189 },
            { name: 'معرضين', revenue: 580, customers: 134 },
            { name: 'غائبين', revenue: 130, customers: 211 }
        ]
    };

    // ========================================
    // Revenue Counter Animation
    // ========================================
    function animateCounter(el, target, duration, suffix) {
        if (!el) return;
        var start = 0;
        var startTime = null;
        suffix = suffix || '';

        function step(timestamp) {
            if (!startTime) startTime = timestamp;
            var progress = Math.min((timestamp - startTime) / duration, 1);
            var eased = 1 - Math.pow(1 - progress, 3);
            var current = Math.floor(eased * target);
            el.textContent = current.toLocaleString('ar-SA') + suffix;
            if (progress < 1) {
                requestAnimationFrame(step);
            } else {
                el.textContent = target.toLocaleString('ar-SA') + suffix;
            }
        }
        requestAnimationFrame(step);
    }

    // ========================================
    // Bar Chart Animation
    // ========================================
    function animateBars() {
        var fills = document.querySelectorAll('.bar-fill');
        var vals = document.querySelectorAll('.bar-val');
        fills.forEach(function(fill, i) {
            var targetWidth = fill.getAttribute('data-width');
            setTimeout(function() {
                fill.style.width = targetWidth + '%';
            }, 100 + (i * 80));
        });
        vals.forEach(function(val) {
            var target = parseInt(val.getAttribute('data-val'), 10);
            if (target) {
                animateCounter(val, target, 800, '');
            }
        });
    }

    // ========================================
    // Period Tab Switching
    // ========================================
    function bindPeriodTabs() {
        var tabs = document.querySelectorAll('#periodTabs .tab');
        tabs.forEach(function(tab) {
            tab.addEventListener('click', function() {
                tabs.forEach(function(t) { t.classList.remove('active'); });
                this.classList.add('active');
                // In production: reload data for selected period
                // var period = this.getAttribute('data-period');
                // loadAnalytics(period);
            });
        });
    }

    // ========================================
    // Apply Data to DOM
    // ========================================
    function applyData(data) {
        // Revenue hero
        var counterEl = document.getElementById('revenueCounter');
        animateCounter(counterEl, data.revenue || 12450, 1500);

        // Narrative
        var narr = document.getElementById('heroNarrative');
        if (narr && data.recoveredCarts !== undefined) {
            narr.innerHTML = 'استردت <strong>' + data.recoveredCarts + '</strong> سلة من اصل <strong>' + data.totalCarts + '</strong> هذا الشهر -- بمعدل <strong>' + data.recoveryRate + '%</strong> وارتفاع <strong class="text-success">' + data.recoveryChange + '%</strong> عن الشهر الماضي';
        }

        // KPIs
        setTextIfExists('kpiMsgSent', formatNum(data.messagesSent));
        setTextIfExists('kpiDelivery', data.deliveryRate + '%');
        setTextIfExists('kpiRead', data.readRate + '%');
        setTextIfExists('kpiClick', data.clickRate + '%');

        if (data.messagesChange !== undefined) {
            updateChange('kpiMsgChange', data.messagesChange, ' عن الفترة السابقة');
        }
        if (data.deliveryChange !== undefined) {
            updateChange('kpiDeliveryChange', data.deliveryChange, '');
        }
        if (data.readChange !== undefined) {
            updateChange('kpiReadChange', data.readChange, '');
        }
        if (data.clickChange !== undefined) {
            updateChange('kpiClickChange', data.clickChange, '');
        }

        // Channel
        setTextIfExists('waMessages', formatNum(data.whatsapp.messages));
        setTextIfExists('waDelivery', data.whatsapp.delivery + '%');
        setTextIfExists('waRead', data.whatsapp.read + '%');
        setTextIfExists('smsMessages', formatNum(data.sms.messages));
        setTextIfExists('smsDelivery', data.sms.delivery + '%');
        setTextIfExists('smsRead', data.sms.read ? data.sms.read + '%' : '--');

        var totalMsgs = data.whatsapp.messages + data.sms.messages;
        var waPct = Math.round((data.whatsapp.messages / totalMsgs) * 100);
        var smsPct = 100 - waPct;
        var waBar = document.getElementById('waProportion');
        var smsBar = document.getElementById('smsProportion');
        if (waBar) { waBar.style.width = waPct + '%'; waBar.querySelector('span').textContent = waPct + '%'; }
        if (smsBar) { smsBar.style.width = smsPct + '%'; smsBar.querySelector('span').textContent = smsPct + '%'; }

        // Funnel
        setTextIfExists('funnelAbandoned', formatNum(data.funnel.abandoned));
        setTextIfExists('funnelSent', formatNum(data.funnel.sent));
        setTextIfExists('funnelRead', formatNum(data.funnel.read));
        setTextIfExists('funnelClicked', formatNum(data.funnel.clicked));
        setTextIfExists('funnelRecovered', formatNum(data.funnel.recovered));

        var totalRate = data.funnel.abandoned > 0 ? Math.round((data.funnel.recovered / data.funnel.abandoned) * 1000) / 10 : 0;
        setTextIfExists('funnelTotalRate', totalRate + '%');

        // Animate bars
        animateBars();
    }

    // ========================================
    // Helpers
    // ========================================
    function formatNum(n) {
        if (n === null || n === undefined) return '--';
        return n.toLocaleString('ar-SA');
    }

    function setTextIfExists(id, text) {
        var el = document.getElementById(id);
        if (el) el.textContent = text;
    }

    function updateChange(id, val, suffix) {
        var el = document.getElementById(id);
        if (!el) return;
        var isUp = val >= 0;
        el.className = 'kpi-change ' + (isUp ? 'up' : 'down');
        el.textContent = (isUp ? '+' : '') + val + '%' + (suffix || '');
    }

    // ========================================
    // Load data from API or fallback
    // ========================================
    function loadAnalytics() {
        bindPeriodTabs();

        if (typeof RibhShell !== 'undefined' && RibhShell.api) {
            RibhShell.api('/api/analytics/v2').then(function(data) {
                if (data && !data.error) {
                    // Map API response to our data shape
                    var mapped = {
                        revenue: data.recoveredRevenue || data.revenue || sampleData.revenue,
                        recoveredCarts: data.recoveredCarts || sampleData.recoveredCarts,
                        totalCarts: data.totalCarts || data.abandonedCarts || sampleData.totalCarts,
                        recoveryRate: data.recoveryRate || sampleData.recoveryRate,
                        recoveryChange: data.recoveryChange || sampleData.recoveryChange,
                        messagesSent: data.messagesSent || sampleData.messagesSent,
                        messagesChange: data.messagesChange !== undefined ? data.messagesChange : sampleData.messagesChange,
                        deliveryRate: data.deliveryRate || sampleData.deliveryRate,
                        deliveryChange: data.deliveryChange !== undefined ? data.deliveryChange : sampleData.deliveryChange,
                        readRate: data.readRate || sampleData.readRate,
                        readChange: data.readChange !== undefined ? data.readChange : sampleData.readChange,
                        clickRate: data.clickRate || sampleData.clickRate,
                        clickChange: data.clickChange !== undefined ? data.clickChange : sampleData.clickChange,
                        whatsapp: data.whatsapp || sampleData.whatsapp,
                        sms: data.sms || sampleData.sms,
                        funnel: data.funnel || sampleData.funnel,
                        journeys: data.journeys || sampleData.journeys,
                        segments: data.segments || sampleData.segments
                    };
                    applyData(mapped);
                } else {
                    applyData(sampleData);
                }
            }).catch(function() {
                applyData(sampleData);
            });
        } else {
            applyData(sampleData);
        }
    }

    // ========================================
    // Init
    // ========================================
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadAnalytics);
    } else {
        loadAnalytics();
    }
})();
</script>

</body>
</html>
