<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø­Ù…Ù„Ø§Øª | Ø±ÙØ¨Ø­</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/platform/shared/shell.css">
</head>
<body>

<div id="page-content">
    <!-- Page Header -->
    <div class="page-header" style="display: flex; align-items: flex-start; justify-content: space-between;">
        <div>
            <h1 class="page-title">Ø§Ù„Ø­Ù…Ù„Ø§Øª</h1>
            <p class="page-subtitle">Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø´Ø±Ø§Ø¦Ø­ Ù…Ø­Ø¯Ø¯Ø©</p>
        </div>
        <button class="btn btn-primary" onclick="openCreateModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
        </button>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="campaignTabs">
        <button class="tab active" data-filter="all">Ø§Ù„ÙƒÙ„ <span class="text-dim">(4)</span></button>
        <button class="tab" data-filter="sent">Ù…Ø±Ø³Ù„Ø© <span class="text-dim">(2)</span></button>
        <button class="tab" data-filter="scheduled">Ù…Ø¬Ø¯ÙˆÙ„Ø© <span class="text-dim">(1)</span></button>
        <button class="tab" data-filter="draft">Ù…Ø³ÙˆØ¯Ø© <span class="text-dim">(1)</span></button>
    </div>

    <!-- Campaign Cards List -->
    <div id="campaignsList"></div>
</div>

<!-- Create Campaign Modal -->
<div class="modal-overlay" id="createModal">
    <div class="modal" style="max-width: 580px;">
        <div class="modal-header">
            <div>
                <div class="modal-title" id="modalTitle">Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
                <div style="font-size: 13px; color: var(--text-dim); margin-top: 4px;" id="modalStep">Ø§Ù„Ø®Ø·ÙˆØ© 1 Ù…Ù† 5</div>
            </div>
            <button class="modal-close" onclick="closeCreateModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Steps rendered by JS -->
        </div>
        <div class="modal-footer" style="justify-content: space-between;">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" id="modalNext" onclick="nextStep()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                <button class="btn btn-secondary" id="modalBack" onclick="prevStep()" style="display: none;">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            </div>
            <button class="btn btn-ghost" onclick="closeCreateModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Campaign Report Modal -->
<div class="modal-overlay" id="reportModal">
    <div class="modal" style="max-width: 620px;">
        <div class="modal-header">
            <div class="modal-title" id="reportTitle">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ù…Ù„Ø©</div>
            <button class="modal-close" onclick="closeReportModal()">&times;</button>
        </div>
        <div class="modal-body" id="reportBody"></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeReportModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
</div>

<style>
    /* Campaign card â€” full width stacked list */
    .campaign-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 20px 24px;
        margin-bottom: 12px;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
    }
    .campaign-card:hover {
        border-color: var(--border-hover);
    }

    /* Left colored border */
    .campaign-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 4px;
        border-radius: 0 var(--radius-lg) var(--radius-lg) 0;
    }
    .campaign-card.status-sent::before { background: var(--success); }
    .campaign-card.status-scheduled::before { background: var(--info); }
    .campaign-card.status-draft::before { background: var(--text-faint); }

    /* Card top row: name + status */
    .campaign-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 14px;
    }
    .campaign-name-wrap {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .campaign-name {
        font-size: 16px;
        font-weight: 700;
    }

    /* Metrics row */
    .campaign-metrics {
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
        margin-bottom: 14px;
        padding: 14px 0;
        border-top: 1px solid var(--border);
        border-bottom: 1px solid var(--border);
    }
    .campaign-metric {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 70px;
    }
    .campaign-metric-value {
        font-size: 18px;
        font-weight: 800;
        line-height: 1;
    }
    .campaign-metric-label {
        font-size: 11px;
        color: var(--text-faint);
        margin-top: 4px;
    }
    .campaign-metric-value.revenue {
        color: var(--primary);
    }

    /* Bottom row: tags + actions */
    .campaign-bottom {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 10px;
    }
    .campaign-tags {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }
    .campaign-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        background: rgba(255, 255, 255, 0.04);
        color: var(--text-dim);
        border: 1px solid var(--border);
    }
    .campaign-tag svg {
        width: 12px;
        height: 12px;
        opacity: 0.6;
    }
    .campaign-actions {
        display: flex;
        gap: 6px;
        align-items: center;
    }

    /* Scheduled info banner */
    .campaign-scheduled-info {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: var(--info-subtle);
        border-radius: var(--radius-sm);
        margin-bottom: 14px;
        font-size: 13px;
        color: var(--info);
    }
    .campaign-scheduled-info svg {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
    }

    /* Draft info */
    .campaign-draft-info {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: var(--radius-sm);
        margin-bottom: 14px;
        font-size: 13px;
        color: var(--text-dim);
    }

    /* Modal steps */
    .step-content { display: none; }
    .step-content.active { display: block; }

    /* Step indicator */
    .step-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 24px;
    }
    .step-dot-nav {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--bg-hover);
        border: 2px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 700;
        color: var(--text-dim);
        transition: all 0.2s;
        flex-shrink: 0;
    }
    .step-dot-nav.active {
        background: var(--primary);
        border-color: var(--primary);
        color: #0a0a0a;
    }
    .step-dot-nav.completed {
        background: var(--success);
        border-color: var(--success);
        color: #fff;
    }
    .step-line-nav {
        flex: 1;
        height: 2px;
        background: var(--border);
        min-width: 16px;
    }
    .step-line-nav.completed {
        background: var(--success);
    }

    /* Channel choice chips */
    .channel-choices {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .channel-chip {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 14px 20px;
        background: var(--bg-elevated);
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-muted);
        flex: 1;
        min-width: 120px;
        justify-content: center;
    }
    .channel-chip:hover {
        border-color: var(--border-hover);
        color: var(--text);
    }
    .channel-chip.selected {
        border-color: var(--primary);
        background: var(--primary-subtle);
        color: var(--primary);
    }

    /* Segment dropdown styled */
    .segment-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .segment-option {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        background: var(--bg-elevated);
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
        font-size: 14px;
        color: var(--text-secondary);
    }
    .segment-option:hover {
        border-color: var(--border-hover);
    }
    .segment-option.selected {
        border-color: var(--primary);
        background: var(--primary-subtle);
        color: var(--primary);
    }
    .segment-option-count {
        font-size: 12px;
        color: var(--text-dim);
        font-weight: 600;
    }

    /* Message textarea area */
    .message-area {
        position: relative;
    }
    .message-area textarea {
        min-height: 120px;
        padding-bottom: 40px;
    }
    .ai-assist-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 10px;
    }
    .ai-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(251, 191, 36, 0.15));
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: var(--radius-sm);
        color: #A78BFA;
        font-size: 13px;
        font-weight: 600;
        font-family: inherit;
        cursor: pointer;
        transition: all 0.2s;
    }
    .ai-btn:hover {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.25), rgba(251, 191, 36, 0.25));
    }
    .ai-btn svg {
        width: 14px;
        height: 14px;
    }
    .char-count {
        font-size: 12px;
        color: var(--text-faint);
    }

    /* Schedule options */
    .schedule-options {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
    }
    .schedule-chip {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 20px 16px;
        background: var(--bg-elevated);
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
        text-align: center;
    }
    .schedule-chip:hover {
        border-color: var(--border-hover);
    }
    .schedule-chip.selected {
        border-color: var(--primary);
        background: var(--primary-subtle);
    }
    .schedule-chip-icon {
        font-size: 24px;
    }
    .schedule-chip-title {
        font-size: 14px;
        font-weight: 700;
        color: var(--text);
    }
    .schedule-chip-desc {
        font-size: 12px;
        color: var(--text-dim);
    }
    .schedule-datetime {
        display: none;
        margin-top: 16px;
    }
    .schedule-datetime.visible {
        display: block;
    }
    .schedule-datetime .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    /* Summary */
    .summary-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
    }
    .summary-row:last-child {
        border-bottom: none;
    }
    .summary-label {
        color: var(--text-dim);
    }
    .summary-value {
        font-weight: 600;
        color: var(--text);
    }

    /* AI loading animation */
    .ai-loading {
        display: inline-flex;
        gap: 4px;
        align-items: center;
    }
    .ai-loading span {
        width: 6px;
        height: 6px;
        background: #A78BFA;
        border-radius: 50%;
        animation: aiBounce 1.2s ease-in-out infinite;
    }
    .ai-loading span:nth-child(2) { animation-delay: 0.2s; }
    .ai-loading span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes aiBounce {
        0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
        40% { transform: scale(1); opacity: 1; }
    }

    /* Report modal stats */
    .report-kpis {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }
    .report-kpi {
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 16px;
        text-align: center;
    }
    .report-kpi-value {
        font-size: 24px;
        font-weight: 800;
    }
    .report-kpi-label {
        font-size: 12px;
        color: var(--text-dim);
        margin-top: 4px;
    }
    .report-bar-wrap {
        margin-bottom: 12px;
    }
    .report-bar-label {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        margin-bottom: 6px;
    }
    .report-bar-label span:first-child { color: var(--text-muted); }
    .report-bar-label span:last-child { font-weight: 700; }
    .report-bar {
        height: 8px;
        background: var(--bg-hover);
        border-radius: 4px;
        overflow: hidden;
    }
    .report-bar-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.6s ease;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .campaign-metrics {
            gap: 16px;
        }
        .campaign-metric {
            min-width: 60px;
        }
        .campaign-top {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
        .campaign-bottom {
            flex-direction: column;
            align-items: flex-start;
        }
        .report-kpis {
            grid-template-columns: 1fr 1fr;
        }
        .schedule-options {
            flex-direction: column;
        }
    }

    @media (max-width: 480px) {
        .campaign-metrics {
            gap: 12px;
        }
        .channel-choices {
            flex-direction: column;
        }
        .report-kpis {
            grid-template-columns: 1fr;
        }
    }
</style>

<script src="/platform/shared/shell.js"></script>
<script>
(function() {
    'use strict';

    // ========================================
    // Campaign Data
    // ========================================
    var campaigns = [
        {
            id: 'c1',
            name: 'Ø¹Ø±Ø¶ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ \uD83D\uDD25',
            status: 'sent',
            statusLabel: 'Ù…Ø±Ø³Ù„Ø©',
            segment: 'Ø§Ù„ÙƒÙ„',
            channel: 'ÙˆØ§ØªØ³Ø§Ø¨',
            sent: 1247,
            delivered: 98,
            read: 89,
            clicked: 23,
            revenue: 4560,
            date: '2026-02-07',
            message: 'Ù…Ø±Ø­Ø¨Ø§! Ø¹Ù†Ø¯Ù†Ø§ Ø¹Ø±Ø¶ Ø®Ø§Øµ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ - Ø®ØµÙ… 25% Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª. Ù„Ø§ ÙŠÙÙˆØªÙƒ!'
        },
        {
            id: 'c2',
            name: 'Ø®ØµÙ… Ø§Ù„Ø£ÙˆÙÙŠØ§Ø¡ \uD83D\uDC8E',
            status: 'sent',
            statusLabel: 'Ù…Ø±Ø³Ù„Ø©',
            segment: 'Ø£ÙˆÙÙŠØ§Ø¡',
            channel: 'ÙˆØ§ØªØ³Ø§Ø¨',
            sent: 312,
            delivered: 99,
            read: 94,
            clicked: 31,
            revenue: 2890,
            date: '2026-02-05',
            message: 'Ù„Ø£Ù†Ùƒ Ù…Ù† Ø¹Ù…Ù„Ø§Ø¦Ù†Ø§ Ø§Ù„Ù…Ù…ÙŠØ²ÙŠÙ†ØŒ Ø¬Ù‡Ø²Ù†Ø§ Ù„Ùƒ Ø®ØµÙ… Ø­ØµØ±ÙŠ 30% Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø¬Ø§ÙŠ. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙˆØ¯: VIP30'
        },
        {
            id: 'c3',
            name: 'Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ù…Ø¹Ø© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡',
            status: 'scheduled',
            statusLabel: 'Ù…Ø¬Ø¯ÙˆÙ„Ø©',
            segment: 'Ø§Ù„ÙƒÙ„',
            channel: 'ÙˆØ§ØªØ³Ø§Ø¨ + SMS',
            scheduledDate: '2026-02-14',
            scheduledTime: '10:00',
            recipients: 1200,
            message: 'Ø§Ø³ØªØ¹Ø¯ÙˆØ§ Ù„Ø£ÙƒØ¨Ø± Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³Ù†Ø©! Ø®ØµÙˆÙ…Ø§Øª ØªØµÙ„ 50% Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª. ØªØ±Ù‚Ø¨ÙˆÙ†Ø§!'
        },
        {
            id: 'c4',
            name: 'Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ†',
            status: 'draft',
            statusLabel: 'Ù…Ø³ÙˆØ¯Ø©',
            segment: 'ØºØ§Ø¦Ø¨ÙŠÙ†',
            channel: 'ÙˆØ§ØªØ³Ø§Ø¨',
            message: 'ÙˆØ­Ø´ØªÙ†Ø§! Ø±Ø¬Ø¹Ù†Ø§ Ø¨Ø¹Ø±ÙˆØ¶ Ø¬Ø¯ÙŠØ¯Ø© ØªÙ†Ø§Ø³Ø¨Ùƒ. ØªØ¹Ø§Ù„ Ø´ÙˆÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¹Ù†Ø¯Ù†Ø§.'
        }
    ];

    // ========================================
    // Render Campaign Cards
    // ========================================
    function renderCampaigns(filter) {
        var container = document.getElementById('campaignsList');
        if (!container) return;

        var filtered = campaigns;
        if (filter && filter !== 'all') {
            filtered = campaigns.filter(function(c) { return c.status === filter; });
        }

        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state">' +
                '<div class="empty-state-icon">ğŸ“­</div>' +
                '<div class="empty-state-title">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù…Ù„Ø§Øª</div>' +
                '<div class="empty-state-desc">Ù…Ø§ ÙÙŠ Ø­Ù…Ù„Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ù‡Ø§Ù„ÙÙ„ØªØ±. Ø¬Ø±Ù‘Ø¨ ÙÙ„ØªØ± Ø«Ø§Ù†ÙŠ Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©.</div>' +
                '</div>';
            return;
        }

        var html = '';
        filtered.forEach(function(c) {
            html += buildCampaignCard(c);
        });
        container.innerHTML = html;
    }

    function buildCampaignCard(c) {
        var statusBadgeClass = '';
        if (c.status === 'sent') statusBadgeClass = 'badge-success';
        else if (c.status === 'scheduled') statusBadgeClass = 'badge-info';
        else statusBadgeClass = 'badge-neutral';

        var card = '<div class="campaign-card status-' + c.status + '" data-id="' + c.id + '">';

        // Top row: name + status
        card += '<div class="campaign-top">';
        card += '<div class="campaign-name-wrap">';
        card += '<span class="campaign-name">' + c.name + '</span>';
        card += '<span class="badge ' + statusBadgeClass + '">' + c.statusLabel + '</span>';
        card += '</div>';
        // Actions
        card += '<div class="campaign-actions">';
        if (c.status === 'sent') {
            card += '<button class="btn btn-ghost btn-sm" onclick="showReport(\'' + c.id + '\')">' +
                '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg> ' +
                'Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>';
        }
        card += '<button class="btn btn-ghost btn-sm" onclick="editCampaign(\'' + c.id + '\')">' +
            '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> ' +
            'ØªØ¹Ø¯ÙŠÙ„</button>';
        card += '<button class="btn btn-ghost btn-sm" onclick="duplicateCampaign(\'' + c.id + '\')">' +
            '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> ' +
            'Ù†Ø³Ø®</button>';
        if (c.status === 'draft') {
            card += '<button class="btn btn-danger btn-sm" onclick="deleteCampaign(\'' + c.id + '\')">' +
                '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> ' +
                'Ø­Ø°Ù</button>';
        }
        card += '</div>';
        card += '</div>';

        // Metrics row â€” only for sent campaigns
        if (c.status === 'sent') {
            card += '<div class="campaign-metrics">';
            card += buildMetric(formatNum(c.sent), 'Ù…Ø±Ø³Ù„Ø©');
            card += buildMetric(c.delivered + '%', 'ØªØ³Ù„ÙŠÙ…');
            card += buildMetric(c.read + '%', 'Ù‚Ø±Ø§Ø¡Ø©');
            card += buildMetric(c.clicked + '%', 'Ù†Ù‚Ø±');
            card += '<div class="campaign-metric"><div class="campaign-metric-value revenue">' + formatNum(c.revenue) + ' Ø±.Ø³</div><div class="campaign-metric-label">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div></div>';
            card += '</div>';
        }

        // Scheduled info
        if (c.status === 'scheduled') {
            card += '<div class="campaign-scheduled-info">' +
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>' +
                'Ù…Ø¬Ø¯ÙˆÙ„Ø© ÙÙŠ ' + formatDate(c.scheduledDate) + ' Ø§Ù„Ø³Ø§Ø¹Ø© ' + (c.scheduledTime || '10:00') +
                ' â€” ~' + formatNum(c.recipients) + ' Ù…Ø³ØªÙ„Ù…' +
                '</div>';
        }

        // Draft info
        if (c.status === 'draft') {
            card += '<div class="campaign-draft-info">' +
                '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>' +
                'Ù…Ø³ÙˆØ¯Ø© â€” Ù„Ù… ØªÙØ±Ø³Ù„ Ø¨Ø¹Ø¯' +
                '</div>';
        }

        // Bottom: tags + date
        card += '<div class="campaign-bottom">';
        card += '<div class="campaign-tags">';
        card += '<span class="campaign-tag">' +
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>' +
            c.segment + '</span>';
        card += '<span class="campaign-tag">' +
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>' +
            c.channel + '</span>';
        if (c.date) {
            card += '<span class="campaign-tag">' +
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>' +
                formatDate(c.date) + '</span>';
        }
        card += '</div>';
        card += '</div>';

        card += '</div>';
        return card;
    }

    function buildMetric(value, label) {
        return '<div class="campaign-metric">' +
            '<div class="campaign-metric-value">' + value + '</div>' +
            '<div class="campaign-metric-label">' + label + '</div>' +
            '</div>';
    }

    function formatNum(n) {
        if (n === undefined || n === null) return 'â€”';
        return n.toLocaleString('ar-SA');
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        var parts = dateStr.split('-');
        var months = ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
        return parseInt(parts[2]) + ' ' + months[parseInt(parts[1]) - 1] + ' ' + parts[0];
    }

    // ========================================
    // Tab Filtering
    // ========================================
    function initTabs() {
        var tabs = document.querySelectorAll('#campaignTabs .tab');
        tabs.forEach(function(tab) {
            tab.addEventListener('click', function() {
                tabs.forEach(function(t) { t.classList.remove('active'); });
                this.classList.add('active');
                renderCampaigns(this.dataset.filter);
            });
        });
    }

    // ========================================
    // Create Campaign Modal â€” Multi-step
    // ========================================
    var currentStep = 1;
    var totalSteps = 5;
    var newCampaign = {
        name: '',
        segment: '',
        channel: [],
        message: '',
        scheduleType: 'now',
        scheduleDate: '',
        scheduleTime: ''
    };

    window.openCreateModal = function() {
        currentStep = 1;
        newCampaign = { name: '', segment: '', channel: [], message: '', scheduleType: 'now', scheduleDate: '', scheduleTime: '' };
        renderModalStep();
        document.getElementById('createModal').classList.add('open');
    };

    window.closeCreateModal = function() {
        document.getElementById('createModal').classList.remove('open');
    };

    window.nextStep = function() {
        // Validate current step
        if (!validateStep()) return;

        // Save current step data
        saveStepData();

        if (currentStep === totalSteps) {
            submitCampaign();
            return;
        }
        currentStep++;
        renderModalStep();
    };

    window.prevStep = function() {
        if (currentStep <= 1) return;
        saveStepData();
        currentStep--;
        renderModalStep();
    };

    function validateStep() {
        if (currentStep === 1) {
            var nameInput = document.getElementById('campaignNameInput');
            if (!nameInput || !nameInput.value.trim()) {
                nameInput.style.borderColor = 'var(--danger)';
                nameInput.focus();
                return false;
            }
        }
        if (currentStep === 2) {
            if (!newCampaign.segment) {
                return false;
            }
        }
        if (currentStep === 3) {
            if (newCampaign.channel.length === 0) {
                return false;
            }
        }
        if (currentStep === 4) {
            var msgInput = document.getElementById('campaignMessageInput');
            if (!msgInput || !msgInput.value.trim()) {
                msgInput.style.borderColor = 'var(--danger)';
                msgInput.focus();
                return false;
            }
        }
        return true;
    }

    function saveStepData() {
        if (currentStep === 1) {
            var nameInput = document.getElementById('campaignNameInput');
            if (nameInput) newCampaign.name = nameInput.value.trim();
        }
        if (currentStep === 4) {
            var msgInput = document.getElementById('campaignMessageInput');
            if (msgInput) newCampaign.message = msgInput.value.trim();
        }
        if (currentStep === 5) {
            var dateInput = document.getElementById('scheduleDateInput');
            var timeInput = document.getElementById('scheduleTimeInput');
            if (dateInput) newCampaign.scheduleDate = dateInput.value;
            if (timeInput) newCampaign.scheduleTime = timeInput.value;
        }
    }

    function renderModalStep() {
        var body = document.getElementById('modalBody');
        var stepLabel = document.getElementById('modalStep');
        var nextBtn = document.getElementById('modalNext');
        var backBtn = document.getElementById('modalBack');

        stepLabel.textContent = 'Ø§Ù„Ø®Ø·ÙˆØ© ' + currentStep + ' Ù…Ù† ' + totalSteps;
        backBtn.style.display = currentStep > 1 ? '' : 'none';

        if (currentStep === totalSteps) {
            nextBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ù…Ù„Ø©';
        } else {
            nextBtn.textContent = 'Ø§Ù„ØªØ§Ù„ÙŠ';
        }

        // Step indicator
        var indicator = '<div class="step-indicator">';
        for (var i = 1; i <= totalSteps; i++) {
            var dotClass = 'step-dot-nav';
            if (i < currentStep) dotClass += ' completed';
            else if (i === currentStep) dotClass += ' active';

            if (i === currentStep) {
                indicator += '<div class="' + dotClass + '">' + i + '</div>';
            } else if (i < currentStep) {
                indicator += '<div class="' + dotClass + '">&#10003;</div>';
            } else {
                indicator += '<div class="' + dotClass + '">' + i + '</div>';
            }

            if (i < totalSteps) {
                var lineClass = 'step-line-nav';
                if (i < currentStep) lineClass += ' completed';
                indicator += '<div class="' + lineClass + '"></div>';
            }
        }
        indicator += '</div>';

        var content = indicator;

        // Step 1: Campaign Name
        if (currentStep === 1) {
            content += '<div class="input-group">' +
                '<label class="input-label">Ø§Ø³Ù… Ø§Ù„Ø­Ù…Ù„Ø©</label>' +
                '<input type="text" class="input" id="campaignNameInput" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ø±Ø¶ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹" value="' + escapeAttr(newCampaign.name) + '" autocomplete="off">' +
                '</div>' +
                '<p style="font-size: 13px; color: var(--text-faint); margin-top: 8px;">Ø§Ø®ØªØ± Ø§Ø³Ù… ÙŠÙˆØµÙ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ù…Ù„Ø© â€” ÙŠØ¸Ù‡Ø± Ù„Ùƒ ÙÙ‚Ø· ÙˆÙ„Ø§ ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡.</p>';
        }

        // Step 2: Choose Segment
        if (currentStep === 2) {
            var segments = [
                { id: 'all', name: 'Ø§Ù„ÙƒÙ„', count: 1547 },
                { id: 'loyal', name: 'Ø£ÙˆÙÙŠØ§Ø¡', count: 312 },
                { id: 'new', name: 'Ø¬Ø¯Ø¯', count: 428 },
                { id: 'dormant', name: 'ØºØ§Ø¦Ø¨ÙŠÙ†', count: 203 },
                { id: 'high_value', name: 'Ø¹Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©', count: 89 }
            ];
            content += '<label class="input-label" style="margin-bottom: 12px;">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙŠØ­Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</label>';
            content += '<div class="segment-options">';
            segments.forEach(function(seg) {
                var selectedClass = newCampaign.segment === seg.id ? ' selected' : '';
                content += '<div class="segment-option' + selectedClass + '" onclick="selectSegment(\'' + seg.id + '\')" data-segment="' + seg.id + '">' +
                    '<span>' + seg.name + '</span>' +
                    '<span class="segment-option-count">' + formatNum(seg.count) + ' Ù…Ø´ØªØ±Ùƒ</span>' +
                    '</div>';
            });
            content += '</div>';
        }

        // Step 3: Choose Channel
        if (currentStep === 3) {
            content += '<label class="input-label" style="margin-bottom: 12px;">Ø§Ø®ØªØ± Ù‚Ù†Ø§Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</label>';
            content += '<div class="channel-choices">';
            var channels = [
                { id: 'whatsapp', name: 'ÙˆØ§ØªØ³Ø§Ø¨', icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>' },
                { id: 'sms', name: 'SMS', icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>' },
                { id: 'both', name: 'ÙˆØ§ØªØ³Ø§Ø¨ + SMS', icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>' }
            ];
            channels.forEach(function(ch) {
                var selectedClass = newCampaign.channel.indexOf(ch.id) !== -1 ? ' selected' : '';
                content += '<button class="channel-chip' + selectedClass + '" onclick="selectChannel(\'' + ch.id + '\')" type="button">' +
                    ch.icon + ' ' + ch.name +
                    '</button>';
            });
            content += '</div>';
            content += '<p style="font-size: 13px; color: var(--text-faint); margin-top: 12px;">ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¬Ø§Ù†ÙŠ Ø¹Ø¨Ø± Ø±Ù‚Ù…Ùƒ. SMS Ø¨Ø±Ø³ÙˆÙ… Ø¥Ø¶Ø§ÙÙŠØ© (~0.05 Ø±.Ø³ / Ø±Ø³Ø§Ù„Ø©).</p>';
        }

        // Step 4: Write Message
        if (currentStep === 4) {
            content += '<div class="input-group">' +
                '<label class="input-label">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>' +
                '<div class="message-area">' +
                '<textarea class="input" id="campaignMessageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." oninput="updateCharCount()">' + escapeHtml(newCampaign.message) + '</textarea>' +
                '</div>' +
                '</div>';
            content += '<div class="ai-assist-bar">' +
                '<button class="ai-btn" onclick="aiAssist()" type="button" id="aiAssistBtn">' +
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>' +
                'Ø§Ù‚ØªØ±Ø§Ø­ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' +
                '</button>' +
                '<span class="char-count" id="charCount">0 Ø­Ø±Ù</span>' +
                '</div>';
        }

        // Step 5: Schedule or Send Now
        if (currentStep === 5) {
            content += '<label class="input-label" style="margin-bottom: 12px;">Ù…ØªÙ‰ ØªØ±Ø³Ù„ Ø§Ù„Ø­Ù…Ù„Ø©ØŸ</label>';
            content += '<div class="schedule-options">';
            content += '<div class="schedule-chip' + (newCampaign.scheduleType === 'now' ? ' selected' : '') + '" onclick="selectSchedule(\'now\')">' +
                '<div class="schedule-chip-icon">&#9889;</div>' +
                '<div class="schedule-chip-title">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù†</div>' +
                '<div class="schedule-chip-desc">ØªØ±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†</div>' +
                '</div>';
            content += '<div class="schedule-chip' + (newCampaign.scheduleType === 'later' ? ' selected' : '') + '" onclick="selectSchedule(\'later\')">' +
                '<div class="schedule-chip-icon">&#128197;</div>' +
                '<div class="schedule-chip-title">Ø¬Ø¯ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹</div>' +
                '<div class="schedule-chip-desc">Ø­Ø¯Ø¯ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨</div>' +
                '</div>';
            content += '</div>';

            content += '<div class="schedule-datetime' + (newCampaign.scheduleType === 'later' ? ' visible' : '') + '" id="scheduleDatetime">';
            content += '<div class="grid-2">';
            content += '<div class="input-group">' +
                '<label class="input-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>' +
                '<input type="date" class="input" id="scheduleDateInput" value="' + escapeAttr(newCampaign.scheduleDate) + '">' +
                '</div>';
            content += '<div class="input-group">' +
                '<label class="input-label">Ø§Ù„ÙˆÙ‚Øª</label>' +
                '<input type="time" class="input" id="scheduleTimeInput" value="' + escapeAttr(newCampaign.scheduleTime || '10:00') + '">' +
                '</div>';
            content += '</div>';
            content += '</div>';

            // Summary
            var channelLabel = '';
            if (newCampaign.channel.indexOf('both') !== -1) channelLabel = 'ÙˆØ§ØªØ³Ø§Ø¨ + SMS';
            else if (newCampaign.channel.indexOf('whatsapp') !== -1) channelLabel = 'ÙˆØ§ØªØ³Ø§Ø¨';
            else if (newCampaign.channel.indexOf('sms') !== -1) channelLabel = 'SMS';

            var segmentLabel = '';
            var segMap = { all: 'Ø§Ù„ÙƒÙ„', loyal: 'Ø£ÙˆÙÙŠØ§Ø¡', new: 'Ø¬Ø¯Ø¯', dormant: 'ØºØ§Ø¦Ø¨ÙŠÙ†', high_value: 'Ø¹Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©' };
            segmentLabel = segMap[newCampaign.segment] || newCampaign.segment;

            content += '<div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border);">';
            content += '<label class="input-label" style="margin-bottom: 12px;">Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ù…Ù„Ø©</label>';
            content += '<div class="summary-row"><span class="summary-label">Ø§Ù„Ø§Ø³Ù…</span><span class="summary-value">' + escapeHtml(newCampaign.name) + '</span></div>';
            content += '<div class="summary-row"><span class="summary-label">Ø§Ù„Ø´Ø±ÙŠØ­Ø©</span><span class="summary-value">' + segmentLabel + '</span></div>';
            content += '<div class="summary-row"><span class="summary-label">Ø§Ù„Ù‚Ù†Ø§Ø©</span><span class="summary-value">' + channelLabel + '</span></div>';
            content += '<div class="summary-row"><span class="summary-label">Ø§Ù„Ø±Ø³Ø§Ù„Ø©</span><span class="summary-value" style="max-width: 280px; text-align: left; direction: rtl;">' + truncate(escapeHtml(newCampaign.message), 80) + '</span></div>';
            content += '</div>';
        }

        body.innerHTML = content;

        // Auto-focus
        if (currentStep === 1) {
            var nameInput = document.getElementById('campaignNameInput');
            if (nameInput) setTimeout(function() { nameInput.focus(); }, 100);
        }
        if (currentStep === 4) {
            updateCharCount();
        }
    }

    // ========================================
    // Step Interaction Handlers
    // ========================================
    window.selectSegment = function(segId) {
        newCampaign.segment = segId;
        document.querySelectorAll('.segment-option').forEach(function(el) {
            el.classList.toggle('selected', el.dataset.segment === segId);
        });
    };

    window.selectChannel = function(chId) {
        // Single-select: replace array
        newCampaign.channel = [chId];
        document.querySelectorAll('.channel-chip').forEach(function(el) {
            el.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
    };

    window.selectSchedule = function(type) {
        newCampaign.scheduleType = type;
        document.querySelectorAll('.schedule-chip').forEach(function(el) {
            el.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
        var dt = document.getElementById('scheduleDatetime');
        if (dt) {
            dt.classList.toggle('visible', type === 'later');
        }
        // Update button text
        var nextBtn = document.getElementById('modalNext');
        if (type === 'now') {
            nextBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù†';
        } else {
            nextBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø­Ù…Ù„Ø©';
        }
    };

    window.updateCharCount = function() {
        var input = document.getElementById('campaignMessageInput');
        var counter = document.getElementById('charCount');
        if (input && counter) {
            counter.textContent = input.value.length + ' Ø­Ø±Ù';
        }
    };

    window.aiAssist = function() {
        var btn = document.getElementById('aiAssistBtn');
        var textarea = document.getElementById('campaignMessageInput');
        if (!btn || !textarea) return;

        btn.innerHTML = '<div class="ai-loading"><span></span><span></span><span></span></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...';
        btn.disabled = true;

        // Simulate AI response
        var suggestions = [
            'Ù…Ø±Ø­Ø¨Ø§ {name}! \uD83D\uDC4B\n\nØ¹Ù†Ø¯Ù†Ø§ Ø¹Ø±Ø¶ Ø®Ø§Øµ Ø§Ù„ÙŠÙˆÙ… â€” Ø®ØµÙ… {discount}% Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.\nØ§Ù„Ø¹Ø±Ø¶ Ù…Ø­Ø¯ÙˆØ¯ Ù„Ø£ÙˆÙ„ 100 Ø·Ù„Ø¨.\n\nØ§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†: {link}',
            'Ø£Ù‡Ù„Ø§Ù‹ {name}! \uD83C\uDF1F\n\nÙ„Ø£Ù†Ùƒ Ù…Ù† Ø¹Ù…Ù„Ø§Ø¦Ù†Ø§ Ø§Ù„Ù…Ù…ÙŠØ²ÙŠÙ†ØŒ Ø¬Ù‡Ø²Ù†Ø§ Ù„Ùƒ Ù‡Ø¯ÙŠØ© Ø®Ø§ØµØ©:\nØ®ØµÙ… {discount}% + Ø´Ø­Ù† Ù…Ø¬Ø§Ù†ÙŠ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø¬Ø§ÙŠ.\n\nÙ„Ø§ ÙŠÙÙˆØªÙƒ: {link}',
            'Ù‡Ù„Ø§ {name}! \uD83D\uDE80\n\nÙ…Ù†ØªØ¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© ÙˆØµÙ„Øª Ø¹Ù†Ø¯Ù†Ø§ ÙˆØªÙ†Ø§Ø³Ø¨ Ø°ÙˆÙ‚Ùƒ.\nÙˆØ¹Ù†Ø¯Ùƒ Ø®ØµÙ… Ø­ØµØ±ÙŠ {discount}% Ù„Ùˆ Ø·Ù„Ø¨Øª Ø§Ù„ÙŠÙˆÙ….\n\nØªØµÙØ­ Ø§Ù„Ø¢Ù†: {link}',
            '{name}ØŒ ÙˆØ­Ø´ØªÙ†Ø§! \u2764\uFE0F\n\nÙ…Ù† Ø²Ù…Ø§Ù† Ù…Ø§ Ø´ÙÙ†Ø§Ùƒ. Ø¬Ù‡Ø²Ù†Ø§ Ù„Ùƒ Ø¹Ø±Ø¶ Ø®Ø§Øµ:\nØ®ØµÙ… {discount}% Ø¹Ù„Ù‰ Ø£ÙŠ Ø·Ù„Ø¨ + Ø´Ø­Ù† Ù…Ø¬Ø§Ù†ÙŠ.\n\nØ§Ø±Ø¬Ø¹ Ù„Ù†Ø§: {link}'
        ];
        var randomSuggestion = suggestions[Math.floor(Math.random() * suggestions.length)];

        setTimeout(function() {
            textarea.value = randomSuggestion;
            textarea.style.borderColor = 'rgba(139, 92, 246, 0.5)';
            setTimeout(function() { textarea.style.borderColor = ''; }, 1500);
            updateCharCount();
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg> Ø§Ù‚ØªØ±Ø§Ø­ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ';
            btn.disabled = false;
        }, 1500);
    };

    // ========================================
    // Submit Campaign
    // ========================================
    function submitCampaign() {
        saveStepData();

        var channelLabel = '';
        if (newCampaign.channel.indexOf('both') !== -1) channelLabel = 'ÙˆØ§ØªØ³Ø§Ø¨ + SMS';
        else if (newCampaign.channel.indexOf('whatsapp') !== -1) channelLabel = 'ÙˆØ§ØªØ³Ø§Ø¨';
        else if (newCampaign.channel.indexOf('sms') !== -1) channelLabel = 'SMS';

        var segMap = { all: 'Ø§Ù„ÙƒÙ„', loyal: 'Ø£ÙˆÙÙŠØ§Ø¡', new: 'Ø¬Ø¯Ø¯', dormant: 'ØºØ§Ø¦Ø¨ÙŠÙ†', high_value: 'Ø¹Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©' };
        var segCountMap = { all: 1547, loyal: 312, new: 428, dormant: 203, high_value: 89 };

        var newId = 'c' + (campaigns.length + 1);
        var isSendNow = newCampaign.scheduleType === 'now';

        var campaign = {
            id: newId,
            name: newCampaign.name,
            status: isSendNow ? 'sent' : 'scheduled',
            statusLabel: isSendNow ? 'Ù…Ø±Ø³Ù„Ø©' : 'Ù…Ø¬Ø¯ÙˆÙ„Ø©',
            segment: segMap[newCampaign.segment] || newCampaign.segment,
            channel: channelLabel,
            message: newCampaign.message
        };

        if (isSendNow) {
            var count = segCountMap[newCampaign.segment] || 500;
            campaign.sent = count;
            campaign.delivered = 97;
            campaign.read = 0;
            campaign.clicked = 0;
            campaign.revenue = 0;
            campaign.date = new Date().toISOString().split('T')[0];
        } else {
            campaign.scheduledDate = newCampaign.scheduleDate;
            campaign.scheduledTime = newCampaign.scheduleTime;
            campaign.recipients = segCountMap[newCampaign.segment] || 500;
        }

        campaigns.unshift(campaign);
        closeCreateModal();
        updateTabCounts();
        renderCampaigns('all');

        // Reset active tab
        document.querySelectorAll('#campaignTabs .tab').forEach(function(t) { t.classList.remove('active'); });
        document.querySelector('#campaignTabs .tab[data-filter="all"]').classList.add('active');
    }

    // ========================================
    // Campaign Actions
    // ========================================
    window.editCampaign = function(id) {
        var c = campaigns.find(function(x) { return x.id === id; });
        if (!c) return;

        // Pre-fill and open modal
        var segReverseMap = { 'Ø§Ù„ÙƒÙ„': 'all', 'Ø£ÙˆÙÙŠØ§Ø¡': 'loyal', 'Ø¬Ø¯Ø¯': 'new', 'ØºØ§Ø¦Ø¨ÙŠÙ†': 'dormant', 'Ø¹Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©': 'high_value' };
        var chReverseMap = { 'ÙˆØ§ØªØ³Ø§Ø¨': 'whatsapp', 'SMS': 'sms', 'ÙˆØ§ØªØ³Ø§Ø¨ + SMS': 'both' };

        newCampaign.name = c.name;
        newCampaign.segment = segReverseMap[c.segment] || 'all';
        newCampaign.channel = [chReverseMap[c.channel] || 'whatsapp'];
        newCampaign.message = c.message || '';
        newCampaign.scheduleType = c.status === 'scheduled' ? 'later' : 'now';
        newCampaign.scheduleDate = c.scheduledDate || '';
        newCampaign.scheduleTime = c.scheduledTime || '10:00';

        currentStep = 1;
        document.getElementById('modalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø©';
        renderModalStep();
        document.getElementById('createModal').classList.add('open');
    };

    window.duplicateCampaign = function(id) {
        var c = campaigns.find(function(x) { return x.id === id; });
        if (!c) return;

        var copy = JSON.parse(JSON.stringify(c));
        copy.id = 'c' + (campaigns.length + 1);
        copy.name = 'Ù†Ø³Ø®Ø© â€” ' + copy.name;
        copy.status = 'draft';
        copy.statusLabel = 'Ù…Ø³ÙˆØ¯Ø©';
        delete copy.sent;
        delete copy.delivered;
        delete copy.read;
        delete copy.clicked;
        delete copy.revenue;
        delete copy.date;
        delete copy.scheduledDate;
        delete copy.scheduledTime;
        delete copy.recipients;

        campaigns.push(copy);
        updateTabCounts();
        renderCampaigns('all');

        // Reset active tab
        document.querySelectorAll('#campaignTabs .tab').forEach(function(t) { t.classList.remove('active'); });
        document.querySelector('#campaignTabs .tab[data-filter="all"]').classList.add('active');
    };

    window.deleteCampaign = function(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù…Ù„Ø©ØŸ')) return;
        campaigns = campaigns.filter(function(c) { return c.id !== id; });
        updateTabCounts();
        var activeTab = document.querySelector('#campaignTabs .tab.active');
        renderCampaigns(activeTab ? activeTab.dataset.filter : 'all');
    };

    // ========================================
    // Campaign Report Modal
    // ========================================
    window.showReport = function(id) {
        var c = campaigns.find(function(x) { return x.id === id; });
        if (!c || c.status !== 'sent') return;

        document.getElementById('reportTitle').textContent = 'ØªÙ‚Ø±ÙŠØ±: ' + c.name;

        var delivered = Math.round(c.sent * c.delivered / 100);
        var read = Math.round(c.sent * c.read / 100);
        var clicked = Math.round(c.sent * c.clicked / 100);

        var html = '';

        // KPIs
        html += '<div class="report-kpis">';
        html += '<div class="report-kpi"><div class="report-kpi-value">' + formatNum(c.sent) + '</div><div class="report-kpi-label">Ù…Ø±Ø³Ù„Ø©</div></div>';
        html += '<div class="report-kpi"><div class="report-kpi-value" style="color: var(--primary);">' + formatNum(c.revenue) + ' Ø±.Ø³</div><div class="report-kpi-label">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div></div>';
        html += '<div class="report-kpi"><div class="report-kpi-value" style="color: var(--success);">' + c.clicked + '%</div><div class="report-kpi-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‚Ø±</div></div>';
        html += '</div>';

        // Funnel bars
        html += '<div style="margin-bottom: 8px;">';

        html += '<div class="report-bar-wrap">';
        html += '<div class="report-bar-label"><span>ØªØ³Ù„ÙŠÙ…</span><span>' + c.delivered + '% (' + formatNum(delivered) + ')</span></div>';
        html += '<div class="report-bar"><div class="report-bar-fill" style="width: ' + c.delivered + '%; background: var(--success);"></div></div>';
        html += '</div>';

        html += '<div class="report-bar-wrap">';
        html += '<div class="report-bar-label"><span>Ù‚Ø±Ø§Ø¡Ø©</span><span>' + c.read + '% (' + formatNum(read) + ')</span></div>';
        html += '<div class="report-bar"><div class="report-bar-fill" style="width: ' + c.read + '%; background: var(--info);"></div></div>';
        html += '</div>';

        html += '<div class="report-bar-wrap">';
        html += '<div class="report-bar-label"><span>Ù†Ù‚Ø±</span><span>' + c.clicked + '% (' + formatNum(clicked) + ')</span></div>';
        html += '<div class="report-bar"><div class="report-bar-fill" style="width: ' + c.clicked + '%; background: var(--primary);"></div></div>';
        html += '</div>';

        html += '</div>';

        // Details
        html += '<div style="padding-top: 16px; border-top: 1px solid var(--border);">';
        html += '<div class="summary-row"><span class="summary-label">Ø§Ù„Ø´Ø±ÙŠØ­Ø©</span><span class="summary-value">' + c.segment + '</span></div>';
        html += '<div class="summary-row"><span class="summary-label">Ø§Ù„Ù‚Ù†Ø§Ø©</span><span class="summary-value">' + c.channel + '</span></div>';
        html += '<div class="summary-row"><span class="summary-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span><span class="summary-value">' + formatDate(c.date) + '</span></div>';
        html += '</div>';

        document.getElementById('reportBody').innerHTML = html;
        document.getElementById('reportModal').classList.add('open');
    };

    window.closeReportModal = function() {
        document.getElementById('reportModal').classList.remove('open');
    };

    // ========================================
    // Utilities
    // ========================================
    function updateTabCounts() {
        var counts = { all: campaigns.length, sent: 0, scheduled: 0, draft: 0 };
        campaigns.forEach(function(c) {
            if (counts[c.status] !== undefined) counts[c.status]++;
        });
        document.querySelectorAll('#campaignTabs .tab').forEach(function(tab) {
            var filter = tab.dataset.filter;
            var count = counts[filter];
            if (count !== undefined) {
                var span = tab.querySelector('.text-dim');
                if (span) span.textContent = '(' + count + ')';
            }
        });
    }

    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function escapeAttr(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    function truncate(str, len) {
        if (!str) return '';
        return str.length > len ? str.substring(0, len) + '...' : str;
    }

    // ========================================
    // Close modals on overlay click
    // ========================================
    document.getElementById('createModal').addEventListener('click', function(e) {
        if (e.target === this) closeCreateModal();
    });
    document.getElementById('reportModal').addEventListener('click', function(e) {
        if (e.target === this) closeReportModal();
    });

    // Close modals on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeCreateModal();
            closeReportModal();
        }
    });

    // ========================================
    // Init
    // ========================================
    initTabs();
    renderCampaigns('all');

})();
</script>

</body>
</html>
