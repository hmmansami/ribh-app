<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الإعدادات | رِبح</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/platform/shared/shell.css">
    <style>
        /* Settings Layout: vertical tabs right, content left */
        .settings-layout {
            display: flex;
            gap: 24px;
            min-height: 600px;
        }
        .settings-nav {
            width: 200px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .settings-tab {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s;
            text-align: right;
            width: 100%;
        }
        .settings-tab:hover {
            background: var(--bg-hover);
            color: var(--text);
        }
        .settings-tab.active {
            background: var(--primary-subtle);
            color: var(--primary);
            font-weight: 600;
        }
        .settings-tab svg { flex-shrink: 0; opacity: 0.7; }
        .settings-tab.active svg { opacity: 1; }

        .settings-content {
            flex: 1;
            overflow: hidden;
        }
        .settings-section {
            display: none;
        }
        .settings-section.active {
            display: block;
            animation: fadeIn 0.25s ease;
        }

        /* Section header inside content */
        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 6px;
        }
        .section-desc {
            font-size: 13px;
            color: var(--text-dim);
            margin-bottom: 24px;
        }
        .section-divider {
            border: none;
            border-top: 1px solid var(--border);
            margin: 28px 0;
        }

        /* Form rows */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* Upload placeholder */
        .upload-area {
            width: 100px;
            height: 100px;
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: border-color 0.2s;
            color: var(--text-dim);
            flex-direction: column;
            gap: 6px;
            font-size: 11px;
        }
        .upload-area:hover {
            border-color: var(--border-hover);
            color: var(--text-muted);
        }

        /* WhatsApp status card */
        .wa-status-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
        }
        .wa-status-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .wa-status-dot.connected {
            background: var(--success);
            box-shadow: 0 0 10px var(--success), 0 0 20px rgba(34, 197, 94, 0.2);
        }
        .wa-status-dot.disconnected {
            background: var(--danger);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
        }
        .wa-status-info { flex: 1; }
        .wa-status-label {
            font-size: 16px;
            font-weight: 600;
        }
        .wa-status-detail {
            font-size: 13px;
            color: var(--text-dim);
            margin-top: 2px;
        }

        /* QR area */
        .qr-area {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 200px;
            height: 200px;
            background: #fff;
            border-radius: var(--radius-md);
            margin: 0 auto 24px;
        }
        .qr-area img {
            width: 180px;
            height: 180px;
        }
        .qr-placeholder {
            color: var(--text-dim);
            font-size: 13px;
            text-align: center;
        }

        /* Time range inputs */
        .time-range {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .time-range input[type="time"] {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text);
            font-family: inherit;
            font-size: 14px;
            outline: none;
        }
        .time-range input[type="time"]:focus {
            border-color: var(--primary);
        }
        .time-range span {
            color: var(--text-dim);
            font-size: 13px;
        }

        /* Channel cards */
        .channel-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }
        .channel-card:hover { border-color: var(--border-hover); }
        .channel-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .channel-icon.wa { background: rgba(34, 197, 94, 0.1); color: var(--success); }
        .channel-icon.email { background: rgba(59, 130, 246, 0.1); color: var(--info); }
        .channel-icon.sms { background: rgba(251, 191, 36, 0.1); color: var(--primary); }
        .channel-info { flex: 1; overflow: hidden; }
        .channel-name {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 2px;
        }
        .channel-meta {
            font-size: 12px;
            color: var(--text-dim);
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }
        .channel-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* AI personality selector */
        .personality-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        .personality-option {
            padding: 16px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .personality-option:hover {
            border-color: var(--border-hover);
        }
        .personality-option.selected {
            border-color: var(--primary);
            background: var(--primary-subtle);
        }
        .personality-option .p-icon {
            font-size: 28px;
            margin-bottom: 8px;
            display: block;
        }
        .personality-option .p-label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .personality-option .p-desc {
            font-size: 11px;
            color: var(--text-dim);
        }
        .personality-option.selected .p-label { color: var(--primary); }

        /* AI preview bubble */
        .ai-preview {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 16px 20px;
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.7;
            position: relative;
            margin-bottom: 24px;
        }
        .ai-preview::before {
            content: 'معاينة الرسالة';
            position: absolute;
            top: -10px;
            right: 16px;
            background: var(--bg-elevated);
            padding: 0 8px;
            font-size: 11px;
            color: var(--text-dim);
            font-weight: 600;
        }

        /* AI feature toggle row */
        .ai-feature {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }
        .ai-feature:hover { border-color: var(--border-hover); }
        .ai-feature-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            background: var(--primary-subtle);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .ai-feature-info { flex: 1; }
        .ai-feature-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .ai-feature-desc {
            font-size: 12px;
            color: var(--text-dim);
            line-height: 1.5;
        }
        .ai-provider-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }
        .ai-provider-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 13px;
            color: var(--text-muted);
        }
        .ai-provider-chip .provider-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .ai-provider-chip .provider-dot.active { background: var(--success); }
        .ai-provider-chip .provider-dot.standby { background: var(--text-dim); }

        /* Integration card */
        .integration-card {
            padding: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            transition: border-color 0.2s;
        }
        .integration-card:hover { border-color: var(--border-hover); }
        .integration-card.featured {
            border-color: rgba(251, 191, 36, 0.2);
        }
        .integration-card.featured:hover {
            border-color: rgba(251, 191, 36, 0.35);
        }
        .integration-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
        }
        .integration-logo {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 800;
            flex-shrink: 0;
        }
        .integration-logo.salla {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: #fff;
        }
        .integration-logo.shopify {
            background: linear-gradient(135deg, #95bf47, #5e8e3e);
            color: #fff;
        }
        .integration-logo.zapier {
            background: linear-gradient(135deg, #ff4a00, #ff7a33);
            color: #fff;
        }
        .integration-logo.api {
            background: var(--bg-elevated);
            color: var(--primary);
            border: 1px solid var(--border);
        }
        .integration-title-area { flex: 1; }
        .integration-name {
            font-size: 16px;
            font-weight: 600;
        }
        .integration-url {
            font-size: 12px;
            color: var(--text-dim);
            margin-top: 2px;
        }
        .sync-items {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 16px 0;
        }
        .sync-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-muted);
        }
        .sync-item svg { color: var(--success); flex-shrink: 0; }
        .sync-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        .sync-time {
            font-size: 12px;
            color: var(--text-dim);
        }

        /* API key field */
        .api-field {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        .api-field .input {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            letter-spacing: 1px;
        }
        .api-field .btn { flex-shrink: 0; }

        /* Team member row */
        .team-member {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 10px;
        }
        .team-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-subtle);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }
        .team-info { flex: 1; }
        .team-name { font-size: 14px; font-weight: 600; }
        .team-email { font-size: 12px; color: var(--text-dim); margin-top: 2px; }

        /* Invite form */
        .invite-form {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .invite-form .input-group { flex: 1; margin-bottom: 0; }
        .invite-form select.input { width: 140px; flex-shrink: 0; }

        /* Usage bar */
        .usage-row {
            margin-bottom: 20px;
        }
        .usage-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .usage-label { font-size: 13px; color: var(--text-muted); }
        .usage-value { font-size: 13px; font-weight: 600; color: var(--text-secondary); }
        .usage-track {
            width: 100%;
            height: 8px;
            background: var(--bg-hover);
            border-radius: 4px;
            overflow: hidden;
        }
        .usage-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease;
        }
        .usage-fill.green { background: var(--success); }
        .usage-fill.amber { background: var(--primary); }
        .usage-fill.red { background: var(--danger); }

        /* Plan card */
        .plan-card {
            padding: 24px;
            background: var(--bg-card);
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
        }
        .plan-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .plan-name { font-size: 20px; font-weight: 700; }
        .plan-price { font-size: 14px; color: var(--text-dim); }
        .plan-price strong {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
        }
        .plan-features {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .plan-features li {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-muted);
            padding: 6px 0;
        }
        .plan-features li svg { color: var(--success); flex-shrink: 0; }

        /* Toggle row for settings */
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }
        .toggle-text { flex: 1; }
        .toggle-text .toggle-label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }
        .toggle-text .toggle-desc {
            font-size: 12px;
            color: var(--text-dim);
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            z-index: 200;
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .toast.success { border-color: rgba(34, 197, 94, 0.3); }
        .toast.error { border-color: rgba(239, 68, 68, 0.3); }

        /* Responsive */
        @media (max-width: 768px) {
            .settings-layout {
                flex-direction: column;
            }
            .settings-nav {
                width: 100%;
                flex-direction: row;
                overflow-x: auto;
                gap: 2px;
                padding-bottom: 4px;
                border-bottom: 1px solid var(--border);
                margin-bottom: 20px;
            }
            .settings-tab {
                white-space: nowrap;
                padding: 8px 12px;
                font-size: 13px;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .personality-options {
                grid-template-columns: 1fr;
            }
            .sync-items {
                grid-template-columns: 1fr 1fr;
            }
            .invite-form {
                flex-direction: column;
                align-items: stretch;
            }
            .invite-form select.input { width: 100%; }
            .channel-card {
                flex-direction: column;
                align-items: flex-start;
            }
            .channel-actions {
                width: 100%;
                justify-content: space-between;
                margin-top: 12px;
            }
        }
    </style>
</head>
<body>

<div id="page-content">
    <div class="page-header">
        <h1 class="page-title">الإعدادات</h1>
        <p class="page-subtitle">إعدادات متجرك وقنوات التواصل</p>
    </div>

    <div class="settings-layout">
        <!-- Settings Navigation (Right Side) -->
        <div class="settings-nav">
            <button class="settings-tab active" data-section="store" onclick="switchTab('store')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                المتجر
            </button>
            <button class="settings-tab" data-section="whatsapp" onclick="switchTab('whatsapp')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                واتساب
            </button>
            <button class="settings-tab" data-section="channels" onclick="switchTab('channels')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                القنوات
            </button>
            <button class="settings-tab" data-section="ai" onclick="switchTab('ai')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a4 4 0 0 1 4 4c0 1.95-1.4 3.57-3.25 3.92L12 22"/><path d="M8 6a4 4 0 0 1 8 0"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M6 8l-2-2"/><path d="M18 8l2-2"/></svg>
                الذكاء الاصطناعي
            </button>
            <button class="settings-tab" data-section="integrations" onclick="switchTab('integrations')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg>
                التكاملات
            </button>
            <button class="settings-tab" data-section="team" onclick="switchTab('team')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                الفريق
            </button>
            <button class="settings-tab" data-section="billing" onclick="switchTab('billing')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                الفوترة
            </button>
        </div>

        <!-- Settings Content (Left Side) -->
        <div class="settings-content">

            <!-- ========== Store Settings ========== -->
            <div class="settings-section active" id="section-store">
                <div class="section-title">إعدادات المتجر</div>
                <div class="section-desc">المعلومات الأساسية لمتجرك</div>

                <div class="card" style="margin-bottom: 24px;">
                    <div class="input-group">
                        <label class="input-label">الشعار</label>
                        <div class="upload-area" id="logoUpload">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                            رفع الشعار
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="input-group">
                            <label class="input-label">اسم المتجر</label>
                            <input type="text" class="input" id="storeName" placeholder="مثال: متجر نوره">
                        </div>
                        <div class="input-group">
                            <label class="input-label">البريد الإلكتروني</label>
                            <input type="email" class="input" id="storeEmail" placeholder="info@mystore.com" dir="ltr" style="text-align: left;">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="input-group">
                            <label class="input-label">رقم الجوال</label>
                            <input type="tel" class="input" id="storePhone" placeholder="05XXXXXXXX" dir="ltr" style="text-align: left;">
                        </div>
                        <div class="input-group">
                            <label class="input-label">المنطقة الزمنية</label>
                            <select class="input" id="storeTimezone">
                                <option value="Asia/Riyadh" selected>Asia/Riyadh (توقيت السعودية)</option>
                                <option value="Asia/Dubai">Asia/Dubai (توقيت الإمارات)</option>
                                <option value="Asia/Kuwait">Asia/Kuwait (توقيت الكويت)</option>
                                <option value="Africa/Cairo">Africa/Cairo (توقيت مصر)</option>
                                <option value="Europe/Istanbul">Europe/Istanbul (توقيت تركيا)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="input-group">
                            <label class="input-label">العملة</label>
                            <input type="text" class="input" value="ر.س (SAR)" disabled style="opacity: 0.6;">
                        </div>
                        <div></div>
                    </div>
                </div>

                <button class="btn btn-primary" id="saveStoreBtn" onclick="saveStoreSettings()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    حفظ التغييرات
                </button>
            </div>

            <!-- ========== WhatsApp Settings ========== -->
            <div class="settings-section" id="section-whatsapp">
                <div class="section-title">اتصال واتساب</div>
                <div class="section-desc">ربط رقم الواتساب لإرسال الرسائل التلقائية</div>

                <!-- Connection status -->
                <div class="wa-status-card" id="waStatusCard">
                    <div class="wa-status-dot disconnected" id="waStatusDot"></div>
                    <div class="wa-status-info">
                        <div class="wa-status-label" id="waStatusLabel">واتساب غير متصل</div>
                        <div class="wa-status-detail" id="waStatusDetail">اربط رقمك لبدء إرسال الرسائل</div>
                    </div>
                    <button class="btn btn-primary btn-sm" id="waConnectBtn" onclick="connectWhatsApp()">اتصل الآن</button>
                </div>

                <!-- QR Code area (hidden by default) -->
                <div id="qrSection" style="display: none; text-align: center; margin-bottom: 24px;">
                    <div class="section-desc" style="margin-bottom: 12px;">امسح رمز QR من تطبيق واتساب على جوالك</div>
                    <div class="qr-area" id="qrArea">
                        <div class="qr-placeholder">جاري تحميل رمز QR...</div>
                    </div>
                </div>

                <hr class="section-divider">

                <div class="section-title" style="font-size: 16px;">إعدادات الرسائل</div>
                <div class="section-desc">تخصيص سلوك رسائل الواتساب</div>

                <div class="card" style="margin-bottom: 24px;">
                    <div class="input-group">
                        <label class="input-label">اسم المرسل</label>
                        <input type="text" class="input" id="waSenderName" placeholder="مثال: متجر نوره">
                    </div>

                    <div class="input-group">
                        <label class="input-label">رسالة الترحيب التلقائية</label>
                        <textarea class="input" id="waWelcomeMsg" rows="3" placeholder="اهلا وسهلا! شكرا لتواصلك مع متجرنا. كيف نقدر نساعدك؟"></textarea>
                    </div>

                    <div class="input-group">
                        <label class="input-label">ساعات العمل</label>
                        <div class="time-range">
                            <span>من</span>
                            <input type="time" id="businessFrom" value="09:00">
                            <span>إلى</span>
                            <input type="time" id="businessTo" value="22:00">
                        </div>
                    </div>

                    <hr class="section-divider">

                    <div class="toggle-row">
                        <div class="toggle-text">
                            <div class="toggle-label">الرد التلقائي خارج الدوام</div>
                            <div class="toggle-desc">إرسال رسالة تلقائية للعملاء خارج ساعات العمل</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="outOfHoursToggle" onchange="toggleOutOfHours()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div id="outOfHoursMsg" style="display: none; margin-top: 16px;">
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label">رسالة خارج الدوام</label>
                            <textarea class="input" id="waOutOfHoursMsg" rows="2" placeholder="شكرا لتواصلك! نحن حاليا خارج ساعات العمل. سنرد عليك في أقرب وقت."></textarea>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="saveWhatsAppSettings()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        حفظ الإعدادات
                    </button>
                    <button class="btn btn-danger" id="waDisconnectBtn" style="display: none;" onclick="disconnectWhatsApp()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>
                        قطع الاتصال
                    </button>
                </div>
            </div>

            <!-- ========== Channels ========== -->
            <div class="settings-section" id="section-channels">
                <div class="section-title">قنوات التواصل</div>
                <div class="section-desc">إدارة قنوات الإرسال المتاحة لحملاتك ورحلاتك</div>

                <!-- WhatsApp Channel -->
                <div class="channel-card">
                    <div class="channel-icon wa">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    </div>
                    <div class="channel-info">
                        <div class="channel-name">واتساب</div>
                        <div class="channel-meta">
                            <span id="channelWaStatus">
                                <span class="badge badge-success" style="font-size: 11px;">متصل</span>
                            </span>
                            <span>الرسائل هذا الشهر: <strong id="channelWaMsgCount">0</strong></span>
                            <span>معدل القراءة: <strong id="channelWaReadRate">0%</strong></span>
                        </div>
                    </div>
                    <div class="channel-actions">
                        <label class="toggle">
                            <input type="checkbox" checked id="channelWaEnabled">
                            <span class="toggle-slider"></span>
                        </label>
                        <button class="btn btn-ghost btn-sm" onclick="switchTab('whatsapp')">إعدادات</button>
                    </div>
                </div>

                <!-- Email Channel -->
                <div class="channel-card">
                    <div class="channel-icon email">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                    </div>
                    <div class="channel-info">
                        <div class="channel-name">البريد الإلكتروني</div>
                        <div class="channel-meta">
                            <span id="channelEmailStatus">
                                <span class="badge badge-info" style="font-size: 11px;">AWS SES</span>
                            </span>
                            <span>البريد المرسل: <strong id="channelEmailSender" dir="ltr" style="font-size: 11px;">--</strong></span>
                            <span>الحد اليومي: <strong id="channelEmailLimit">200</strong></span>
                        </div>
                    </div>
                    <div class="channel-actions">
                        <label class="toggle">
                            <input type="checkbox" id="channelEmailEnabled">
                            <span class="toggle-slider"></span>
                        </label>
                        <button class="btn btn-ghost btn-sm">إعدادات</button>
                    </div>
                </div>

                <!-- SMS Channel -->
                <div class="channel-card">
                    <div class="channel-icon sms">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><path d="M8 10h.01"/><path d="M12 10h.01"/><path d="M16 10h.01"/></svg>
                    </div>
                    <div class="channel-info">
                        <div class="channel-name">SMS</div>
                        <div class="channel-meta">
                            <span id="channelSmsStatus">
                                <span class="badge badge-neutral" style="font-size: 11px;">Twilio</span>
                            </span>
                            <span>الحالة: <strong id="channelSmsState">غير مفعّل</strong></span>
                            <span>الرصيد: <strong id="channelSmsBalance">--</strong></span>
                        </div>
                    </div>
                    <div class="channel-actions">
                        <label class="toggle">
                            <input type="checkbox" id="channelSmsEnabled">
                            <span class="toggle-slider"></span>
                        </label>
                        <button class="btn btn-ghost btn-sm">إعدادات</button>
                    </div>
                </div>
            </div>

            <!-- ========== AI Settings ========== -->
            <div class="settings-section" id="section-ai">
                <div class="section-title">الذكاء الاصطناعي</div>
                <div class="section-desc">تخصيص سلوك الذكاء الاصطناعي لتوليد الرسائل والعروض</div>

                <!-- AI Providers -->
                <div class="ai-provider-bar">
                    <div class="ai-provider-chip">
                        <span class="provider-dot active"></span>
                        <span>Groq</span>
                        <span class="badge badge-success" style="font-size: 10px; padding: 1px 6px;">نشط</span>
                    </div>
                    <div class="ai-provider-chip">
                        <span class="provider-dot standby"></span>
                        <span>Gemini</span>
                        <span class="badge badge-neutral" style="font-size: 10px; padding: 1px 6px;">احتياطي</span>
                    </div>
                </div>

                <hr class="section-divider">

                <!-- Message Personality -->
                <div class="section-title" style="font-size: 16px;">شخصية الرسائل</div>
                <div class="section-desc">اختر نبرة الرسائل التي يولّدها الذكاء الاصطناعي</div>

                <div class="personality-options">
                    <div class="personality-option" data-personality="friendly" onclick="selectPersonality('friendly')">
                        <span class="p-icon" aria-hidden="true">&#x1F44B;</span>
                        <div class="p-label">ودي</div>
                        <div class="p-desc">دافئ وقريب من العميل</div>
                    </div>
                    <div class="personality-option selected" data-personality="formal" onclick="selectPersonality('formal')">
                        <span class="p-icon" aria-hidden="true">&#x1F454;</span>
                        <div class="p-label">رسمي</div>
                        <div class="p-desc">مهني واحترافي</div>
                    </div>
                    <div class="personality-option" data-personality="casual" onclick="selectPersonality('casual')">
                        <span class="p-icon" aria-hidden="true">&#x270C;&#xFE0F;</span>
                        <div class="p-label">عفوي</div>
                        <div class="p-desc">بسيط ومباشر</div>
                    </div>
                </div>

                <div class="ai-preview" id="aiPreview">
                    مرحبا بك! لاحظنا ان لديك منتجات في سلة التسوق. يسعدنا نقدم لك خصم 15% عشان تكمل طلبك. العرض لفترة محدودة!
                </div>

                <hr class="section-divider">

                <!-- AI Features -->
                <div class="section-title" style="font-size: 16px;">مميزات الذكاء الاصطناعي</div>
                <div class="section-desc">تفعيل أو تعطيل ميزات AI المتقدمة</div>

                <div class="ai-feature">
                    <div class="ai-feature-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    </div>
                    <div class="ai-feature-info">
                        <div class="ai-feature-name">توقيت الإرسال الذكي</div>
                        <div class="ai-feature-desc">الذكاء الاصطناعي يحدد أفضل وقت لإرسال الرسائل لكل عميل بناء على سلوكه السابق</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="aiSmartTiming" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="ai-feature">
                    <div class="ai-feature-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    </div>
                    <div class="ai-feature-info">
                        <div class="ai-feature-name">اقتراحات الخصم الذكية</div>
                        <div class="ai-feature-desc">AI يقترح نسبة الخصم المناسبة لكل عميل بناء على قيمة السلة وسلوكه الشرائي</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="aiSmartDiscount" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="ai-feature">
                    <div class="ai-feature-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
                    </div>
                    <div class="ai-feature-info">
                        <div class="ai-feature-name">A/B Testing التلقائي</div>
                        <div class="ai-feature-desc">اختبار تلقائي لعدة نسخ من الرسائل واختيار الأفضل أداء تلقائيا</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="aiAbTesting">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div style="margin-top: 24px;">
                    <button class="btn btn-primary" onclick="saveAiSettings()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        حفظ إعدادات AI
                    </button>
                </div>
            </div>

            <!-- ========== Integrations ========== -->
            <div class="settings-section" id="section-integrations">
                <div class="section-title">التكاملات</div>
                <div class="section-desc">ربط متجرك بالمنصات والخدمات الخارجية</div>

                <!-- Salla Integration (Featured) -->
                <div class="integration-card featured">
                    <div class="integration-header">
                        <div class="integration-logo salla">S</div>
                        <div class="integration-title-area">
                            <div class="integration-name">
                                سلة
                                <span class="badge badge-success" style="margin-right: 8px; font-size: 11px;" id="sallaStatus">متصل</span>
                            </div>
                            <div class="integration-url" id="sallaStoreUrl">mystore.salla.sa</div>
                        </div>
                    </div>

                    <div class="sync-items">
                        <div class="sync-item">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                            المنتجات
                        </div>
                        <div class="sync-item">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                            الطلبات
                        </div>
                        <div class="sync-item">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                            العملاء
                        </div>
                        <div class="sync-item">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                            السلات المتروكة
                        </div>
                    </div>

                    <div class="sync-footer">
                        <div>
                            <div class="sync-time">آخر مزامنة: <span id="sallaLastSync">--</span></div>
                            <div class="sync-time" style="margin-top: 4px;">
                                Webhook:
                                <span class="badge badge-success" style="font-size: 10px; padding: 1px 6px;" id="sallaWebhookStatus">نشط</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="resyncSalla()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                            إعادة المزامنة
                        </button>
                    </div>
                </div>

                <!-- Shopify Integration -->
                <div class="integration-card">
                    <div class="integration-header">
                        <div class="integration-logo shopify">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
                        </div>
                        <div class="integration-title-area">
                            <div class="integration-name">
                                Shopify
                                <span class="badge badge-neutral" style="margin-right: 8px; font-size: 11px;">غير متصل</span>
                            </div>
                            <div class="integration-url">ربط متجرك على شوبيفاي</div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="connectShopify()">ربط المتجر</button>
                    </div>
                </div>

                <!-- Zapier -->
                <div class="integration-card">
                    <div class="integration-header">
                        <div class="integration-logo zapier">Z</div>
                        <div class="integration-title-area">
                            <div class="integration-name">
                                Zapier
                                <span class="badge badge-warning" style="margin-right: 8px; font-size: 11px;">قريبا</span>
                            </div>
                            <div class="integration-url">ربط رِبح مع آلاف التطبيقات عبر Zapier</div>
                        </div>
                    </div>
                </div>

                <hr class="section-divider">

                <!-- API Access -->
                <div class="section-title" style="font-size: 16px;">الوصول عبر API</div>
                <div class="section-desc">استخدم API للتكامل المخصص مع أنظمتك</div>

                <div class="card">
                    <div class="input-group">
                        <label class="input-label">مفتاح API</label>
                        <div class="api-field">
                            <input type="password" class="input" id="apiKeyField" value="ribh_sk_xxxxxxxxxxxxxxxxxxxx" readonly dir="ltr" style="text-align: left;">
                            <button class="btn btn-secondary btn-sm" onclick="toggleApiKey()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="apiKeyEyeIcon"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="copyToClipboard('apiKeyField', 'مفتاح API')">نسخ</button>
                        </div>
                    </div>

                    <div class="input-group" style="margin-bottom: 0;">
                        <label class="input-label">رابط Webhook</label>
                        <div class="api-field">
                            <input type="text" class="input" id="webhookUrlField" readonly dir="ltr" style="text-align: left;" value="">
                            <button class="btn btn-secondary btn-sm" onclick="copyToClipboard('webhookUrlField', 'رابط Webhook')">نسخ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== Team ========== -->
            <div class="settings-section" id="section-team">
                <div class="section-title">إدارة الفريق</div>
                <div class="section-desc">أضف أعضاء فريقك لإدارة المتجر معا</div>

                <!-- Current user (owner) -->
                <div class="team-member">
                    <div class="team-avatar" id="teamOwnerAvatar">م</div>
                    <div class="team-info">
                        <div class="team-name" id="teamOwnerName">--</div>
                        <div class="team-email" id="teamOwnerEmail">--</div>
                    </div>
                    <span class="badge badge-primary">مالك</span>
                </div>

                <div id="teamMembersList">
                    <!-- Populated by JS -->
                </div>

                <hr class="section-divider">

                <!-- Invite form -->
                <div class="section-title" style="font-size: 16px;">دعوة عضو جديد</div>
                <div class="section-desc">أرسل دعوة عبر البريد الإلكتروني</div>

                <div class="invite-form">
                    <div class="input-group">
                        <label class="input-label">البريد الإلكتروني</label>
                        <input type="email" class="input" id="inviteEmail" placeholder="member@example.com" dir="ltr" style="text-align: left;">
                    </div>
                    <select class="input" id="inviteRole" style="width: 140px; align-self: flex-end; margin-bottom: 0;">
                        <option value="admin">مشرف</option>
                        <option value="member">عضو</option>
                    </select>
                    <button class="btn btn-primary" style="align-self: flex-end;" onclick="inviteTeamMember()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
                        إرسال الدعوة
                    </button>
                </div>

                <!-- Empty state for team members -->
                <div id="teamEmptyState" class="empty-state" style="padding: 40px;">
                    <div class="empty-state-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.3;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    </div>
                    <div class="empty-state-title">أنت المستخدم الوحيد حاليا</div>
                    <div class="empty-state-desc">أضف أعضاء فريقك لمساعدتك في إدارة المتجر والحملات</div>
                </div>
            </div>

            <!-- ========== Billing ========== -->
            <div class="settings-section" id="section-billing">
                <div class="section-title">الفوترة والاشتراك</div>
                <div class="section-desc">إدارة خطتك الحالية واستهلاكك</div>

                <!-- Current Plan -->
                <div class="plan-card">
                    <div class="plan-header">
                        <div>
                            <div class="plan-name">خطة Growth</div>
                            <div class="plan-price" style="margin-top: 4px;">
                                <strong>199</strong> ر.س/شهريا
                            </div>
                        </div>
                        <span class="badge badge-primary">الخطة الحالية</span>
                    </div>
                    <ul class="plan-features">
                        <li>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                            5,000 رسالة واتساب / شهر
                        </li>
                        <li>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                            2,000 مشترك
                        </li>
                        <li>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                            رسائل ذكاء اصطناعي غير محدودة
                        </li>
                        <li>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                            تكامل سلة + شوبيفاي
                        </li>
                        <li>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                            A/B Testing + تحليلات متقدمة
                        </li>
                    </ul>
                </div>

                <!-- Usage -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">الاستهلاك هذا الشهر</div>
                    </div>

                    <div class="usage-row">
                        <div class="usage-header">
                            <span class="usage-label">رسائل واتساب</span>
                            <span class="usage-value"><span id="usageMsgSent">1,247</span> / 5,000</span>
                        </div>
                        <div class="usage-track">
                            <div class="usage-fill green" id="usageMsgBar" style="width: 25%;"></div>
                        </div>
                    </div>

                    <div class="usage-row">
                        <div class="usage-header">
                            <span class="usage-label">المشتركين</span>
                            <span class="usage-value"><span id="usageSubCount">843</span> / 2,000</span>
                        </div>
                        <div class="usage-track">
                            <div class="usage-fill green" id="usageSubBar" style="width: 42%;"></div>
                        </div>
                    </div>

                    <div class="usage-row" style="margin-bottom: 0;">
                        <div class="usage-header">
                            <span class="usage-label">بريد إلكتروني</span>
                            <span class="usage-value"><span id="usageEmailSent">89</span> / 200 يوميا</span>
                        </div>
                        <div class="usage-track">
                            <div class="usage-fill amber" id="usageEmailBar" style="width: 44%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Upgrade CTA -->
                <div class="card" style="text-align: center; padding: 32px;">
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">هل تحتاج رسائل أكثر؟</div>
                    <div style="font-size: 13px; color: var(--text-dim); margin-bottom: 20px;">ترقية لخطة Enterprise للحصول على رسائل غير محدودة ودعم أولوية</div>
                    <button class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                        ترقية الخطة
                    </button>
                </div>

                <hr class="section-divider">

                <!-- Payment Method -->
                <div class="section-title" style="font-size: 16px;">طريقة الدفع</div>
                <div class="section-desc">لم يتم إضافة طريقة دفع بعد</div>

                <div class="card" style="text-align: center; padding: 24px;">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.3; margin-bottom: 12px;"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                    <div style="font-size: 14px; color: var(--text-dim); margin-bottom: 16px;">أضف بطاقة ائتمان أو طريقة دفع</div>
                    <button class="btn btn-secondary">إضافة طريقة دفع</button>
                </div>
            </div>

        </div><!-- /settings-content -->
    </div><!-- /settings-layout -->
</div><!-- /page-content -->

<!-- Toast -->
<div class="toast" id="toast"></div>

<script src="/platform/shared/shell.js"></script>
<script>
(function() {
    'use strict';

    // ---- State ----
    var state = {
        activeTab: 'store',
        personality: 'formal',
        waConnected: false,
        apiKeyVisible: false,
        settings: {}
    };

    // ---- Personality previews ----
    var personalityPreviews = {
        friendly: 'هلا والله! شفنا ان عندك أغراض حلوة في السلة ما كملت الطلب. عندنا لك خصم 15% خاص فيك! لا يفوتك العرض يا بعد قلبي.',
        formal: 'مرحبا بك. نود إعلامك بأن لديك منتجات في سلة التسوق. يسعدنا تقديم خصم 15% لإتمام طلبك. العرض متاح لفترة محدودة.',
        casual: 'هلا! سلتك فيها منتجات ناطرتك. خذ خصم 15% وكمّل الطلب الحين. العرض لفترة محدودة!'
    };

    // ---- Tab Switching ----
    window.switchTab = function(tab) {
        state.activeTab = tab;

        // Update nav
        var tabs = document.querySelectorAll('.settings-tab');
        tabs.forEach(function(t) {
            t.classList.toggle('active', t.getAttribute('data-section') === tab);
        });

        // Update content
        var sections = document.querySelectorAll('.settings-section');
        sections.forEach(function(s) {
            s.classList.toggle('active', s.id === 'section-' + tab);
        });

        // Update URL hash
        history.replaceState(null, '', '#' + tab);
    };

    // ---- Store Settings ----
    window.saveStoreSettings = function() {
        var btn = document.getElementById('saveStoreBtn');
        var data = {
            name: document.getElementById('storeName').value,
            email: document.getElementById('storeEmail').value,
            phone: document.getElementById('storePhone').value,
            timezone: document.getElementById('storeTimezone').value
        };

        btn.textContent = 'جاري الحفظ...';
        btn.disabled = true;

        RibhShell.api('/api/settings', {
            method: 'POST',
            body: { section: 'store', data: data }
        }).then(function() {
            showToast('تم حفظ إعدادات المتجر بنجاح', 'success');
            if (data.name) {
                localStorage.setItem('ribh_store_name', data.name);
            }
        }).catch(function() {
            showToast('حدث خطأ أثناء الحفظ', 'error');
        }).finally(function() {
            btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> حفظ التغييرات';
            btn.disabled = false;
        });
    };

    // ---- WhatsApp ----
    window.connectWhatsApp = function() {
        var btn = document.getElementById('waConnectBtn');
        btn.textContent = 'جاري الاتصال...';
        btn.disabled = true;

        document.getElementById('qrSection').style.display = 'block';

        RibhShell.api('/api/whatsapp/connect').then(function(data) {
            if (data && data.qr) {
                document.getElementById('qrArea').innerHTML = '<img src="' + data.qr + '" alt="QR Code">';
            }
            pollWhatsAppStatus();
        }).catch(function() {
            showToast('فشل الاتصال بواتساب. حاول مرة أخرى.', 'error');
            btn.textContent = 'اتصل الآن';
            btn.disabled = false;
        });
    };

    window.disconnectWhatsApp = function() {
        if (!confirm('هل أنت متأكد من قطع اتصال واتساب؟')) return;

        RibhShell.api('/api/whatsapp/disconnect', { method: 'POST' }).then(function() {
            updateWaStatus(false);
            showToast('تم قطع اتصال واتساب', 'success');
        }).catch(function() {
            showToast('حدث خطأ أثناء قطع الاتصال', 'error');
        });
    };

    function pollWhatsAppStatus() {
        var attempts = 0;
        var maxAttempts = 30;
        var interval = setInterval(function() {
            attempts++;
            if (attempts >= maxAttempts) {
                clearInterval(interval);
                return;
            }
            RibhShell.api('/api/whatsapp/status').then(function(data) {
                if (data && data.connected) {
                    clearInterval(interval);
                    updateWaStatus(true, data.number);
                    document.getElementById('qrSection').style.display = 'none';
                    showToast('تم الاتصال بواتساب بنجاح!', 'success');
                }
            }).catch(function() {});
        }, 3000);
    }

    function updateWaStatus(connected, number) {
        state.waConnected = connected;
        var dot = document.getElementById('waStatusDot');
        var label = document.getElementById('waStatusLabel');
        var detail = document.getElementById('waStatusDetail');
        var connectBtn = document.getElementById('waConnectBtn');
        var disconnectBtn = document.getElementById('waDisconnectBtn');

        if (connected) {
            dot.className = 'wa-status-dot connected';
            label.textContent = 'واتساب متصل';
            detail.textContent = number ? ('الرقم: ' + number) : 'متصل ونشط';
            connectBtn.style.display = 'none';
            disconnectBtn.style.display = '';
        } else {
            dot.className = 'wa-status-dot disconnected';
            label.textContent = 'واتساب غير متصل';
            detail.textContent = 'اربط رقمك لبدء إرسال الرسائل';
            connectBtn.style.display = '';
            connectBtn.textContent = 'اتصل الآن';
            connectBtn.disabled = false;
            disconnectBtn.style.display = 'none';
        }

        // Update channel card status
        var channelStatus = document.getElementById('channelWaStatus');
        if (channelStatus) {
            channelStatus.innerHTML = connected
                ? '<span class="badge badge-success" style="font-size: 11px;">متصل</span>'
                : '<span class="badge badge-danger" style="font-size: 11px;">غير متصل</span>';
        }
    }

    window.saveWhatsAppSettings = function() {
        var data = {
            senderName: document.getElementById('waSenderName').value,
            welcomeMessage: document.getElementById('waWelcomeMsg').value,
            businessHoursFrom: document.getElementById('businessFrom').value,
            businessHoursTo: document.getElementById('businessTo').value,
            outOfHoursEnabled: document.getElementById('outOfHoursToggle').checked,
            outOfHoursMessage: document.getElementById('waOutOfHoursMsg').value
        };

        RibhShell.api('/api/settings', {
            method: 'POST',
            body: { section: 'whatsapp', data: data }
        }).then(function() {
            showToast('تم حفظ إعدادات واتساب', 'success');
        }).catch(function() {
            showToast('حدث خطأ أثناء الحفظ', 'error');
        });
    };

    window.toggleOutOfHours = function() {
        var msg = document.getElementById('outOfHoursMsg');
        msg.style.display = document.getElementById('outOfHoursToggle').checked ? 'block' : 'none';
    };

    // ---- AI Settings ----
    window.selectPersonality = function(p) {
        state.personality = p;
        var options = document.querySelectorAll('.personality-option');
        options.forEach(function(o) {
            o.classList.toggle('selected', o.getAttribute('data-personality') === p);
        });
        document.getElementById('aiPreview').textContent = personalityPreviews[p] || '';
    };

    window.saveAiSettings = function() {
        var data = {
            personality: state.personality,
            smartTiming: document.getElementById('aiSmartTiming').checked,
            smartDiscount: document.getElementById('aiSmartDiscount').checked,
            abTesting: document.getElementById('aiAbTesting').checked
        };

        RibhShell.api('/api/settings', {
            method: 'POST',
            body: { section: 'ai', data: data }
        }).then(function() {
            showToast('تم حفظ إعدادات الذكاء الاصطناعي', 'success');
        }).catch(function() {
            showToast('حدث خطأ أثناء الحفظ', 'error');
        });
    };

    // ---- Integrations ----
    window.resyncSalla = function() {
        var btn = event.target.closest('.btn');
        var origHTML = btn.innerHTML;
        btn.textContent = 'جاري المزامنة...';
        btn.disabled = true;

        RibhShell.api('/api/integrations/salla/sync', { method: 'POST' }).then(function() {
            showToast('تمت المزامنة بنجاح', 'success');
            document.getElementById('sallaLastSync').textContent = 'الآن';
        }).catch(function() {
            showToast('فشلت المزامنة', 'error');
        }).finally(function() {
            btn.innerHTML = origHTML;
            btn.disabled = false;
        });
    };

    window.connectShopify = function() {
        window.location.href = '/shopify/install';
    };

    // ---- API Key ----
    window.toggleApiKey = function() {
        var field = document.getElementById('apiKeyField');
        state.apiKeyVisible = !state.apiKeyVisible;
        field.type = state.apiKeyVisible ? 'text' : 'password';
    };

    window.copyToClipboard = function(fieldId, label) {
        var field = document.getElementById(fieldId);
        var val = field.value;
        if (!val) return;

        if (navigator.clipboard) {
            navigator.clipboard.writeText(val).then(function() {
                showToast('تم نسخ ' + label, 'success');
            });
        } else {
            field.select();
            document.execCommand('copy');
            showToast('تم نسخ ' + label, 'success');
        }
    };

    // ---- Team ----
    window.inviteTeamMember = function() {
        var email = document.getElementById('inviteEmail').value;
        var role = document.getElementById('inviteRole').value;

        if (!email) {
            showToast('أدخل البريد الإلكتروني', 'error');
            return;
        }

        RibhShell.api('/api/team/invite', {
            method: 'POST',
            body: { email: email, role: role }
        }).then(function() {
            showToast('تم إرسال الدعوة إلى ' + email, 'success');
            document.getElementById('inviteEmail').value = '';
        }).catch(function() {
            showToast('فشل إرسال الدعوة', 'error');
        });
    };

    // ---- Toast ----
    function showToast(message, type) {
        var toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast ' + (type || '');
        toast.classList.add('show');

        setTimeout(function() {
            toast.classList.remove('show');
        }, 3000);
    }

    // ---- Load Settings ----
    function loadSettings() {
        RibhShell.api('/api/settings').then(function(data) {
            if (!data) return;
            state.settings = data;

            // Store tab
            if (data.store) {
                if (data.store.name) document.getElementById('storeName').value = data.store.name;
                if (data.store.email) document.getElementById('storeEmail').value = data.store.email;
                if (data.store.phone) document.getElementById('storePhone').value = data.store.phone;
                if (data.store.timezone) document.getElementById('storeTimezone').value = data.store.timezone;
            }

            // WhatsApp tab
            if (data.whatsapp) {
                if (data.whatsapp.senderName) document.getElementById('waSenderName').value = data.whatsapp.senderName;
                if (data.whatsapp.welcomeMessage) document.getElementById('waWelcomeMsg').value = data.whatsapp.welcomeMessage;
                if (data.whatsapp.businessHoursFrom) document.getElementById('businessFrom').value = data.whatsapp.businessHoursFrom;
                if (data.whatsapp.businessHoursTo) document.getElementById('businessTo').value = data.whatsapp.businessHoursTo;
                if (data.whatsapp.outOfHoursEnabled) {
                    document.getElementById('outOfHoursToggle').checked = true;
                    document.getElementById('outOfHoursMsg').style.display = 'block';
                }
                if (data.whatsapp.outOfHoursMessage) document.getElementById('waOutOfHoursMsg').value = data.whatsapp.outOfHoursMessage;
            }

            // AI tab
            if (data.ai) {
                if (data.ai.personality) selectPersonality(data.ai.personality);
                if (data.ai.smartTiming !== undefined) document.getElementById('aiSmartTiming').checked = data.ai.smartTiming;
                if (data.ai.smartDiscount !== undefined) document.getElementById('aiSmartDiscount').checked = data.ai.smartDiscount;
                if (data.ai.abTesting !== undefined) document.getElementById('aiAbTesting').checked = data.ai.abTesting;
            }

            // Channels
            if (data.channels) {
                if (data.channels.emailSender) document.getElementById('channelEmailSender').textContent = data.channels.emailSender;
                if (data.channels.emailEnabled) document.getElementById('channelEmailEnabled').checked = true;
                if (data.channels.smsEnabled) document.getElementById('channelSmsEnabled').checked = true;
            }

            // Integrations
            if (data.integrations) {
                if (data.integrations.sallaUrl) document.getElementById('sallaStoreUrl').textContent = data.integrations.sallaUrl;
                if (data.integrations.sallaConnected === false) {
                    document.getElementById('sallaStatus').textContent = 'غير متصل';
                    document.getElementById('sallaStatus').className = 'badge badge-danger';
                }
                if (data.integrations.lastSync) document.getElementById('sallaLastSync').textContent = data.integrations.lastSync;
                if (data.integrations.apiKey) document.getElementById('apiKeyField').value = data.integrations.apiKey;
                if (data.integrations.webhookUrl) document.getElementById('webhookUrlField').value = data.integrations.webhookUrl;
            }

            // Team
            if (data.team) {
                if (data.team.ownerName) {
                    document.getElementById('teamOwnerName').textContent = data.team.ownerName;
                    document.getElementById('teamOwnerAvatar').textContent = data.team.ownerName.charAt(0);
                }
                if (data.team.ownerEmail) document.getElementById('teamOwnerEmail').textContent = data.team.ownerEmail;
                if (data.team.members && data.team.members.length > 0) {
                    document.getElementById('teamEmptyState').style.display = 'none';
                    renderTeamMembers(data.team.members);
                }
            }

            // Billing / Usage
            if (data.billing) {
                if (data.billing.messagesSent !== undefined) {
                    document.getElementById('usageMsgSent').textContent = data.billing.messagesSent.toLocaleString('ar-SA');
                    var msgPct = Math.min((data.billing.messagesSent / 5000) * 100, 100);
                    var msgBar = document.getElementById('usageMsgBar');
                    msgBar.style.width = msgPct + '%';
                    msgBar.className = 'usage-fill ' + (msgPct > 80 ? 'red' : msgPct > 50 ? 'amber' : 'green');
                }
                if (data.billing.subscribers !== undefined) {
                    document.getElementById('usageSubCount').textContent = data.billing.subscribers.toLocaleString('ar-SA');
                    var subPct = Math.min((data.billing.subscribers / 2000) * 100, 100);
                    var subBar = document.getElementById('usageSubBar');
                    subBar.style.width = subPct + '%';
                    subBar.className = 'usage-fill ' + (subPct > 80 ? 'red' : subPct > 50 ? 'amber' : 'green');
                }
            }
        }).catch(function() {
            // Settings endpoint not available — use defaults
        });

        // Check WhatsApp status separately
        RibhShell.api('/api/whatsapp/status').then(function(data) {
            if (data && data.connected) {
                updateWaStatus(true, data.number || data.phone);
            } else {
                updateWaStatus(false);
            }
        }).catch(function() {
            updateWaStatus(false);
        });
    }

    function renderTeamMembers(members) {
        var list = document.getElementById('teamMembersList');
        list.innerHTML = '';
        members.forEach(function(m) {
            var roleBadge = m.role === 'admin' ? 'badge-info' : 'badge-neutral';
            var roleLabel = m.role === 'admin' ? 'مشرف' : 'عضو';
            list.innerHTML += '<div class="team-member">' +
                '<div class="team-avatar">' + (m.name || m.email).charAt(0) + '</div>' +
                '<div class="team-info">' +
                    '<div class="team-name">' + (m.name || m.email) + '</div>' +
                    '<div class="team-email">' + m.email + '</div>' +
                '</div>' +
                '<span class="badge ' + roleBadge + '">' + roleLabel + '</span>' +
            '</div>';
        });
    }

    // ---- Init ----
    function init() {
        // Read hash for active tab
        var hash = window.location.hash.replace('#', '');
        if (hash && document.getElementById('section-' + hash)) {
            switchTab(hash);
        }

        // Set webhook URL default
        var webhookField = document.getElementById('webhookUrlField');
        if (webhookField && !webhookField.value) {
            webhookField.value = window.location.origin + '/webhooks/salla';
        }

        // Load remote settings
        loadSettings();
    }

    // Wait for shell to finish rendering
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(init, 100);
        });
    } else {
        setTimeout(init, 100);
    }
})();
</script>

</body>
</html>
