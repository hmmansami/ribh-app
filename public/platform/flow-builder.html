<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIBH - Ù…Ù†Ø´Ø¦ Ø§Ù„Ø£ØªÙ…ØªØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <link rel="stylesheet" href="shared/shell.css">
    <style>
        /* â”€â”€ Builder Header â”€â”€ */
        .builder-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 40;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .builder-header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .builder-back {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            transition: all 0.15s var(--ease);
            background: none;
            border: none;
            font-family: inherit;
        }

        .builder-back:hover {
            background: var(--bg-hover);
            color: var(--text);
        }

        .builder-back svg {
            width: 16px;
            height: 16px;
        }

        .builder-name-input {
            background: transparent;
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            color: var(--text);
            font-family: inherit;
            font-size: 18px;
            font-weight: 700;
            padding: 6px 12px;
            outline: none;
            transition: all 0.15s var(--ease);
            min-width: 200px;
            direction: rtl;
        }

        .builder-name-input:hover {
            border-color: var(--border);
        }

        .builder-name-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-dim);
        }

        .builder-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11.5px;
            font-weight: 600;
        }

        .status-badge.draft {
            background: var(--warning-dim);
            color: var(--warning);
        }

        .status-badge.active {
            background: var(--success-dim);
            color: var(--success);
        }

        .status-badge-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        /* â”€â”€ Two-Panel Layout â”€â”€ */
        .builder-layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .builder-main {
            flex: 7;
            min-width: 0;
        }

        .builder-sidebar {
            flex: 3;
            position: sticky;
            top: 100px;
            max-height: calc(100dvh - 180px);
            overflow-y: auto;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
        }

        /* â”€â”€ Flow Pipeline â”€â”€ */
        .flow-pipeline {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 32px 0;
            min-height: 400px;
        }

        /* â”€â”€ Step Card â”€â”€ */
        .step-card {
            width: 100%;
            max-width: 420px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s var(--ease);
            animation: fadeInUp 0.3s var(--ease) both;
        }

        .step-card:hover {
            border-color: var(--border-strong);
        }

        .step-card:hover .step-delete {
            opacity: 1;
        }

        .step-card.selected {
            border-color: var(--border-strong);
        }

        .step-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 4px;
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
        }

        /* Step type colors */
        .step-card[data-type="trigger"]::before { background: #8B5CF6; }
        .step-card[data-type="trigger"].selected { box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3), 0 4px 16px rgba(139, 92, 246, 0.15); border-color: rgba(139, 92, 246, 0.5); }

        .step-card[data-type="delay"]::before { background: var(--text-dim); }
        .step-card[data-type="delay"].selected { box-shadow: 0 0 0 2px rgba(82, 82, 91, 0.4), 0 4px 16px rgba(82, 82, 91, 0.15); border-color: rgba(82, 82, 91, 0.6); }

        .step-card[data-type="whatsapp"]::before { background: var(--whatsapp); }
        .step-card[data-type="whatsapp"].selected { box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.3), 0 4px 16px rgba(37, 211, 102, 0.15); border-color: rgba(37, 211, 102, 0.5); }

        .step-card[data-type="email"]::before { background: var(--info); }
        .step-card[data-type="email"].selected { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3), 0 4px 16px rgba(59, 130, 246, 0.15); border-color: rgba(59, 130, 246, 0.5); }

        .step-card[data-type="condition"]::before { background: var(--warning); }
        .step-card[data-type="condition"].selected { box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.3), 0 4px 16px rgba(245, 158, 11, 0.15); border-color: rgba(245, 158, 11, 0.5); }

        .step-card[data-type="action"]::before { background: var(--primary); }
        .step-card[data-type="action"].selected { box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3), 0 4px 16px rgba(16, 185, 129, 0.15); border-color: rgba(16, 185, 129, 0.5); }

        .step-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .step-icon svg {
            width: 16px;
            height: 16px;
        }

        .step-card[data-type="trigger"] .step-icon { background: rgba(139, 92, 246, 0.15); color: #8B5CF6; }
        .step-card[data-type="delay"] .step-icon { background: var(--bg-surface-2); color: var(--text-muted); }
        .step-card[data-type="whatsapp"] .step-icon { background: var(--whatsapp-dim); color: var(--whatsapp); }
        .step-card[data-type="email"] .step-icon { background: var(--info-dim); color: var(--info); }
        .step-card[data-type="condition"] .step-icon { background: var(--warning-dim); color: var(--warning); }
        .step-card[data-type="action"] .step-icon { background: var(--primary-dim); color: var(--primary); }

        .step-type-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .step-card[data-type="trigger"] .step-type-label { color: #8B5CF6; }
        .step-card[data-type="delay"] .step-type-label { color: var(--text-muted); }
        .step-card[data-type="whatsapp"] .step-type-label { color: var(--whatsapp); }
        .step-card[data-type="email"] .step-type-label { color: var(--info); }
        .step-card[data-type="condition"] .step-type-label { color: var(--warning); }
        .step-card[data-type="action"] .step-type-label { color: var(--primary); }

        .step-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .step-desc {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .step-preview {
            margin-top: 10px;
            padding: 10px 12px;
            background: var(--bg-surface-2);
            border-radius: var(--radius-sm);
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.6;
            border-right: 3px solid;
        }

        .step-card[data-type="whatsapp"] .step-preview { border-color: var(--whatsapp); }
        .step-card[data-type="email"] .step-preview { border-color: var(--info); }

        .step-delete {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 26px;
            height: 26px;
            border-radius: var(--radius-sm);
            background: var(--danger-dim);
            border: none;
            color: var(--danger);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.15s var(--ease);
        }

        .step-delete svg {
            width: 14px;
            height: 14px;
        }

        .step-delete:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        /* â”€â”€ Connector Lines â”€â”€ */
        .connector {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 0;
        }

        .connector-line {
            width: 2px;
            height: 20px;
            background: repeating-linear-gradient(
                to bottom,
                var(--border-strong) 0px,
                var(--border-strong) 4px,
                transparent 4px,
                transparent 8px
            );
        }

        .connector-arrow {
            color: var(--text-dim);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .connector-arrow svg {
            width: 14px;
            height: 14px;
        }

        /* â”€â”€ Add Button â”€â”€ */
        .add-step-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 0;
            position: relative;
        }

        .add-step-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: var(--bg-surface-2);
            border: 2px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s var(--ease);
            position: relative;
            z-index: 2;
        }

        .add-step-btn svg {
            width: 16px;
            height: 16px;
        }

        .add-step-btn:hover {
            background: var(--primary-dim);
            border-color: var(--primary);
            color: var(--primary);
            transform: scale(1.1);
        }

        /* â”€â”€ Add Step Dropdown â”€â”€ */
        .add-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-raised);
            border: 1px solid var(--border-strong);
            border-radius: var(--radius-md);
            padding: 6px;
            min-width: 220px;
            z-index: 30;
            box-shadow: var(--shadow-lg);
            display: none;
            animation: fadeIn 0.15s var(--ease);
        }

        .add-dropdown.open {
            display: block;
        }

        .add-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background 0.1s var(--ease);
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            border: none;
            background: none;
            width: 100%;
            font-family: inherit;
            text-align: right;
        }

        .add-dropdown-item:hover {
            background: var(--bg-hover);
            color: var(--text);
        }

        .add-dropdown-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .add-dropdown-icon svg {
            width: 14px;
            height: 14px;
        }

        .add-dropdown-item[data-type="delay"] .add-dropdown-icon { background: var(--bg-surface-2); color: var(--text-muted); }
        .add-dropdown-item[data-type="whatsapp"] .add-dropdown-icon { background: var(--whatsapp-dim); color: var(--whatsapp); }
        .add-dropdown-item[data-type="email"] .add-dropdown-icon { background: var(--info-dim); color: var(--info); }
        .add-dropdown-item[data-type="condition"] .add-dropdown-icon { background: var(--warning-dim); color: var(--warning); }
        .add-dropdown-item[data-type="action"] .add-dropdown-icon { background: var(--primary-dim); color: var(--primary); }

        /* â”€â”€ Config Panel â”€â”€ */
        .config-panel {
            padding: 24px;
        }

        .config-empty {
            text-align: center;
            padding: 48px 20px;
        }

        .config-empty-icon {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-md);
            background: var(--bg-surface-2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 14px;
        }

        .config-empty-icon svg {
            width: 24px;
            height: 24px;
            color: var(--text-dim);
        }

        .config-empty-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .config-empty-desc {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .config-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .config-header-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .config-header-icon svg {
            width: 18px;
            height: 18px;
        }

        .config-header-text h3 {
            font-size: 15px;
            font-weight: 700;
            color: var(--text);
        }

        .config-header-text span {
            font-size: 11px;
            color: var(--text-muted);
        }

        .config-section {
            margin-bottom: 20px;
        }

        .config-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .config-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .config-row .input-group {
            flex: 1;
        }

        /* Variable tags */
        .variable-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .variable-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--bg-surface-2);
            border: 1px solid var(--border);
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s var(--ease);
            font-family: inherit;
        }

        .variable-tag:hover {
            background: var(--primary-dim);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Message preview box */
        .message-preview {
            margin-top: 14px;
            padding: 16px;
            background: #0B4D29;
            border-radius: var(--radius-md);
            border-top-right-radius: 4px;
            position: relative;
        }

        .message-preview::before {
            content: 'Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©';
            display: block;
            font-size: 10px;
            font-weight: 600;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .message-preview-text {
            font-size: 13px;
            color: #E8F5E9;
            line-height: 1.8;
            direction: rtl;
        }

        .message-preview-time {
            text-align: left;
            font-size: 10px;
            color: rgba(255,255,255,0.35);
            margin-top: 6px;
        }

        /* Textarea */
        .textarea {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-family: inherit;
            font-size: 13px;
            line-height: 1.7;
            resize: vertical;
            min-height: 100px;
            outline: none;
            direction: rtl;
            transition: border-color 0.15s var(--ease);
        }

        .textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-dim);
        }

        .textarea::placeholder {
            color: var(--text-dim);
        }

        /* â”€â”€ Flow Stats Mini Bar â”€â”€ */
        .flow-stats-bar {
            display: flex;
            gap: 1px;
            background: var(--border);
            border-radius: var(--radius-sm);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .flow-stat-item {
            flex: 1;
            background: var(--bg-surface);
            padding: 12px 16px;
            text-align: center;
        }

        .flow-stat-item:first-child {
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        .flow-stat-item:last-child {
            border-radius: var(--radius-sm) 0 0 var(--radius-sm);
        }

        .flow-stat-value {
            font-size: 18px;
            font-weight: 800;
            color: var(--text);
        }

        .flow-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* â”€â”€ Step Count Badge â”€â”€ */
        .step-number {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--bg-surface-2);
            border: 2px solid var(--bg-surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
        }

        /* â”€â”€ Confirm Delete Modal â”€â”€ */
        .delete-confirm {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
            padding: 20px;
        }

        .delete-confirm.open {
            display: flex;
        }

        .delete-confirm-box {
            background: var(--bg-raised);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: 28px;
            max-width: 380px;
            width: 100%;
            text-align: center;
            animation: modalIn 0.2s var(--ease);
        }

        .delete-confirm-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            background: var(--danger-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 14px;
        }

        .delete-confirm-icon svg {
            width: 22px;
            height: 22px;
            color: var(--danger);
        }

        .delete-confirm-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .delete-confirm-desc {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .delete-confirm-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        /* â”€â”€ Toast Notification â”€â”€ */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-surface-2);
            border: 1px solid var(--border-strong);
            border-radius: var(--radius-md);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            z-index: 400;
            box-shadow: var(--shadow-lg);
            transition: transform 0.3s var(--ease);
            pointer-events: none;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .toast svg {
            width: 18px;
            height: 18px;
            color: var(--primary);
            flex-shrink: 0;
        }

        /* â”€â”€ Responsive â”€â”€ */
        @media (max-width: 900px) {
            .builder-layout {
                flex-direction: column;
            }

            .builder-sidebar {
                position: static;
                max-height: none;
                order: 2;
            }

            .builder-main {
                order: 1;
            }

            .builder-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .builder-header-right {
                flex-wrap: wrap;
            }

            .builder-header-left {
                justify-content: flex-end;
            }

            .flow-stats-bar {
                flex-wrap: wrap;
            }

            .flow-stat-item {
                min-width: 100px;
            }
        }

        @media (max-width: 480px) {
            .step-card {
                max-width: 100%;
            }

            .flow-stats-bar {
                flex-direction: column;
            }

            .flow-stat-item {
                border-radius: 0 !important;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="page-body" style="display:none">
        <!-- Flow Stats Bar -->
        <div class="flow-stats-bar animate-in">
            <div class="flow-stat-item">
                <div class="flow-stat-value" id="statSent">Ù£Ù¬Ù¤Ù¥Ù </div>
                <div class="flow-stat-label">Ø±Ø³Ø§Ø¦Ù„ Ù…Ø±Ø³Ù„Ø©</div>
            </div>
            <div class="flow-stat-item">
                <div class="flow-stat-value" id="statConverted">Ù©Ù¨Ù </div>
                <div class="flow-stat-label">ØªØ­ÙˆÙŠÙ„Ø§Øª</div>
            </div>
            <div class="flow-stat-item">
                <div class="flow-stat-value" id="statRevenue">Ù¢Ù¨Ù¬Ù¥Ù Ù  Ø±.Ø³</div>
                <div class="flow-stat-label">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
            </div>
            <div class="flow-stat-item">
                <div class="flow-stat-value" id="statRate">Ù¢Ù¨Ù«Ù¤Ùª</div>
                <div class="flow-stat-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„</div>
            </div>
        </div>

        <!-- Builder Header -->
        <div class="builder-header animate-in">
            <div class="builder-header-right">
                <a href="flows.html" class="builder-back">
                    <i data-lucide="arrow-right"></i>
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£ØªÙ…ØªØ©
                </a>
                <input type="text" class="builder-name-input" id="flowName" value="Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©">
                <span class="status-badge draft" id="statusBadge">
                    <span class="status-badge-dot"></span>
                    <span id="statusText">Ù…Ø³ÙˆØ¯Ø©</span>
                </span>
            </div>
            <div class="builder-header-left">
                <button class="btn btn-secondary btn-sm" onclick="FlowBuilder.save()">
                    <i data-lucide="save"></i>
                    Ø­ÙØ¸
                </button>
                <button class="btn btn-primary btn-sm" id="activateBtn" onclick="FlowBuilder.toggleActivation()">
                    <i data-lucide="play"></i>
                    <span id="activateBtnText">ØªÙØ¹ÙŠÙ„</span>
                </button>
            </div>
        </div>

        <!-- Two-Panel Layout -->
        <div class="builder-layout">
            <!-- Main Panel: Visual Flow -->
            <div class="builder-main">
                <div class="flow-pipeline" id="flowPipeline">
                    <!-- Steps rendered by JS -->
                </div>
            </div>

            <!-- Right Panel: Step Configuration -->
            <div class="builder-sidebar" id="configPanel">
                <div class="config-panel" id="configContent">
                    <!-- Config rendered by JS -->
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="delete-confirm" id="deleteModal">
            <div class="delete-confirm-box">
                <div class="delete-confirm-icon">
                    <i data-lucide="trash-2"></i>
                </div>
                <div class="delete-confirm-title">Ø­Ø°Ù Ø§Ù„Ø®Ø·ÙˆØ©</div>
                <div class="delete-confirm-desc">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.</div>
                <div class="delete-confirm-actions">
                    <button class="btn btn-secondary btn-sm" onclick="FlowBuilder.cancelDelete()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button class="btn btn-danger btn-sm" onclick="FlowBuilder.confirmDelete()">
                        <i data-lucide="trash-2"></i>
                        Ø­Ø°Ù
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div class="toast" id="toast">
            <i data-lucide="check-circle"></i>
            <span id="toastText">ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­</span>
        </div>
    </div>

    <script src="shared/shell.js"></script>
    <script>
        RibhShell.init('flows');

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           Flow Builder Engine
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        const FlowBuilder = {
            steps: [],
            selectedStepId: null,
            isActive: false,
            deleteTargetId: null,
            openDropdownIdx: null,

            stepTypes: {
                trigger: { label: 'Ø§Ù„Ù…Ø­ÙØ²', icon: 'zap', color: '#8B5CF6' },
                delay: { label: 'Ø§Ù†ØªØ¸Ø§Ø±', icon: 'clock', color: '#52525B' },
                whatsapp: { label: 'Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨', icon: 'message-circle', color: '#25D366' },
                email: { label: 'Ø±Ø³Ø§Ù„Ø© Ø¨Ø±ÙŠØ¯', icon: 'mail', color: '#3B82F6' },
                condition: { label: 'Ø´Ø±Ø·', icon: 'git-branch', color: '#F59E0B' },
                action: { label: 'Ø¥Ø¬Ø±Ø§Ø¡', icon: 'play', color: '#10B981' }
            },

            triggerOptions: [
                { value: 'abandoned_cart', label: 'Ø³Ù„Ø© Ù…ØªØ±ÙˆÙƒØ©' },
                { value: 'new_order', label: 'Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯' },
                { value: 'new_customer', label: 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯' },
                { value: 'segment_entry', label: 'Ø¯Ø®ÙˆÙ„ Ø´Ø±ÙŠØ­Ø©' },
                { value: 'date_property', label: 'ØªØ§Ø±ÙŠØ®' },
                { value: 'price_drop', label: 'ØªØ®ÙÙŠØ¶ Ø³Ø¹Ø±' }
            ],

            init() {
                this.loadDefaultFlow();
                this.render();
                this.showEmptyConfig();
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.add-step-wrapper')) {
                        this.closeAllDropdowns();
                    }
                });
            },

            /* â”€â”€ Default Cart Recovery Flow â”€â”€ */
            loadDefaultFlow() {
                this.steps = [
                    {
                        id: this.uid(),
                        type: 'trigger',
                        title: 'Ø³Ù„Ø© Ù…ØªØ±ÙˆÙƒØ©',
                        description: 'Ø¹Ù†Ø¯Ù…Ø§ ÙŠØªØ±Ùƒ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ Ø¯ÙˆÙ† Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨',
                        config: { triggerType: 'abandoned_cart' }
                    },
                    {
                        id: this.uid(),
                        type: 'delay',
                        title: 'Ø§Ù†ØªØ¸Ø§Ø± Ù£Ù  Ø¯Ù‚ÙŠÙ‚Ø©',
                        description: 'Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆÙ‚Øª Ù„Ù„Ø¹ÙˆØ¯Ø© Ø¨Ù†ÙØ³Ù‡',
                        config: { duration: 30, unit: 'minutes' }
                    },
                    {
                        id: this.uid(),
                        type: 'whatsapp',
                        title: 'ØªØ°ÙƒÙŠØ± ÙˆØ¯ÙŠ Ø¨Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©',
                        description: 'Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ù‰ Ù„ØªØ°ÙƒÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„',
                        config: {
                            message: 'Ù…Ø±Ø­Ø¨Ø§Ù‹ {name} ğŸ‘‹\n\nÙ„Ø§Ø­Ø¸Ù†Ø§ Ø¥Ù†Ùƒ Ù…Ø§ ÙƒÙ…Ù„Øª Ø·Ù„Ø¨Ùƒ Ù…Ù† {store_name}.\n\nØ³Ù„ØªÙƒ Ù„Ø³Ù‡ Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ù‚ÙŠÙ…Ø© {cart_value} ÙˆÙÙŠÙ‡Ø§:\n{product_name}\n\nÙƒÙ…Ù‘Ù„ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø­ÙŠÙ† Ù‚Ø¨Ù„ Ù…Ø§ ØªÙ†ØªÙ‡ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶:\n{cart_link}',
                            template: 'cart_reminder_1'
                        }
                    },
                    {
                        id: this.uid(),
                        type: 'delay',
                        title: 'Ø§Ù†ØªØ¸Ø§Ø± Ø³Ø§Ø¹ØªÙŠÙ†',
                        description: 'ÙØªØ±Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¶Ø§ÙÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©',
                        config: { duration: 2, unit: 'hours' }
                    },
                    {
                        id: this.uid(),
                        type: 'condition',
                        title: 'Ù‡Ù„ Ø§Ø´ØªØ±Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ',
                        description: 'Ø¥Ø°Ø§ Ù„Ù… ÙŠØ´ØªØ±ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Ø¯',
                        config: { property: 'has_purchased', operator: 'equals', value: 'false' }
                    },
                    {
                        id: this.uid(),
                        type: 'whatsapp',
                        title: 'Ø¹Ø±Ø¶ Ø®Ø§Øµ Ù…Ø¹ Ø®ØµÙ… Ù¡Ù¥Ùª',
                        description: 'Ø±Ø³Ø§Ù„Ø© Ø«Ø§Ù†ÙŠØ© Ù…Ø¹ Ø¹Ø±Ø¶ Ø®Ø§Øµ Ù„ØªØ­ÙÙŠØ² Ø§Ù„Ø´Ø±Ø§Ø¡',
                        config: {
                            message: 'Ù„Ø³Ù‡ Ù…Ù‡ØªÙ… ÙŠØ§ {name}ØŸ ğŸ˜Š\n\nØ¹Ø´Ø§Ù†Ùƒ Ø¬Ù‡Ø²Ù†Ø§ Ù„Ùƒ Ø®ØµÙ… Ø®Ø§Øµ Ù¡Ù¥Ùª Ø¹Ù„Ù‰ Ø³Ù„ØªÙƒ!\n\nØ§Ù„Ù‚ÙŠÙ…Ø© Ù‚Ø¨Ù„: {cart_value}\nØ¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…: {discounted_value}\n\nØ§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙˆØ¯: RIBH15\n\nØ§Ù„Ø¹Ø±Ø¶ ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ Ù¢Ù¤ Ø³Ø§Ø¹Ø© â°\n{cart_link}',
                            template: 'cart_reminder_2_discount'
                        }
                    }
                ];
            },

            uid() {
                return 'step_' + Math.random().toString(36).substr(2, 9);
            },

            /* â”€â”€ Render Pipeline â”€â”€ */
            render() {
                const pipeline = document.getElementById('flowPipeline');
                if (!pipeline) return;

                let html = '';
                this.steps.forEach((step, idx) => {
                    // Step card
                    html += this.renderStepCard(step, idx);

                    // Connector + Add button (after every step)
                    html += this.renderConnector(idx);
                });

                pipeline.innerHTML = html;

                // Re-init lucide icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                // Re-apply selection
                if (this.selectedStepId) {
                    const card = pipeline.querySelector(`[data-step-id="${this.selectedStepId}"]`);
                    if (card) card.classList.add('selected');
                }
            },

            renderStepCard(step, idx) {
                const type = this.stepTypes[step.type];
                const isSelected = step.id === this.selectedStepId;

                let preview = '';
                if ((step.type === 'whatsapp' || step.type === 'email') && step.config.message) {
                    const previewText = step.config.message.split('\n')[0];
                    const truncated = previewText.length > 60 ? previewText.substring(0, 60) + '...' : previewText;
                    preview = `<div class="step-preview">${truncated}</div>`;
                }

                const canDelete = step.type !== 'trigger';

                return `
                    <div class="step-card ${isSelected ? 'selected' : ''}"
                         data-type="${step.type}"
                         data-step-id="${step.id}"
                         onclick="FlowBuilder.selectStep('${step.id}')"
                         style="animation-delay: ${idx * 60}ms">
                        <span class="step-number">${idx + 1}</span>
                        ${canDelete ? `<button class="step-delete" onclick="event.stopPropagation(); FlowBuilder.requestDelete('${step.id}')" title="Ø­Ø°Ù">
                            <i data-lucide="x"></i>
                        </button>` : ''}
                        <div class="step-card-header">
                            <div class="step-icon">
                                <i data-lucide="${type.icon}"></i>
                            </div>
                            <span class="step-type-label">${type.label}</span>
                        </div>
                        <div class="step-title">${step.title}</div>
                        <div class="step-desc">${step.description}</div>
                        ${preview}
                    </div>
                `;
            },

            renderConnector(idx) {
                return `
                    <div class="connector">
                        <div class="connector-line"></div>
                        <div class="connector-arrow">
                            <i data-lucide="chevron-down"></i>
                        </div>
                    </div>
                    <div class="add-step-wrapper" data-insert-idx="${idx}">
                        <button class="add-step-btn" onclick="event.stopPropagation(); FlowBuilder.toggleDropdown(${idx})" title="Ø¥Ø¶Ø§ÙØ© Ø®Ø·ÙˆØ©">
                            <i data-lucide="plus"></i>
                        </button>
                        <div class="add-dropdown" id="dropdown-${idx}">
                            <button class="add-dropdown-item" data-type="delay" onclick="event.stopPropagation(); FlowBuilder.addStep(${idx}, 'delay')">
                                <div class="add-dropdown-icon"><i data-lucide="clock"></i></div>
                                Ø§Ù†ØªØ¸Ø§Ø±
                            </button>
                            <button class="add-dropdown-item" data-type="whatsapp" onclick="event.stopPropagation(); FlowBuilder.addStep(${idx}, 'whatsapp')">
                                <div class="add-dropdown-icon"><i data-lucide="message-circle"></i></div>
                                Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨
                            </button>
                            <button class="add-dropdown-item" data-type="email" onclick="event.stopPropagation(); FlowBuilder.addStep(${idx}, 'email')">
                                <div class="add-dropdown-icon"><i data-lucide="mail"></i></div>
                                Ø±Ø³Ø§Ù„Ø© Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                            </button>
                            <button class="add-dropdown-item" data-type="condition" onclick="event.stopPropagation(); FlowBuilder.addStep(${idx}, 'condition')">
                                <div class="add-dropdown-icon"><i data-lucide="git-branch"></i></div>
                                Ø´Ø±Ø·
                            </button>
                            <button class="add-dropdown-item" data-type="action" onclick="event.stopPropagation(); FlowBuilder.addStep(${idx}, 'action')">
                                <div class="add-dropdown-icon"><i data-lucide="play"></i></div>
                                Ø¥Ø¬Ø±Ø§Ø¡
                            </button>
                        </div>
                    </div>
                    <div class="connector">
                        <div class="connector-line"></div>
                    </div>
                `;
            },

            /* â”€â”€ Dropdown â”€â”€ */
            toggleDropdown(idx) {
                const dropdown = document.getElementById('dropdown-' + idx);
                if (!dropdown) return;

                const wasOpen = dropdown.classList.contains('open');
                this.closeAllDropdowns();

                if (!wasOpen) {
                    dropdown.classList.add('open');
                    this.openDropdownIdx = idx;
                }
            },

            closeAllDropdowns() {
                document.querySelectorAll('.add-dropdown.open').forEach(d => d.classList.remove('open'));
                this.openDropdownIdx = null;
            },

            /* â”€â”€ Add Step â”€â”€ */
            addStep(afterIdx, type) {
                this.closeAllDropdowns();

                const defaults = {
                    delay: {
                        title: 'Ø§Ù†ØªØ¸Ø§Ø±',
                        description: 'ÙØªØ±Ø© Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©',
                        config: { duration: 1, unit: 'hours' }
                    },
                    whatsapp: {
                        title: 'Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯Ø©',
                        description: 'Ø£Ø¯Ø®Ù„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©',
                        config: { message: '', template: '' }
                    },
                    email: {
                        title: 'Ø±Ø³Ø§Ù„Ø© Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',
                        description: 'Ø£Ø¯Ø®Ù„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¨Ø±ÙŠØ¯',
                        config: { message: '', subject: '' }
                    },
                    condition: {
                        title: 'Ø´Ø±Ø· Ø¬Ø¯ÙŠØ¯',
                        description: 'Ø­Ø¯Ø¯ Ø´Ø±Ø· Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©',
                        config: { property: 'has_purchased', operator: 'equals', value: '' }
                    },
                    action: {
                        title: 'Ø¥Ø¬Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯',
                        description: 'Ø­Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨',
                        config: { actionType: 'tag', value: '' }
                    }
                };

                const def = defaults[type];
                const newStep = {
                    id: this.uid(),
                    type: type,
                    title: def.title,
                    description: def.description,
                    config: { ...def.config }
                };

                this.steps.splice(afterIdx + 1, 0, newStep);
                this.selectedStepId = newStep.id;
                this.render();
                this.showConfig(newStep.id);
                this.showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø·ÙˆØ© Ø¨Ù†Ø¬Ø§Ø­');
            },

            /* â”€â”€ Select Step â”€â”€ */
            selectStep(stepId) {
                this.selectedStepId = stepId;

                document.querySelectorAll('.step-card').forEach(c => c.classList.remove('selected'));
                const card = document.querySelector(`[data-step-id="${stepId}"]`);
                if (card) card.classList.add('selected');

                this.showConfig(stepId);
            },

            /* â”€â”€ Delete Step â”€â”€ */
            requestDelete(stepId) {
                this.deleteTargetId = stepId;
                document.getElementById('deleteModal').classList.add('open');
            },

            cancelDelete() {
                this.deleteTargetId = null;
                document.getElementById('deleteModal').classList.remove('open');
            },

            confirmDelete() {
                if (!this.deleteTargetId) return;
                const idx = this.steps.findIndex(s => s.id === this.deleteTargetId);
                if (idx === -1) return;

                this.steps.splice(idx, 1);

                if (this.selectedStepId === this.deleteTargetId) {
                    this.selectedStepId = null;
                    this.showEmptyConfig();
                }

                this.deleteTargetId = null;
                document.getElementById('deleteModal').classList.remove('open');
                this.render();
                this.showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø®Ø·ÙˆØ©');
            },

            /* â”€â”€ Config Panel â”€â”€ */
            showEmptyConfig() {
                const panel = document.getElementById('configContent');
                panel.innerHTML = `
                    <div class="config-empty">
                        <div class="config-empty-icon">
                            <i data-lucide="mouse-pointer-click"></i>
                        </div>
                        <div class="config-empty-title">Ø§Ø®ØªØ± Ø®Ø·ÙˆØ© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</div>
                        <div class="config-empty-desc">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø®Ø·ÙˆØ© ÙÙŠ Ø§Ù„ØªØ³Ù„Ø³Ù„ Ù„Ø¹Ø±Ø¶ Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙ‡Ø§ ÙˆØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù…Ù† Ù‡Ù†Ø§</div>
                    </div>
                `;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            },

            showConfig(stepId) {
                const step = this.steps.find(s => s.id === stepId);
                if (!step) return;

                const panel = document.getElementById('configContent');
                const type = this.stepTypes[step.type];

                let configBody = '';

                switch (step.type) {
                    case 'trigger':
                        configBody = this.configTrigger(step);
                        break;
                    case 'delay':
                        configBody = this.configDelay(step);
                        break;
                    case 'whatsapp':
                        configBody = this.configWhatsApp(step);
                        break;
                    case 'email':
                        configBody = this.configEmail(step);
                        break;
                    case 'condition':
                        configBody = this.configCondition(step);
                        break;
                    case 'action':
                        configBody = this.configAction(step);
                        break;
                }

                // Determine icon background/color classes
                const iconStyles = {
                    trigger: 'background: rgba(139, 92, 246, 0.15); color: #8B5CF6;',
                    delay: 'background: var(--bg-surface-2); color: var(--text-muted);',
                    whatsapp: 'background: var(--whatsapp-dim); color: var(--whatsapp);',
                    email: 'background: var(--info-dim); color: var(--info);',
                    condition: 'background: var(--warning-dim); color: var(--warning);',
                    action: 'background: var(--primary-dim); color: var(--primary);'
                };

                panel.innerHTML = `
                    <div class="config-header">
                        <div class="config-header-icon" style="${iconStyles[step.type]}">
                            <i data-lucide="${type.icon}"></i>
                        </div>
                        <div class="config-header-text">
                            <h3>${type.label}</h3>
                            <span>Ø§Ù„Ø®Ø·ÙˆØ© ${this.steps.indexOf(step) + 1} Ù…Ù† ${this.steps.length}</span>
                        </div>
                    </div>
                    ${configBody}
                `;

                if (typeof lucide !== 'undefined') lucide.createIcons();
            },

            /* â”€â”€ Config: Trigger â”€â”€ */
            configTrigger(step) {
                const options = this.triggerOptions.map(opt =>
                    `<option value="${opt.value}" ${step.config.triggerType === opt.value ? 'selected' : ''}>${opt.label}</option>`
                ).join('');

                return `
                    <div class="config-section">
                        <div class="config-section-title">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ÙØ²</div>
                        <div class="input-group">
                            <select class="select input" onchange="FlowBuilder.updateTrigger('${step.id}', this.value)">
                                ${options}
                            </select>
                        </div>
                    </div>
                    <div class="config-section">
                        <div class="config-section-title">Ø§Ù„ÙˆØµÙ</div>
                        <div class="input-group">
                            <input type="text" class="input" value="${step.description}"
                                   onchange="FlowBuilder.updateField('${step.id}', 'description', this.value)"
                                   placeholder="ÙˆØµÙ Ø§Ù„Ù…Ø­ÙØ²...">
                        </div>
                    </div>
                    <div class="config-section" style="padding: 14px; background: rgba(139,92,246,0.06); border-radius: var(--radius-sm); border: 1px solid rgba(139,92,246,0.12);">
                        <div style="font-size: 12px; color: #8B5CF6; font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                            <i data-lucide="info" style="width:14px;height:14px"></i>
                            ÙƒÙŠÙ ÙŠØ¹Ù…Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ÙØ²ØŸ
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted); line-height: 1.7;" id="triggerHelp">
                            ${this.getTriggerHelp(step.config.triggerType)}
                        </div>
                    </div>
                `;
            },

            getTriggerHelp(triggerType) {
                const helps = {
                    abandoned_cart: 'ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ù„Ø³Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ¶ÙŠÙ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø³Ù„Ø© Ø«Ù… ÙŠØºØ§Ø¯Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¯ÙˆÙ† Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡.',
                    new_order: 'ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ³Ù„Ø³Ù„ ÙÙˆØ± ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø±.',
                    new_customer: 'ÙŠØªÙØ¹Ù„ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø±.',
                    segment_entry: 'ÙŠØ¨Ø¯Ø£ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ†ØªÙ‚Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ù„Ù‰ Ø´Ø±ÙŠØ­Ø© Ù…Ø¹ÙŠÙ†Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø³Ù„ÙˆÙƒÙ‡.',
                    date_property: 'ÙŠØªÙØ¹Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ù…Ø­Ø¯Ø¯ Ù…Ø«Ù„ Ø¹ÙŠØ¯ Ù…ÙŠÙ„Ø§Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø°ÙƒØ±Ù‰ Ø£ÙˆÙ„ Ø·Ù„Ø¨.',
                    price_drop: 'ÙŠØªÙØ¹Ù„ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ†Ø®ÙØ¶ Ø³Ø¹Ø± Ù…Ù†ØªØ¬ ÙƒØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù‡ØªÙ…Ø§Ù‹ Ø¨Ù‡.'
                };
                return helps[triggerType] || '';
            },

            updateTrigger(stepId, value) {
                const step = this.steps.find(s => s.id === stepId);
                if (!step) return;
                step.config.triggerType = value;

                const triggerNames = {
                    abandoned_cart: 'Ø³Ù„Ø© Ù…ØªØ±ÙˆÙƒØ©',
                    new_order: 'Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯',
                    new_customer: 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯',
                    segment_entry: 'Ø¯Ø®ÙˆÙ„ Ø´Ø±ÙŠØ­Ø©',
                    date_property: 'ØªØ§Ø±ÙŠØ®',
                    price_drop: 'ØªØ®ÙÙŠØ¶ Ø³Ø¹Ø±'
                };
                step.title = triggerNames[value] || 'Ù…Ø­ÙØ²';

                const helpEl = document.getElementById('triggerHelp');
                if (helpEl) helpEl.textContent = this.getTriggerHelp(value);

                this.render();
            },

            /* â”€â”€ Config: Delay â”€â”€ */
            configDelay(step) {
                const units = [
                    { value: 'minutes', label: 'Ø¯Ù‚Ø§Ø¦Ù‚' },
                    { value: 'hours', label: 'Ø³Ø§Ø¹Ø§Øª' },
                    { value: 'days', label: 'Ø£ÙŠØ§Ù…' }
                ];
                const unitOptions = units.map(u =>
                    `<option value="${u.value}" ${step.config.unit === u.value ? 'selected' : ''}>${u.label}</option>`
                ).join('');

                return `
                    <div class="config-section">
                        <div class="config-section-title">Ù…Ø¯Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
                        <div class="config-row">
                            <div class="input-group">
                                <label class="input-label">Ø§Ù„Ù…Ø¯Ø©</label>
                                <input type="number" class="input" min="1" value="${step.config.duration}"
                                       onchange="FlowBuilder.updateDelay('${step.id}', this.value, null)">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                                <select class="select input"
                                        onchange="FlowBuilder.updateDelay('${step.id}', null, this.value)">
                                    ${unitOptions}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="config-section" style="padding: 14px; background: var(--bg-surface-2); border-radius: var(--radius-sm);">
                        <div style="font-size: 12px; color: var(--text-muted); line-height: 1.7; display: flex; align-items: flex-start; gap: 8px;">
                            <i data-lucide="lightbulb" style="width:16px;height:16px;color:var(--warning);flex-shrink:0;margin-top:2px"></i>
                            Ù†ØµÙŠØ­Ø©: Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø³Ù„Ø§ØªØŒ Ø£ÙØ¶Ù„ Ù…Ø¯Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠÙ† Ù£Ù  Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ø£ÙˆÙ„ Ø±Ø³Ø§Ù„Ø© ÙˆÙ¢-Ù¤ Ø³Ø§Ø¹Ø§Øª Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©.
                        </div>
                    </div>
                `;
            },

            updateDelay(stepId, duration, unit) {
                const step = this.steps.find(s => s.id === stepId);
                if (!step) return;

                if (duration !== null) step.config.duration = parseInt(duration) || 1;
                if (unit !== null) step.config.unit = unit;

                const unitLabels = { minutes: 'Ø¯Ù‚ÙŠÙ‚Ø©', hours: 'Ø³Ø§Ø¹Ø©', days: 'ÙŠÙˆÙ…' };
                const pluralLabels = { minutes: 'Ø¯Ù‚Ø§Ø¦Ù‚', hours: 'Ø³Ø§Ø¹Ø§Øª', days: 'Ø£ÙŠØ§Ù…' };
                const d = step.config.duration;
                const u = d > 2 ? (pluralLabels[step.config.unit] || '') : (d === 2 ? (step.config.unit === 'hours' ? 'Ø³Ø§Ø¹ØªÙŠÙ†' : (step.config.unit === 'minutes' ? 'Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†' : 'ÙŠÙˆÙ…ÙŠÙ†')) : (unitLabels[step.config.unit] || ''));

                if (d === 2) {
                    step.title = 'Ø§Ù†ØªØ¸Ø§Ø± ' + u;
                } else if (d === 1) {
                    step.title = 'Ø§Ù†ØªØ¸Ø§Ø± ' + u + ' ÙˆØ§Ø­Ø¯Ø©';
                } else {
                    step.title = 'Ø§Ù†ØªØ¸Ø§Ø± ' + d + ' ' + u;
                }

                step.description = 'ÙØªØ±Ø© Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©';
                this.render();
            },

            /* â”€â”€ Config: WhatsApp â”€â”€ */
            configWhatsApp(step) {
                const messageEscaped = (step.config.message || '').replace(/"/g, '&quot;').replace(/</g, '&lt;');

                return `
                    <div class="config-section">
                        <div class="config-section-title">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©</div>
                        <div class="input-group">
                            <input type="text" class="input" value="${step.title}"
                                   onchange="FlowBuilder.updateField('${step.id}', 'title', this.value); FlowBuilder.render();"
                                   placeholder="Ø¹Ù†ÙˆØ§Ù† ÙˆØµÙÙŠ Ù„Ù„Ø±Ø³Ø§Ù„Ø©...">
                        </div>
                    </div>
                    <div class="config-section">
                        <div class="config-section-title">Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</div>
                        <div class="input-group">
                            <textarea class="textarea" rows="6"
                                      id="msgTextarea-${step.id}"
                                      onchange="FlowBuilder.updateMessage('${step.id}', this.value)"
                                      oninput="FlowBuilder.updatePreview('${step.id}', this.value)"
                                      placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù‡Ù†Ø§...">${step.config.message || ''}</textarea>
                        </div>
                        <div class="config-section-title" style="margin-top:12px">Ø¥Ø¯Ø±Ø§Ø¬ Ù…ØªØºÙŠØ±</div>
                        <div class="variable-tags">
                            <button class="variable-tag" onclick="FlowBuilder.insertVariable('${step.id}', '{name}')">
                                {name} Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„
                            </button>
                            <button class="variable-tag" onclick="FlowBuilder.insertVariable('${step.id}', '{cart_value}')">
                                {cart_value} Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ù„Ø©
                            </button>
                            <button class="variable-tag" onclick="FlowBuilder.insertVariable('${step.id}', '{product_name}')">
                                {product_name} Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬
                            </button>
                            <button class="variable-tag" onclick="FlowBuilder.insertVariable('${step.id}', '{store_name}')">
                                {store_name} Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±
                            </button>
                            <button class="variable-tag" onclick="FlowBuilder.insertVariable('${step.id}', '{cart_link}')">
                                {cart_link} Ø±Ø§Ø¨Ø· Ø§Ù„Ø³Ù„Ø©
                            </button>
                            <button class="variable-tag" onclick="FlowBuilder.insertVariable('${step.id}', '{discounted_value}')">
                                {discounted_value} Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…
                            </button>
                        </div>
                    </div>
                    <div class="config-section">
                        <div class="config-section-title">Ù…Ø¹Ø§ÙŠÙ†Ø©</div>
                        <div class="message-preview">
                            <div class="message-preview-text" id="msgPreview-${step.id}">${this.formatPreview(step.config.message || 'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ù…Ø¹Ø§ÙŠÙ†ØªÙ‡Ø§ Ù‡Ù†Ø§...')}</div>
                            <div class="message-preview-time">Ù¡Ù¢:Ù£Ù¤ Ù… âœ“âœ“</div>
                        </div>
                    </div>
                `;
            },

            formatPreview(text) {
                return text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/\{(\w+)\}/g, '<span style="color: var(--primary); font-weight: 600;">{$1}</span>')
                    .replace(/\n/g, '<br>');
            },

            updateMessage(stepId, value) {
                const step = this.steps.find(s => s.id === stepId);
                if (!step) return;
                step.config.message = value;
                this.render();
            },

            updatePreview(stepId, value) {
                const preview = document.getElementById('msgPreview-' + stepId);
                if (preview) {
                    preview.innerHTML = this.formatPreview(value || 'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ù…Ø¹Ø§ÙŠÙ†ØªÙ‡Ø§ Ù‡Ù†Ø§...');
                }
            },

            insertVariable(stepId, variable) {
                const textarea = document.getElementById('msgTextarea-' + stepId);
                if (!textarea) return;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                textarea.value = text.substring(0, start) + variable + text.substring(end);
                textarea.focus();
                textarea.selectionStart = textarea.selectionEnd = start + variable.length;
                this.updatePreview(stepId, textarea.value);

                const step = this.steps.find(s => s.id === stepId);
                if (step) step.config.message = textarea.value;
            },

            /* â”€â”€ Config: Email â”€â”€ */
            configEmail(step) {
                return `
                    <div class="config-section">
                        <div class="config-section-title">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©</div>
                        <div class="input-group">
                            <input type="text" class="input" value="${step.title}"
                                   onchange="FlowBuilder.updateField('${step.id}', 'title', this.value); FlowBuilder.render();"
                                   placeholder="Ø¹Ù†ÙˆØ§Ù† ÙˆØµÙÙŠ...">
                        </div>
                    </div>
                    <div class="config-section">
                        <div class="config-section-title">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ (Subject)</div>
                        <div class="input-group">
                            <input type="text" class="input" value="${step.config.subject || ''}"
                                   onchange="FlowBuilder.updateEmailField('${step.id}', 'subject', this.value)"
                                   placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ...">
                        </div>
                    </div>
                    <div class="config-section">
                        <div class="config-section-title">Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¨Ø±ÙŠØ¯</div>
                        <div class="input-group">
                            <textarea class="textarea" rows="6"
                                      onchange="FlowBuilder.updateEmailField('${step.id}', 'message', this.value)"
                                      placeholder="Ø§ÙƒØªØ¨ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù‡Ù†Ø§...">${step.config.message || ''}</textarea>
                        </div>
                        <div class="variable-tags" style="margin-top:8px">
                            <button class="variable-tag" onclick="FlowBuilder.insertVariable('${step.id}', '{name}')">
                                {name} Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„
                            </button>
                            <button class="variable-tag" onclick="FlowBuilder.insertVariable('${step.id}', '{cart_value}')">
                                {cart_value} Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ù„Ø©
                            </button>
                            <button class="variable-tag" onclick="FlowBuilder.insertVariable('${step.id}', '{product_name}')">
                                {product_name} Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬
                            </button>
                        </div>
                    </div>
                `;
            },

            updateEmailField(stepId, field, value) {
                const step = this.steps.find(s => s.id === stepId);
                if (!step) return;
                step.config[field] = value;
                if (field === 'message') this.render();
            },

            /* â”€â”€ Config: Condition â”€â”€ */
            configCondition(step) {
                const properties = [
                    { value: 'has_purchased', label: 'Ù‡Ù„ Ø§Ø´ØªØ±Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„' },
                    { value: 'cart_value', label: 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ù„Ø©' },
                    { value: 'order_count', label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª' },
                    { value: 'segment', label: 'Ø§Ù„Ø´Ø±ÙŠØ­Ø©' },
                    { value: 'last_activity', label: 'Ø¢Ø®Ø± Ù†Ø´Ø§Ø·' },
                    { value: 'opened_message', label: 'ÙØªØ­ Ø§Ù„Ø±Ø³Ø§Ù„Ø©' },
                    { value: 'clicked_link', label: 'Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø·' }
                ];
                const operators = [
                    { value: 'equals', label: 'ÙŠØ³Ø§ÙˆÙŠ' },
                    { value: 'not_equals', label: 'Ù„Ø§ ÙŠØ³Ø§ÙˆÙŠ' },
                    { value: 'greater_than', label: 'Ø£ÙƒØ¨Ø± Ù…Ù†' },
                    { value: 'less_than', label: 'Ø£ØµØºØ± Ù…Ù†' },
                    { value: 'contains', label: 'ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰' }
                ];

                const propOptions = properties.map(p =>
                    `<option value="${p.value}" ${step.config.property === p.value ? 'selected' : ''}>${p.label}</option>`
                ).join('');
                const opOptions = operators.map(o =>
                    `<option value="${o.value}" ${step.config.operator === o.value ? 'selected' : ''}>${o.label}</option>`
                ).join('');

                return `
                    <div class="config-section">
                        <div class="config-section-title">Ø§Ø³Ù… Ø§Ù„Ø´Ø±Ø·</div>
                        <div class="input-group">
                            <input type="text" class="input" value="${step.title}"
                                   onchange="FlowBuilder.updateField('${step.id}', 'title', this.value); FlowBuilder.render();"
                                   placeholder="ÙˆØµÙ Ø§Ù„Ø´Ø±Ø·...">
                        </div>
                    </div>
                    <div class="config-section">
                        <div class="config-section-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±Ø·</div>
                        <div class="input-group">
                            <label class="input-label">Ø§Ù„Ø®Ø§ØµÙŠØ©</label>
                            <select class="select input" onchange="FlowBuilder.updateConditionField('${step.id}', 'property', this.value)">
                                ${propOptions}
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
                            <select class="select input" onchange="FlowBuilder.updateConditionField('${step.id}', 'operator', this.value)">
                                ${opOptions}
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Ø§Ù„Ù‚ÙŠÙ…Ø©</label>
                            <input type="text" class="input" value="${step.config.value || ''}"
                                   onchange="FlowBuilder.updateConditionField('${step.id}', 'value', this.value)"
                                   placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©...">
                        </div>
                    </div>
                    <div class="config-section" style="padding: 14px; background: var(--warning-dim); border-radius: var(--radius-sm); border: 1px solid rgba(245,158,11,0.15);">
                        <div style="font-size: 12px; color: var(--warning); font-weight: 600; margin-bottom: 4px;">Ù…Ù„Ø§Ø­Ø¸Ø©</div>
                        <div style="font-size: 12px; color: var(--text-muted); line-height: 1.7;">
                            Ø¥Ø°Ø§ ØªØ­Ù‚Ù‚ Ø§Ù„Ø´Ø±Ø·ØŒ Ø³ÙŠØ³ØªÙ…Ø± Ø§Ù„ØªØ³Ù„Ø³Ù„ Ù„Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©. ÙˆØ¥Ù„Ø§ Ø³ÙŠØªÙˆÙ‚Ù Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø¹Ù†Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ù‚Ø·Ø©.
                        </div>
                    </div>
                `;
            },

            updateConditionField(stepId, field, value) {
                const step = this.steps.find(s => s.id === stepId);
                if (!step) return;
                step.config[field] = value;
            },

            /* â”€â”€ Config: Action â”€â”€ */
            configAction(step) {
                const actions = [
                    { value: 'tag', label: 'Ø¥Ø¶Ø§ÙØ© ÙˆØ³Ù… Ù„Ù„Ø¹Ù…ÙŠÙ„' },
                    { value: 'remove_tag', label: 'Ø¥Ø²Ø§Ù„Ø© ÙˆØ³Ù…' },
                    { value: 'update_segment', label: 'Ù†Ù‚Ù„ Ù„Ø´Ø±ÙŠØ­Ø©' },
                    { value: 'update_property', label: 'ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„' },
                    { value: 'webhook', label: 'Ø¥Ø±Ø³Ø§Ù„ Webhook' },
                    { value: 'notify_team', label: 'Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ÙØ±ÙŠÙ‚' }
                ];
                const actionOptions = actions.map(a =>
                    `<option value="${a.value}" ${step.config.actionType === a.value ? 'selected' : ''}>${a.label}</option>`
                ).join('');

                return `
                    <div class="config-section">
                        <div class="config-section-title">Ø§Ø³Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</div>
                        <div class="input-group">
                            <input type="text" class="input" value="${step.title}"
                                   onchange="FlowBuilder.updateField('${step.id}', 'title', this.value); FlowBuilder.render();"
                                   placeholder="ÙˆØµÙ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡...">
                        </div>
                    </div>
                    <div class="config-section">
                        <div class="config-section-title">Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</div>
                        <div class="input-group">
                            <select class="select input" onchange="FlowBuilder.updateActionField('${step.id}', 'actionType', this.value)">
                                ${actionOptions}
                            </select>
                        </div>
                    </div>
                    <div class="config-section">
                        <div class="config-section-title">Ø§Ù„Ù‚ÙŠÙ…Ø©</div>
                        <div class="input-group">
                            <input type="text" class="input" value="${step.config.value || ''}"
                                   onchange="FlowBuilder.updateActionField('${step.id}', 'value', this.value)"
                                   placeholder="Ù…Ø«Ø§Ù„: VIPØŒ Ø¹Ù…ÙŠÙ„ Ù…Ù‡ØªÙ…...">
                        </div>
                    </div>
                `;
            },

            updateActionField(stepId, field, value) {
                const step = this.steps.find(s => s.id === stepId);
                if (!step) return;
                step.config[field] = value;
            },

            /* â”€â”€ Generic Field Update â”€â”€ */
            updateField(stepId, field, value) {
                const step = this.steps.find(s => s.id === stepId);
                if (!step) return;
                step[field] = value;
            },

            /* â”€â”€ Save & Activate â”€â”€ */
            save() {
                this.showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø¨Ù†Ø¬Ø§Ø­');
            },

            toggleActivation() {
                this.isActive = !this.isActive;
                const badge = document.getElementById('statusBadge');
                const text = document.getElementById('statusText');
                const btnText = document.getElementById('activateBtnText');

                if (this.isActive) {
                    badge.className = 'status-badge active';
                    text.textContent = 'Ù†Ø´Ø·';
                    btnText.textContent = 'Ø¥ÙŠÙ‚Ø§Ù';
                    this.showToast('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    badge.className = 'status-badge draft';
                    text.textContent = 'Ù…Ø³ÙˆØ¯Ø©';
                    btnText.textContent = 'ØªÙØ¹ÙŠÙ„';
                    this.showToast('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ù„Ø³Ù„');
                }
            },

            /* â”€â”€ Toast â”€â”€ */
            showToast(message) {
                const toast = document.getElementById('toast');
                const toastText = document.getElementById('toastText');
                if (!toast || !toastText) return;

                toastText.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2500);
            }
        };

        // Initialize
        FlowBuilder.init();
    </script>
</body>
</html>
