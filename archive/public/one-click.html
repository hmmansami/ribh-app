<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø±ÙØ¨Ø­ | Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø© â†’ Ø§Ù„Ù…Ø§Ù„ ÙŠØªØ¯ÙÙ‚</title>
    <meta name="description" content="Ø§Ø³ØªØ±Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø© = Ø§Ù„Ù…Ø§Ù„ ÙŠØªØ¯ÙÙ‚. Ù…Ø¶Ù…ÙˆÙ†.">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #000000;
            --card: rgba(18, 18, 18, 0.95);
            --card-border: rgba(255, 255, 255, 0.08);
            --text: #FFFFFF;
            --text-secondary: #A1A1AA;
            --primary: #10B981;
            --primary-glow: rgba(16, 185, 129, 0.5);
            --success: #22C55E;
            --warning: #F59E0B;
        }

        body {
            font-family: 'IBM Plex Sans Arabic', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        .bg-effects {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 0;
        }

        .bg-effects::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background:
                radial-gradient(ellipse 800px 800px at 20% 30%, rgba(16, 185, 129, 0.12), transparent 50%),
                radial-gradient(ellipse 600px 600px at 80% 70%, rgba(16, 185, 129, 0.08), transparent 50%);
            animation: bgFloat 20s ease-in-out infinite;
        }

        @keyframes bgFloat {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
            }

            50% {
                transform: translate(30px, 20px) rotate(3deg);
            }
        }

        /* Container */
        .container {
            position: relative;
            z-index: 1;
            max-width: 600px;
            margin: 0 auto;
            padding: 40px 24px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            font-size: 48px;
            font-weight: 800;
            background: linear-gradient(135deg, #10B981, #34D399);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .tagline {
            font-size: 18px;
            color: var(--text-secondary);
        }

        /* Hero */
        .hero {
            text-align: center;
            margin-bottom: 48px;
        }

        .hero h1 {
            font-size: 36px;
            font-weight: 800;
            line-height: 1.3;
            margin-bottom: 16px;
        }

        .hero h1 span {
            color: var(--primary);
        }

        .hero p {
            font-size: 20px;
            color: var(--text-secondary);
            max-width: 500px;
            margin: 0 auto;
        }

        /* Steps */
        .steps {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 40px;
        }

        .step {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 28px;
            transition: all 0.3s ease;
        }

        .step.active {
            border-color: var(--primary);
            box-shadow: 0 0 40px rgba(16, 185, 129, 0.15);
        }

        .step.completed {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.05);
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .step-number {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .step.completed .step-number {
            background: var(--success);
            border-color: var(--success);
        }

        .step-info h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .step-info p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Buttons */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 18px 24px;
            border-radius: 14px;
            font-size: 18px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(16, 185, 129, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        /* QR Container */
        .qr-container {
            text-align: center;
            padding: 24px;
            background: white;
            border-radius: 16px;
            margin-top: 16px;
        }

        .qr-container img {
            max-width: 250px;
            width: 100%;
            height: auto;
        }

        .qr-instructions {
            margin-top: 16px;
            font-size: 14px;
            color: #333;
            text-align: center;
        }

        .qr-instructions ol {
            list-style-position: inside;
            text-align: right;
        }

        .qr-instructions li {
            margin: 8px 0;
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-badge.success {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .status-badge.waiting {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.success {
            background: var(--success);
        }

        .status-dot.waiting {
            background: var(--warning);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Done Section */
        .done-section {
            display: none;
            text-align: center;
            padding: 48px 24px;
        }

        .done-section.visible {
            display: block;
        }

        .done-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 24px;
            background: linear-gradient(135deg, #10B981, #34D399);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            animation: celebrate 0.5s ease-out;
        }

        @keyframes celebrate {
            0% {
                transform: scale(0);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .done-section h2 {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 12px;
        }

        .done-section p {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        /* Guarantee */
        .guarantee {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            margin-top: auto;
        }

        .guarantee h4 {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .guarantee p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Hidden elements */
        .hidden {
            display: none !important;
        }

        /* Connected Info */
        .connected-info {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 12px;
            margin-top: 16px;
        }

        .connected-avatar {
            width: 48px;
            height: 48px;
            background: var(--success);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .connected-details h4 {
            font-size: 16px;
            font-weight: 600;
            color: var(--success);
        }

        .connected-details p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* API Link */
        .api-link {
            margin-top: 24px;
            text-align: center;
        }

        .api-link a {
            color: var(--text-secondary);
            font-size: 13px;
            text-decoration: underline;
        }

        .api-link a:hover {
            color: var(--primary);
        }
    </style>
</head>

<body>
    <div class="bg-effects"></div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">ğŸ’š Ø±ÙØ¨Ø­</div>
            <p class="tagline">Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø© â†’ Ø§Ù„Ù…Ø§Ù„ ÙŠØªØ¯ÙÙ‚</p>
        </header>

        <!-- Hero -->
        <section class="hero">
            <h1>Ø§Ø³ØªØ±Ø¯ <span>30%</span> Ù…Ù† Ù…Ø¨ÙŠØ¹Ø§ØªÙƒ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©</h1>
            <p>Ø§Ø±Ø¨Ø· Ù…ØªØ¬Ø±Ùƒ. Ù…Ø³Ø­ QR. Ø§Ù†ØªÙ‡Ù‰. Ù†Ø­Ù† Ù†ØªÙˆÙ„Ù‰ Ø§Ù„Ø¨Ø§Ù‚ÙŠ.</p>
        </section>

        <!-- Steps -->
        <div class="steps" id="stepsContainer">

            <!-- Step 1: Connect Store -->
            <div class="step active" id="step1">
                <div class="step-header">
                    <div class="step-number" id="step1Number">1</div>
                    <div class="step-info">
                        <h3>Ø§Ø±Ø¨Ø· Ù…ØªØ¬Ø± Ø³Ù„Ø©</h3>
                        <p>Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ø±Ø¨Ø· Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</p>
                    </div>
                </div>
                <button class="btn btn-primary" id="connectSallaBtn" onclick="connectSalla()">
                    <span>ğŸ”—</span>
                    <span>Ø±Ø¨Ø· Ù…ØªØ¬Ø±ÙŠ Ø§Ù„Ø¢Ù†</span>
                </button>

                <!-- Already connected state -->
                <div class="connected-info hidden" id="sallaConnected">
                    <div class="connected-avatar">ğŸª</div>
                    <div class="connected-details">
                        <h4 id="storeName">Ù…ØªØ¬Ø±Ùƒ</h4>
                        <p>Ù…ØªØµÙ„ ÙˆÙ…ÙØ¹Ù‘Ù„ âœ“</p>
                    </div>
                </div>
            </div>

            <!-- Step 2: Connect WhatsApp -->
            <div class="step" id="step2">
                <div class="step-header">
                    <div class="step-number" id="step2Number">2</div>
                    <div class="step-info">
                        <h3>Ø§Ø±Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨</h3>
                        <p>Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¬Ø±</p>
                    </div>
                </div>

                <button class="btn btn-primary" id="connectWhatsAppBtn" onclick="connectWhatsApp()" disabled>
                    <span>ğŸ“±</span>
                    <span>ØªÙØ¹ÙŠÙ„ ÙˆØ§ØªØ³Ø§Ø¨</span>
                </button>

                <!-- QR Code Container -->
                <div class="qr-container hidden" id="qrContainer">
                    <img id="qrImage" src="" alt="WhatsApp QR Code">
                    <div class="qr-instructions">
                        <p style="font-weight: 600; margin-bottom: 12px;">Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ Ø¨ÙˆØ§ØªØ³Ø§Ø¨:</p>
                        <ol>
                            <li>Ø§ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù„Ù‰ Ø¬ÙˆØ§Ù„Ùƒ</li>
                            <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø· â† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©</li>
                            <li>Ø§Ù…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯</li>
                        </ol>
                    </div>
                </div>

                <!-- Status -->
                <div class="hidden" id="whatsappStatus" style="text-align: center; margin-top: 16px;">
                    <div class="status-badge waiting">
                        <span class="status-dot waiting"></span>
                        <span id="statusText">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø³Ø­...</span>
                    </div>
                </div>

                <!-- WhatsApp connected state -->
                <div class="connected-info hidden" id="whatsappConnected">
                    <div class="connected-avatar">ğŸ“±</div>
                    <div class="connected-details">
                        <h4 id="whatsappName">ÙˆØ§ØªØ³Ø§Ø¨</h4>
                        <p id="whatsappPhone">Ù…ØªØµÙ„ âœ“</p>
                    </div>
                </div>

                <!-- API option -->
                <div class="api-link" id="apiOption">
                    <a
                        href="mailto:support@ribh.click?subject=Ø·Ù„Ø¨ Ø±Ø¨Ø· WhatsApp API&body=Ø£Ø±ØºØ¨ Ø¨Ø±Ø¨Ø· WhatsApp Business API Ù„Ù…ØªØ¬Ø±ÙŠ">
                        ØªÙØ¶Ù‘Ù„ API Ø±Ø³Ù…ÙŠØŸ ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§
                    </a>
                </div>
            </div>
        </div>

        <!-- Done Section -->
        <div class="done-section" id="doneSection">
            <div class="done-icon">âœ“</div>
            <h2>Ù…Ø¨Ø±ÙˆÙƒ! ğŸ‰</h2>
            <p>Ù…ØªØ¬Ø±Ùƒ Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
            <a href="/index.html" class="btn btn-primary">
                <span>ğŸ“Š</span>
                <span>Ø§Ù†ØªÙ‚Ù„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
            </a>
        </div>

        <!-- Guarantee -->
        <div class="guarantee" id="guarantee">
            <h4>ğŸ›¡ï¸ Ø¶Ù…Ø§Ù† 100%</h4>
            <p>Ø¥Ø°Ø§ Ù„Ù… Ù†Ø²ÙŠØ¯ Ù…Ø¨ÙŠØ¹Ø§ØªÙƒ 15%ØŒ Ù„Ø§ ØªØ¯ÙØ¹ Ø´ÙŠØ¡.</p>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:5001/ribh-8a479/us-central1/api'
            : '/api';

        // State
        let merchantId = null;
        let pollInterval = null;

        // Check if already connected (from URL params or cookies)
        function checkExistingConnection() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            const merchant = params.get('merchant');

            if (token || merchant) {
                merchantId = merchant || token;
                // Verify with backend
                verifyConnection(merchantId);
            }

            // Check cookie
            const cookies = document.cookie.split(';').reduce((acc, c) => {
                const [key, val] = c.trim().split('=');
                acc[key] = val;
                return acc;
            }, {});

            if (cookies.ribhToken) {
                merchantId = cookies.ribhToken;
                verifyConnection(merchantId);
            }
        }

        async function verifyConnection(token) {
            try {
                const res = await fetch(`${API_BASE}/auth/verify?token=${token}`);
                const data = await res.json();

                if (data.success && data.store) {
                    merchantId = data.store.merchant;
                    showSallaConnected(data.store.merchantName || 'Ù…ØªØ¬Ø±Ùƒ');
                    checkWhatsAppStatus();
                }
            } catch (e) {
                console.error('Verify error:', e);
            }
        }

        // Step 1: Connect Salla
        function connectSalla() {
            // Redirect to Salla OAuth
            const sallaOAuthUrl = 'https://accounts.salla.sa/oauth2/auth?' + new URLSearchParams({
                client_id: '476e7ed1-796c-4731-b145-73a13d0019de',
                response_type: 'code',
                scope: 'offline_access orders.read customers.read settings.read',
                redirect_uri: window.location.origin + '/api/salla/callback',
                state: 'ribh_connect'
            });

            window.location.href = sallaOAuthUrl;
        }

        function showSallaConnected(storeName) {
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1Number').textContent = 'âœ“';
            document.getElementById('connectSallaBtn').classList.add('hidden');
            document.getElementById('sallaConnected').classList.remove('hidden');
            document.getElementById('storeName').textContent = storeName;

            // Enable step 2
            document.getElementById('step2').classList.add('active');
            document.getElementById('connectWhatsAppBtn').disabled = false;
        }

        // Step 2: Connect WhatsApp
        async function connectWhatsApp() {
            if (!merchantId) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±Ø¨Ø· Ù…ØªØ¬Ø± Ø³Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            const btn = document.getElementById('connectWhatsAppBtn');
            btn.innerHTML = '<span class="spinner"></span><span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>';
            btn.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/whatsapp/init`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ merchantId })
                });

                const data = await res.json();

                if (data.ready) {
                    // Already connected
                    showWhatsAppConnected(data.name || 'ÙˆØ§ØªØ³Ø§Ø¨', data.phone || '');
                } else if (data.qrCode) {
                    // Show QR code
                    showQRCode(data.qrCode);
                    startPolling();
                } else {
                    throw new Error(data.error || 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„');
                }
            } catch (e) {
                console.error('WhatsApp init error:', e);
                btn.innerHTML = '<span>ğŸ“±</span><span>ØªÙØ¹ÙŠÙ„ ÙˆØ§ØªØ³Ø§Ø¨</span>';
                btn.disabled = false;
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            }
        }

        function showQRCode(qrDataUrl) {
            document.getElementById('connectWhatsAppBtn').classList.add('hidden');
            document.getElementById('qrContainer').classList.remove('hidden');
            document.getElementById('qrImage').src = qrDataUrl;
            document.getElementById('whatsappStatus').classList.remove('hidden');
        }

        function startPolling() {
            // Poll every 3 seconds for connection status
            pollInterval = setInterval(checkWhatsAppStatus, 3000);
        }

        async function checkWhatsAppStatus() {
            if (!merchantId) return;

            try {
                const res = await fetch(`${API_BASE}/whatsapp/status/${merchantId}`);
                const data = await res.json();

                if (data.connected) {
                    if (pollInterval) clearInterval(pollInterval);
                    showWhatsAppConnected(data.info?.name || 'ÙˆØ§ØªØ³Ø§Ø¨', data.info?.phone || '');
                } else if (data.hasPendingQR && !document.getElementById('qrContainer').classList.contains('hidden')) {
                    // Still waiting for scan
                    document.getElementById('statusText').textContent = 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø³Ø­...';
                }
            } catch (e) {
                console.error('Status check error:', e);
            }
        }

        function showWhatsAppConnected(name, phone) {
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2Number').textContent = 'âœ“';
            document.getElementById('qrContainer').classList.add('hidden');
            document.getElementById('whatsappStatus').classList.add('hidden');
            document.getElementById('connectWhatsAppBtn').classList.add('hidden');
            document.getElementById('whatsappConnected').classList.remove('hidden');
            document.getElementById('whatsappName').textContent = name;
            document.getElementById('whatsappPhone').textContent = phone ? `+${phone}` : 'Ù…ØªØµÙ„ âœ“';
            document.getElementById('apiOption').classList.add('hidden');

            // Show done section
            setTimeout(() => {
                document.getElementById('stepsContainer').style.opacity = '0.5';
                document.getElementById('doneSection').classList.add('visible');
                document.getElementById('guarantee').classList.add('hidden');
            }, 500);
        }

        // Initialize
        checkExistingConnection();
    </script>
</body>

</html>